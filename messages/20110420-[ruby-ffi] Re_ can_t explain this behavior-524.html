<html>
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>[ruby-ffi] Re: can&#39;t explain this behavior</title>
<link rel="important stylesheet" href="">
<style>div.headerdisplayname {font-weight:bold;}</style></head>
<body>
<table border=0 cellspacing=0 cellpadding=0 width="100%" class="header-part1"><tr><td><div class="headerdisplayname" style="display:inline;">Subject: </div>[ruby-ffi] Re: can&#39;t explain this behavior</td></tr><tr><td><div class="headerdisplayname" style="display:inline;">From: </div>Wayne Meissner <wmeissner@gmail.com></td></tr><tr><td><div class="headerdisplayname" style="display:inline;">Date: </div>4/20/11 8:25 PM</td></tr></table><table border=0 cellspacing=0 cellpadding=0 width="100%" class="header-part2"><tr><td><div class="headerdisplayname" style="display:inline;">To: </div>ruby-ffi@googlegroups.com</td></tr></table><br>
<div class="moz-text-html"  lang="x-unicode"><br><div>I suspect the problem is this:</div><div><span class="Apple-style-span" style="color: rgb(34, 34, 34); ">&nbsp;&nbsp;- pointer to result size (int)&nbsp;</span><br></div><div><span class="Apple-style-span" style="color: rgb(34, 34, 34); "><br></span></div><div><font class="Apple-style-span" color="#222222"><br></font></div><div><span class="Apple-style-span" style="color: rgb(34, 34, 34); "><br></span></div><div><span class="Apple-style-span" style="color: rgb(34, 34, 34); ">You should allocate it thusly:</span></div><div><span class="Apple-style-span" style="color: rgb(34, 34, 34); "><br></span></div><div><span class="Apple-style-span" style="font-family: monospace; font-size: 12px; line-height: 19px; "><font class="Apple-style-span" color="#181818">&nbsp;&nbsp; &nbsp;a3 =&nbsp;</font><span class="re2" style="color: rgb(102, 102, 255); font-weight: bold; ">FFI::MemoryPointer</span><font class="Apple-style-span" color="#181818">.</font><span class="me1" style="color: rgb(153, 0, 204); ">new</span><span class="br0" style="color: rgb(0, 102, 0); font-weight: bold; ">(</span><span class="br0" style="font-weight: bold; "><font class="Apple-style-span" color="#006666">:int</font></span><font class="Apple-style-span" color="#181818">,&nbsp;</font><span class="nu0" style="color: rgb(0, 102, 102); ">1</span><font class="Apple-style-span" color="#181818">,&nbsp;</font><span class="kw2" style="color: rgb(0, 0, 255); font-weight: bold; ">false</span><span class="br0" style="color: rgb(0, 102, 0); font-weight: bold; ">)</span></span><br></div><div><span class="Apple-style-span" style="font-family: monospace; font-size: 12px; line-height: 19px; "><span class="br0" style="color: rgb(0, 102, 0); font-weight: bold; ">&nbsp;&nbsp; &nbsp;a3.write_int(a2.size)</span></span></div><div><span class="Apple-style-span" style="font-family: monospace; font-size: 12px; line-height: 19px; "><span class="br0" style="color: rgb(0, 102, 0); font-weight: bold; "><br></span></span></div><div><span class="Apple-style-span" style="font-family: monospace; font-size: 12px; line-height: 19px; "><span class="br0" style="color: rgb(0, 102, 0); font-weight: bold; ">If that C function is doing a conversion from an input string to an output string, the 'result size' probably needs to be initialized to the maximum size of the output string, and after the function is called, it will contain the actual number of bytes used in the output buffer. &nbsp;Thats a pretty common idiom, and one of the most common things people get wrong.</span></span></div><div><span class="Apple-style-span" style="font-family: monospace; font-size: 12px; line-height: 19px; "><span class="br0" style="color: rgb(0, 102, 0); font-weight: bold; "><br></span></span></div><div><font class="Apple-style-span" color="#006600" face="monospace"><span class="Apple-style-span" style="font-size: 12px; line-height: 19px;"><b>The reason why it sometimes worked, and sometimes did not was because the 'output size' was full of random garbage, since you were not initializing the a3 memory, so occasionally it would contain a positive integer value.</b></span></font></div><div><font class="Apple-style-span" color="#006600" face="monospace"><span class="Apple-style-span" style="font-size: 12px; line-height: 19px;"><b><br></b></span></font></div><div><font class="Apple-style-span" color="#006600" face="monospace"><span class="Apple-style-span" style="font-size: 12px; line-height: 19px;"><b><br></b></span></font></div>
</div></body>
</html>
</table></div>