Delivered-To: headius@headius.com
Received: by 10.142.52.18 with SMTP id z18cs218856wfz;
        Sat, 28 Nov 2009 12:03:29 -0800 (PST)
Received: by 10.224.102.84 with SMTP id f20mr1225475qao.224.1259438608020;
        Sat, 28 Nov 2009 12:03:28 -0800 (PST)
Return-Path: <3DYIRSwoJCOsWba.SbehZfTZNVY.PbZehOl-SSVTbbTYRTebhcf.PbZ@listserv.bounces.google.com>
Received: from mail-vw0-f143.google.com (mail-vw0-f143.google.com [209.85.212.143])
        by mx.google.com with ESMTP id 12si3732808qyk.47.2009.11.28.12.03.26;
        Sat, 28 Nov 2009 12:03:27 -0800 (PST)
Received-SPF: pass (google.com: domain of 3DYIRSwoJCOsWba.SbehZfTZNVY.PbZehOl-SSVTbbTYRTebhcf.PbZ@listserv.bounces.google.com designates 209.85.212.143 as permitted sender) client-ip=209.85.212.143;
Authentication-Results: mx.google.com; spf=pass (google.com: domain of 3DYIRSwoJCOsWba.SbehZfTZNVY.PbZehOl-SSVTbbTYRTebhcf.PbZ@listserv.bounces.google.com designates 209.85.212.143 as permitted sender) smtp.mail=3DYIRSwoJCOsWba.SbehZfTZNVY.PbZehOl-SSVTbbTYRTebhcf.PbZ@listserv.bounces.google.com; dkim=pass (test mode) header.i=@gmail.com
Received: by vws7 with SMTP id 7sf1024888vws.22
        for <headius@headius.com>; Sat, 28 Nov 2009 12:03:26 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=gamma;
        h=domainkey-signature:received:x-beenthere:received:received:received
         :received:received-spf:received:received:received:date:from:to
         :subject:message-id:in-reply-to:references:x-mailer:mime-version
         :x-original-authentication-results:reply-to:precedence:mailing-list
         :list-id:list-post:list-help:list-archive:x-thread-url:x-message-url
         :list-unsubscribe:list-subscribe:content-type
         :content-transfer-encoding;
        bh=l09rW/b4woyKY9Bkr4lm63LF603uRWhz4uB314B4/fw=;
        b=QtolAtNaqrpNoYPG+ID73U0ZfJC27xh5Sj3e9jxyket0n8Qi5QFiwtqyvya4XznRm7
         0TBjBB2tz93amCc8AS98BDapRbnFBYf+1xhM4AcCXe2SO2LvpQj8jWCU5PTiaMtwh3Th
         Sj/coHNEkDcftojtpMPz6mLDZgIwBe9uazptc=
DomainKey-Signature: a=rsa-sha1; c=nofws;
        d=gmail.com; s=gamma;
        h=x-beenthere:received-spf:date:from:to:subject:message-id
         :in-reply-to:references:x-mailer:mime-version
         :x-original-authentication-results:reply-to:precedence:mailing-list
         :list-id:list-post:list-help:list-archive:x-thread-url:x-message-url
         :list-unsubscribe:list-subscribe:content-type
         :content-transfer-encoding;
        b=ORtoWbrWkh7+Ubn8IGKtux91P5FQBFgW7/2V5xHt5+iwsmFJYUU4Y96RmFpJuTXhd2
         hRL4piVtmuFseDtd7wUbSS2pDP+DiRZT4gOaJ+cf9iEvdFc0BUp82O++D65aKpOm1i8D
         R7g3+0a0KK7JOsyC+/Hj5txEc4q1phLNVesns=
Received: by 10.220.80.87 with SMTP id s23mr50799vck.34.1259438605639;
        Sat, 28 Nov 2009 12:03:25 -0800 (PST)
X-BeenThere: ruby-ffi@googlegroups.com
Received: by 10.220.78.37 with SMTP id i37ls1321443vck.3.p; Sat, 28 Nov 2009 
	12:03:24 -0800 (PST)
Received: by 10.220.89.91 with SMTP id d27mr531312vcm.6.1259438604787;
        Sat, 28 Nov 2009 12:03:24 -0800 (PST)
Received: by 10.220.89.91 with SMTP id d27mr531311vcm.6.1259438604762;
        Sat, 28 Nov 2009 12:03:24 -0800 (PST)
Return-Path: <jon.forums@gmail.com>
Received: from mail-qy0-f171.google.com (mail-qy0-f171.google.com [209.85.221.171])
        by gmr-mx.google.com with ESMTP id 24si242004vws.4.2009.11.28.12.03.23;
        Sat, 28 Nov 2009 12:03:23 -0800 (PST)
Received-SPF: pass (google.com: domain of jon.forums@gmail.com designates 209.85.221.171 as permitted sender) client-ip=209.85.221.171;
Received: by qyk1 with SMTP id 1so1073560qyk.0
        for <ruby-ffi@googlegroups.com>; Sat, 28 Nov 2009 12:03:23 -0800 (PST)
Received: by 10.224.29.136 with SMTP id q8mr1247435qac.51.1259438603470;
        Sat, 28 Nov 2009 12:03:23 -0800 (PST)
Return-Path: <jon.forums@gmail.com>
Received: from Red (rrcs-24-123-72-16.central.biz.rr.com [24.123.72.16])
        by mx.google.com with ESMTPS id 22sm2312979qyk.6.2009.11.28.12.03.21
        (version=TLSv1/SSLv3 cipher=RC4-MD5);
        Sat, 28 Nov 2009 12:03:22 -0800 (PST)
Date: Sat, 28 Nov 2009 15:03:14 -0500
From: Jon <jon.forums@gmail.com>
To: ruby-ffi@googlegroups.com
Subject: Re: [ruby-ffi] segfault on windows MRI but not windows JRuby
Message-Id: <20091128150314.df613792.jon.forums@gmail.com>
In-Reply-To: <4ccee320911271206j74ac5e40tb09f9918f2ca211e@mail.gmail.com>
References: <20091127124131.0f3ca7b2.jon.forums@gmail.com>
	<4ccee320911271206j74ac5e40tb09f9918f2ca211e@mail.gmail.com>
X-Mailer: Sylpheed 2.7.1 (GTK+ 2.10.14; i686-pc-mingw32)
Mime-Version: 1.0
X-Original-Authentication-Results: gmr-mx.google.com; spf=pass (google.com: 
	domain of jon.forums@gmail.com designates 209.85.221.171 as permitted sender) 
	smtp.mail=jon.forums@gmail.com; dkim=pass (test mode) header.i=@gmail.com
Reply-To: ruby-ffi@googlegroups.com
Precedence: list
Mailing-list: list ruby-ffi@googlegroups.com; contact ruby-ffi+owners@googlegroups.com
List-ID: <ruby-ffi.googlegroups.com>
List-Post: <http://groups.google.com/group/ruby-ffi/post?hl=>, 
	<mailto:ruby-ffi@googlegroups.com>
List-Help: <http://groups.google.com/support/?hl=>, <mailto:ruby-ffi+help@googlegroups.com>
List-Archive: <http://groups.google.com/group/ruby-ffi?hl=>
X-Thread-Url: http://groups.google.com/group/ruby-ffi/t/1712f5507b15b467
X-Message-Url: http://groups.google.com/group/ruby-ffi/msg/ed7c3a4a70b07e1d
List-Unsubscribe: <http://groups.google.com/group/ruby-ffi/subscribe?hl=>, 
	<mailto:ruby-ffi+unsubscribe@googlegroups.com>
List-Subscribe: <http://groups.google.com/group/ruby-ffi/subscribe?hl=>, 
	<mailto:ruby-ffi+subscribe@googlegroups.com>
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit

> It could be the calling convention.  On JRuby, that isn't wired up
> yet, so it creates callbacks with C calling convention always, but on
> MRI, it is wired up, so it creates a callback with the convention as
> set by ffi_convention.

If it's not wired up in JRuby I'd also expect things to fail in JRuby as the example's callback prototype has CALLBACK which is defined as __stdcall in Windows.  Odd...JRuby's default __cdecl should cause problems.

Does ffi_convention set the calling convention for all attached fcn's of a module?  It appears to in lib/ffi/library.rb[64] but I haven't dug into any more of the code.


> Try setting ffi_convention to :default before declaring the callback,
> and then to :stdcall when declaring the functions exported by the
> library.

OK.  Will also try ffi_convention :stdcall before declaring the callback *and* before declaring the exported library fcns.

Jon
