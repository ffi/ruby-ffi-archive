Delivered-To: headius@headius.com
Received: by 10.114.184.4 with SMTP id h4cs78984waf;
        Fri, 11 Dec 2009 12:51:22 -0800 (PST)
Received: by 10.150.70.4 with SMTP id s4mr3349044yba.21.1260564677458;
        Fri, 11 Dec 2009 12:51:17 -0800 (PST)
Return-Path: <3xLAiSwoJCOINSR.JSVYQWKQEMP.GSQVYFc-JJMKSSKPIKVSYTW.GSQ@listserv.bounces.google.com>
Received: from mail-yx0-f142.google.com (mail-yx0-f142.google.com [209.85.210.142])
        by mx.google.com with ESMTP id 28si4204563yxe.114.2009.12.11.12.51.17;
        Fri, 11 Dec 2009 12:51:17 -0800 (PST)
Received-SPF: pass (google.com: domain of 3xLAiSwoJCOINSR.JSVYQWKQEMP.GSQVYFc-JJMKSSKPIKVSYTW.GSQ@listserv.bounces.google.com designates 209.85.210.142 as permitted sender) client-ip=209.85.210.142;
Authentication-Results: mx.google.com; spf=pass (google.com: domain of 3xLAiSwoJCOINSR.JSVYQWKQEMP.GSQVYFc-JJMKSSKPIKVSYTW.GSQ@listserv.bounces.google.com designates 209.85.210.142 as permitted sender) smtp.mail=3xLAiSwoJCOINSR.JSVYQWKQEMP.GSQVYFc-JJMKSSKPIKVSYTW.GSQ@listserv.bounces.google.com
Received: by yxe6 with SMTP id 6sf1763113yxe.13
        for <headius@headius.com>; Fri, 11 Dec 2009 12:51:17 -0800 (PST)
Received: by 10.101.130.29 with SMTP id h29mr135849ann.32.1260564676209;
        Fri, 11 Dec 2009 12:51:16 -0800 (PST)
X-BeenThere: ruby-ffi@googlegroups.com
Received: by 10.100.17.29 with SMTP id 29ls1065209anq.1.p; Fri, 11 Dec 2009 
	12:51:15 -0800 (PST)
Received: by 10.100.29.20 with SMTP id c20mr2055972anc.17.1260564675264;
        Fri, 11 Dec 2009 12:51:15 -0800 (PST)
Received: by 10.100.29.20 with SMTP id c20mr2055971anc.17.1260564675234;
        Fri, 11 Dec 2009 12:51:15 -0800 (PST)
Return-Path: <jon.forums@gmail.com>
Received: from mail-yx0-f180.google.com (mail-yx0-f180.google.com [209.85.210.180])
        by gmr-mx.google.com with ESMTP id 24si240803ywh.3.2009.12.11.12.51.14;
        Fri, 11 Dec 2009 12:51:14 -0800 (PST)
Received-SPF: pass (google.com: domain of jon.forums@gmail.com designates 209.85.210.180 as permitted sender) client-ip=209.85.210.180;
Received: by yxe10 with SMTP id 10so1192208yxe.12
        for <ruby-ffi@googlegroups.com>; Fri, 11 Dec 2009 12:51:14 -0800 (PST)
Received: by 10.100.244.32 with SMTP id r32mr2969579anh.138.1260564664480;
        Fri, 11 Dec 2009 12:51:04 -0800 (PST)
Return-Path: <jon.forums@gmail.com>
Received: from Red (rrcs-24-172-153-250.central.biz.rr.com [24.172.153.250])
        by mx.google.com with ESMTPS id 20sm1425587iwn.13.2009.12.11.12.51.02
        (version=TLSv1/SSLv3 cipher=RC4-MD5);
        Fri, 11 Dec 2009 12:51:03 -0800 (PST)
Date: Fri, 11 Dec 2009 15:49:54 -0500
From: Jon <jon.forums@gmail.com>
To: ruby-ffi@googlegroups.com
Subject: Re: [ruby-ffi] convert free -> xfree?
Message-Id: <20091211154954.aa04ebfb.jon.forums@gmail.com>
In-Reply-To: <71166b3b0912111027y2b1d48ccs66487c7b9ec57d9c@mail.gmail.com>
References: <20091211104804.fc09f471.jon.forums@gmail.com>
	<71166b3b0912111027y2b1d48ccs66487c7b9ec57d9c@mail.gmail.com>
X-Mailer: Sylpheed 2.7.1 (GTK+ 2.10.14; i686-pc-mingw32)
Mime-Version: 1.0
X-Original-Authentication-Results: gmr-mx.google.com; spf=pass (google.com: 
	domain of jon.forums@gmail.com designates 209.85.210.180 as permitted sender) 
	smtp.mail=jon.forums@gmail.com; dkim=pass (test mode) header.i=@gmail.com
X-Original-Sender: jon.forums@gmail.com
Reply-To: ruby-ffi@googlegroups.com
Precedence: list
Mailing-list: list ruby-ffi@googlegroups.com; contact ruby-ffi+owners@googlegroups.com
List-ID: <ruby-ffi.googlegroups.com>
List-Post: <http://groups.google.com/group/ruby-ffi/post?hl=>, 
	<mailto:ruby-ffi@googlegroups.com>
List-Help: <http://groups.google.com/support/?hl=>, <mailto:ruby-ffi+help@googlegroups.com>
List-Archive: <http://groups.google.com/group/ruby-ffi?hl=>
X-Thread-Url: http://groups.google.com/group/ruby-ffi/t/50473ed6cbbbc685
X-Message-Url: http://groups.google.com/group/ruby-ffi/msg/90dbf250fe54c2da
Sender: ruby-ffi@googlegroups.com
List-Unsubscribe: <http://groups.google.com/group/ruby-ffi/subscribe?hl=>, 
	<mailto:ruby-ffi+unsubscribe@googlegroups.com>
List-Subscribe: <http://groups.google.com/group/ruby-ffi/subscribe?hl=>, 
	<mailto:ruby-ffi+subscribe@googlegroups.com>
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: quoted-printable

> On Fri, Dec 11, 2009 at 12:48 PM, Jon <jon.forums@gmail.com> wrote:
> > From http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-core/22727 =
in the "Mixing runtime libraries" section the claim that you can mix msft c=
 runtimes if
> >
> > * If you call ALLOC or ALLOC_N, use xfree and not free
> > * Don't call sprintf or printf in an extension, instead use rb_f_sprint=
f/rb_vsprintf/rb_io_printf
> >
> > ...does it make sense to change these free's to xfree's (not libffi's d=
lmalloc?) in ruby-ffi?
> >
> >
> > C:\Users\Jon\Documents\RubyDev\ffi-trunk>grep -Rn " free(" ext
> >
> > ext/ffi_c/Buffer.c:154: =A0 =A0 =A0 =A0free(ptr->storage);
> > ext/ffi_c/ClosurePool.c:131: =A0 =A0 =A0 =A0free(memory->data);
> > ext/ffi_c/ClosurePool.c:132: =A0 =A0 =A0 =A0free(memory);
> > ext/ffi_c/ClosurePool.c:135: =A0 =A0free(pool);
> > ext/ffi_c/ClosurePool.c:218: =A0 =A0free(block);
> > ext/ffi_c/ClosurePool.c:219: =A0 =A0free(list);
> > ext/ffi_c/libffi/src/dlmalloc.c:678: =A0free(void* p)
> > ext/ffi_c/libffi/src/dlmalloc.c:857: =A0 =A0free(pool); =A0 =A0 // Can =
now free the array (or not, if it is needed later)
> > ext/ffi_c/MemoryPointer.c:137: =A0 =A0 =A0 =A0 =A0 =A0free(ptr->storage=
);
> > ext/ffi_c/Type.c:162: =A0 =A0free(type->name);
> >
>=20
> libffi and the C extension are being built and linked against the same
> CRT version used by Ruby. That poses no risk for cross-CRT memory
> allocation and freeing.

Currently yes.

However, given the limited number of changes needed what do you see as the =
the downsides of removing this build restriction, assuming the specs pass? =
 Mod and maintenance of a version of dlmalloc distinct from libffi's?  I'm =
assuming (incorrectly?) that libffi's src currently isn't modified from the=
 ftp://sources.redhat.com/pub/libffi/ dowloads.


> If was the case libffi was built with newer version of Visual Studio,
> which links to different CRT than Ruby itself, then I would worry to
> make the proper transition of all the free calls for xfree.

Not just paid versions of Visual Studio but also the Express editions and t=
he command line compiler versions that msft is now including as part of the=
 free Windows SDK download.


Jon
