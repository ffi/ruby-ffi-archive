<html>
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>[ruby-ffi] Correct usage of AdjustTokenPrivileges with FFI</title>
<link rel="important stylesheet" href="">
<style>div.headerdisplayname {font-weight:bold;}</style></head>
<body>
<table border=0 cellspacing=0 cellpadding=0 width="100%" class="header-part1"><tr><td><div class="headerdisplayname" style="display:inline;">Subject: </div>[ruby-ffi] Correct usage of AdjustTokenPrivileges with FFI</td></tr><tr><td><div class="headerdisplayname" style="display:inline;">From: </div>Marc Ruehlaender <ruehli@arcor.de></td></tr><tr><td><div class="headerdisplayname" style="display:inline;">Date: </div>9/12/13 2:53 AM</td></tr></table><table border=0 cellspacing=0 cellpadding=0 width="100%" class="header-part2"><tr><td><div class="headerdisplayname" style="display:inline;">To: </div>ruby-ffi@googlegroups.com</td></tr></table><br>
<div class="moz-text-html"  lang="x-western"><div dir="ltr"><p>Hi,</p><p>I'm new to Ruby and I'm trying to do some GUI-based test automation of a Win32 application using ruby/rspec and ffi.<br>(ruby 2.0.0p247 (2013-06-27) [i386-mingw32], ffi 1.9.0)</p><p>What I am trying to do is click a toolbar button. (More of an exercise than a necessity, since I could of course call the&nbsp;corresponding menu function.)<br>To get the coordinates for the mouse click I want to send the TB_GETRECT message to the toolbar of my application.<br>The second parameter of the message takes a pointer which will take a RECT with the bounding rectangle of the button.<br>Since I need to allocate memory for this pointer to point to in the applications address space, I want to get DEBUG privileges.</p><p>And this is where I am getting stumped.</p><p>Relevant code patches:</p><p>---------------<br>#file myapp-test.rb<br>require './ffi_winapi'</p><p>module MyApp</p><p>&nbsp; #start my app<br>&nbsp; system 'start "" "&lt;absolute path to my app&gt;"'</p><p>&nbsp; #get the handle for the main window<br>&nbsp; sleep 0.2 while (handle = Win.find_window( nil, '&lt;Window title&gt;') ) &lt;= 0<br>&nbsp; <br>&nbsp; #get the handle for the tool bar<br>&nbsp; tool_bar = Win.find_window_ex(handle, 0, "ToolbarWindow32", nil)</p><p>&nbsp; #get the process ID for the process in which tool bar is running<br>&nbsp; ppid = FFI::MemoryPointer.new(:uint32, 1)<br>&nbsp; tid = Win.get_window_thread_process_id(tool_bar, ppid)<br>&nbsp; pid = ppid.read_uint32</p><p>&nbsp; #open the process for getting a security token&nbsp; <br>&nbsp; proc = WinKernel.open_process(WinKernel::PROCESS_QUERY_INFORMATION, false, pid)</p><p>&nbsp; #get a token handle to adjust privileges<br>&nbsp; ptoken = FFI::MemoryPointer.new(:long)<br>&nbsp; bret = WinAuth.open_process_token(proc, WinAuth::TOKEN_QUERY | WinAuth::TOKEN_ADJUST_DEFAULT, ptoken)<br>&nbsp; token = ptoken.read_long</p><p>&nbsp; #intitalize LUID struct<br>&nbsp; myluid = WinAuth::Luid.new<br>&nbsp; myluid[:lo] = 0<br>&nbsp; myluid[:hi] = 0</p><p>&nbsp; #get the system LUID for debug privileges<br>&nbsp; WinAuth.lookup_privilege_value("", WinAuth::SE_DEBUG_NAME, myluid)<br>&nbsp; <br>&nbsp; #up to this point everything seems to be working fine judging by puts debugging</p><p>&nbsp; #prepare the TOKEN_PRIVILEGES struct for adjust token privileges<br>&nbsp; mytokenprivs = WinAuth::TokenPrivileges.new(FFI::MemoryPointer.new(WinAuth::TokenPrivileges.size_with_privileges(1)))<br>&nbsp; mytokenprivs[:count] = 1<br>&nbsp; myluidattr = mytokenprivs.privilege(0)<br>&nbsp; myluidattr[:luid] = myluid<br>&nbsp; myluidattr[:attributes] = WinAuth::SE_PRIVILEGE_ENABLED</p><p>&nbsp; #code shamelessly adapted from chef code<br>&nbsp; plen = FFI::MemoryPointer.new(:long).write_long(mytokenprivs.size_with_privileges)<br>&nbsp; prevtokenprivs = WinAuth::TokenPrivileges.new(FFI::MemoryPointer.new(plen.read_long))</p><p>&nbsp; <font color="#ff0000"># !!! Failing code !!!</font><br>&nbsp; bret = WinAuth.adjust_token_privileges(token, false, mytokenprivs, mytokenprivs.size_with_privileges, prevtokenprivs, plen)<br>&nbsp; err = WinKernel.get_last_error<br>&nbsp; puts "Adjust token privileges returned #{bret}; last error: #{err}"<br>&nbsp; puts "#{prevtokenprivs[:count]} privileges were modified."</p><p><br>&nbsp; #clean up<br>&nbsp; WinKernel.close_handle(token)<br>&nbsp; WinKernel.close_handle(proc)<br>end<br>#end file myapp_test.rb<br>---------------<br>#excerpts from file ffi_winapi.rb<br>require 'ffi'</p><p>module Win<br>&nbsp; extend FFI::Library</p><p>&nbsp; ffi_lib 'user32'<br>&nbsp; ffi_convention :stdcall</p><p>&nbsp; #... (consts, structs and method wrappers for user32)</p><p>end</p><p>module WinKernel<br>&nbsp; extend FFI::Library</p><p>&nbsp; ffi_lib 'kernel32'</p><p>&nbsp; #... (consts, structs and method wrappers for kernel32)</p><p>end</p><p>module WinAuth<br>&nbsp; extend FFI::Library</p><p>&nbsp; ffi_lib 'advapi32'<br>&nbsp; <br>&nbsp; TOKEN_QUERY = 0x0008<br>&nbsp; TOKEN_ADJUST_DEFAULT = 0x0080<br>&nbsp; <br>&nbsp; # BOOL WINAPI OpenProcessToken(_In_ HANDLE ProcessHandle, _In_ DWORD DesiredAccess, _Out_ PHANDLE TokenHandle);<br>&nbsp; attach_function :open_process_token, :OpenProcessToken,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [ :long, :int, :pointer ], :bool</p><p>&nbsp; class Luid &lt; FFI::Struct<br>&nbsp;&nbsp;&nbsp; layout :lo, :int,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; :hi, :int<br>&nbsp; end<br>&nbsp; <br>&nbsp; SE_DEBUG_NAME = "SeDebugPrivilege"<br>&nbsp; <br>&nbsp; # BOOL WINAPI LookupPrivilegeValue(_In_opt_ LPCTSTR lpSystemName, _In_ LPCTSTR lpName, _Out_ PLUID lpLuid);<br>&nbsp; attach_function :lookup_privilege_value, :LookupPrivilegeValueA,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [ :string, :string, :pointer], :bool</p><p>&nbsp; class LuidAndAttributes &lt; FFI::Struct<br>&nbsp;&nbsp;&nbsp; layout :luid, Luid,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; :attributes, :int<br>&nbsp; end<br>&nbsp; <br>&nbsp; SE_PRIVILEGE_ENABLED = 2<br>&nbsp; <br>&nbsp; #class definition shamelessly adapted from chef code<br>&nbsp; class TokenPrivileges &lt; FFI::Struct<br>&nbsp;&nbsp;&nbsp; layout :count, :uint32,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; :privileges, LuidAndAttributes<br>&nbsp; <br>&nbsp;&nbsp;&nbsp; def self.size_with_privileges(num_privileges)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; offset_of(:privileges) + LuidAndAttributes.size*num_privileges<br>&nbsp;&nbsp;&nbsp; end<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; def size_with_privileges<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TokenPrivileges.size_with_privileges(self[:count])<br>&nbsp;&nbsp;&nbsp; end</p><p>&nbsp;&nbsp;&nbsp; def privilege(index)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LuidAndAttributes.new(pointer + offset_of(:privileges) + (index * LuidAndAttributes.size))<br>&nbsp;&nbsp;&nbsp; end<br>&nbsp; end</p><p>&nbsp; # BOOL WINAPI AdjustTokenPrivileges(_In_ HANDLE TokenHandle, _In_ BOOL DisableAllPrivileges, _In_opt_ PTOKEN_PRIVILEGES NewState, _In_ DWORD BufferLength, _Out_opt_ PTOKEN_PRIVILEGES PreviousState, _Out_opt_ PDWORD ReturnLength);<br>&nbsp; attach_function :adjust_token_privileges, :AdjustTokenPrivileges,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [ :long, :bool, :pointer, :int, :pointer, :pointer ], :bool<br>end</p><p>#end file ffi_winapi.rb<br>---------------</p><p>When running the ruby code, I get</p><p>Adjust token privileges returned false; last error: 0<br>0 privileges were modified.</p><p>Running the equivalent algorithm implemented in visual C++ works fine (i.e. it declares that 1 privilege has been modified, and also the following steps - not shown in the ruby code - lead to a successful read of the RECT.)<br>Therefore I assume, the error is in my lack of understanding ffi and/or basic ruby concepts.</p><p>Any pointers on how to proceed are appreciated.</p><p>Cheers,<br>Marc</p><p>&nbsp;</p></div>

<p></p>

-- <br />
&nbsp;<br />
--- <br />
You received this message because you are subscribed to the Google Groups &quot;ruby-ffi&quot; group.<br />
To unsubscribe from this group and stop receiving emails from it, send an email to ruby-ffi+unsubscribe@googlegroups.com.<br />
For more options, visit <a href="https://groups.google.com/groups/opt_out">https://groups.google.com/groups/opt_out</a>.<br />

</div></body>
</html>
</table></div>