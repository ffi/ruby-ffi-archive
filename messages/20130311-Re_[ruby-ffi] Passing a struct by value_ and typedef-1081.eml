Delivered-To: headius@headius.com
Received: by 10.152.22.74 with SMTP id b10csp64081laf;
        Mon, 11 Mar 2013 01:20:45 -0700 (PDT)
X-Received: by 10.60.22.69 with SMTP id b5mr8091603oef.38.1362990044104;
        Mon, 11 Mar 2013 01:20:44 -0700 (PDT)
Return-Path: <ruby-ffi+bncBD2LPGVBRIEBBWVH62EQKGQEWXYLDTI@googlegroups.com>
Received: from mail-oa0-f57.google.com (mail-oa0-f57.google.com [209.85.219.57])
        by mx.google.com with ESMTPS id oi4si13940061obb.10.2013.03.11.01.20.43
        (version=TLSv1 cipher=ECDHE-RSA-RC4-SHA bits=128/128);
        Mon, 11 Mar 2013 01:20:44 -0700 (PDT)
Received-SPF: pass (google.com: domain of ruby-ffi+bncBD2LPGVBRIEBBWVH62EQKGQEWXYLDTI@googlegroups.com designates 209.85.219.57 as permitted sender)
Authentication-Results: mx.google.com;
       spf=pass (google.com: domain of ruby-ffi+bncBD2LPGVBRIEBBWVH62EQKGQEWXYLDTI@googlegroups.com designates 209.85.219.57 as permitted sender) smtp.mail=ruby-ffi+bncBD2LPGVBRIEBBWVH62EQKGQEWXYLDTI@googlegroups.com;
       dkim=pass header.i=@gmail.com
Received: by mail-oa0-f57.google.com with SMTP id o6sf1626924oag.2
        for <headius@headius.com>; Mon, 11 Mar 2013 01:20:43 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=googlegroups.com; s=20120806;
        h=x-received:x-beenthere:x-received:date:from:to:message-id
         :in-reply-to:references:subject:mime-version:x-original-sender
         :reply-to:precedence:mailing-list:list-id:x-google-group-id
         :list-post:list-help:list-archive:sender:list-subscribe
         :list-unsubscribe:content-type;
        bh=KdsrvFwAwi9tBRnLy2UmBKfHmn0CjFfyMK8I1HdM6OY=;
        b=zIDnRHdk1pp9ub8WKkbGXY089DkaNKaBDh05KnWZbee+HJD3YoRWXBJOFfoNpo+ie6
         /gGowtUBKOhViplej2A/zrtUnwerZHyXVNXWQeW7yrmw8rXnB1VYFYCT5RTx6zncHWAb
         o8HXWrQSSFE9uUpRszrGlJvk/BBZlTgqa7Fn+iIKQYE7ffoOrB0b4WxeUYRa+Fif/paL
         Nim3xNQDKw21dMMZ6Yuxj7nYC6+f+h8ufhIooGUXWQ9yDB1e/ICmqGRXqKYdPC3WwxNV
         8BnsoTV/C4Ahtuc6mF1rVhO6egUc++sqR2dPXps35XFhq954/atZIU5da8gQsUvmydai
         LCiQ==
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20120113;
        h=x-received:x-beenthere:x-received:date:from:to:message-id
         :in-reply-to:references:subject:mime-version:x-original-sender
         :reply-to:precedence:mailing-list:list-id:x-google-group-id
         :list-post:list-help:list-archive:sender:list-subscribe
         :list-unsubscribe:content-type;
        bh=KdsrvFwAwi9tBRnLy2UmBKfHmn0CjFfyMK8I1HdM6OY=;
        b=pr2xO/ZQl9s9jWZOrR8toXYU9wusue9/9TzBCL1XxdLWZ6EN79yoe9aR853vCN4cBI
         5Qx0Khlu9w+N5+cmWssrEdfuZ/jzgHhFVZImc4m/piPdhLoArOssA/zsRpbjgwl4QEak
         6w0CSd4wC6iC7urX9dpq0mjZTdlG3QMKCSwuNe/h2y41UJkXciQJfjS4pQkBzX6OU5V8
         7WmSMZG6p55pNejWoHf6nW8dSvNM/A1R60WWhk5dStKHsSRYd0FGHf/eKfWCu5dZmULO
         GukXI987KyseVF6rTlk6ddCMLQ4iIZMbrHTltdTbntHgqIN1EfiUqzMlsUgctNk+DuuD
         sNNQ==
X-Received: by 10.50.185.200 with SMTP id fe8mr792814igc.0.1362990042947;
        Mon, 11 Mar 2013 01:20:42 -0700 (PDT)
X-BeenThere: ruby-ffi@googlegroups.com
Received: by 10.50.42.137 with SMTP id o9ls1024045igl.15.gmail; Mon, 11 Mar
 2013 01:20:42 -0700 (PDT)
X-Received: by 10.50.217.225 with SMTP id pb1mr796049igc.5.1362990042529;
        Mon, 11 Mar 2013 01:20:42 -0700 (PDT)
Date: Mon, 11 Mar 2013 01:20:40 -0700 (PDT)
From: Wayne Meissner <wmeissner@gmail.com>
To: ruby-ffi@googlegroups.com
Message-Id: <fdaedba3-35e6-4d4f-9c2a-59ecc0ff4c10@googlegroups.com>
In-Reply-To: <CA+_M_Jc2x-Xof4Kc=dscvnvMr1pvkC5tjyusnZCQFLW=GStpUQ@mail.gmail.com>
References: <4a4d0927-7aea-4469-aa6f-d7763c7a2610@googlegroups.com>
 <5132B5C7.6070604@gmail.com> <CA+_M_JcXJ-wd1ZvqH7C3Xdk7QWTW=z+MvxLfNYPgPC2QgeT3og@mail.gmail.com>
 <5132D072.9060604@gmail.com> <CA+_M_Jf_ccD8O+9Pt90dBYy7KEvXgrFsjkBnzoax_SPBSmdbcA@mail.gmail.com>
 <CA+_M_JckNW58+dmW8Lza_XoXZskQ54A8Bx+oOp6ZOyFEJrjv=w@mail.gmail.com>
 <5133FCC2.6040403@gmail.com> <e12edc65-9eab-4390-a263-38c47720dfbd@googlegroups.com>
 <CA+_M_Jc2x-Xof4Kc=dscvnvMr1pvkC5tjyusnZCQFLW=GStpUQ@mail.gmail.com>
Subject: Re: [ruby-ffi] Passing a struct by value, and typedef
MIME-Version: 1.0
X-Original-Sender: wmeissner@gmail.com
Reply-To: ruby-ffi@googlegroups.com
Precedence: list
Mailing-list: list ruby-ffi@googlegroups.com; contact ruby-ffi+owners@googlegroups.com
List-ID: <ruby-ffi.googlegroups.com>
X-Google-Group-Id: 238405446264
List-Post: <http://groups.google.com/group/ruby-ffi/post?hl=en_US>, <mailto:ruby-ffi@googlegroups.com>
List-Help: <http://groups.google.com/support/?hl=en_US>, <mailto:ruby-ffi+help@googlegroups.com>
List-Archive: <http://groups.google.com/group/ruby-ffi?hl=en_US>
Sender: ruby-ffi@googlegroups.com
List-Subscribe: <http://groups.google.com/group/ruby-ffi/subscribe?hl=en_US>, <mailto:ruby-ffi+subscribe@googlegroups.com>
List-Unsubscribe: <http://groups.google.com/group/ruby-ffi/subscribe?hl=en_US>,
 <mailto:googlegroups-manage+238405446264+unsubscribe@googlegroups.com>
Content-Type: multipart/alternative; 
	boundary="----=_Part_450_25269614.1362990040812"

------=_Part_450_25269614.1362990040812
Content-Type: text/plain; charset=ISO-8859-1


Isn't it libglib-2.0.so ?

i.e. try:

  ffi_lib 'glib-2.0'

If you just want to try and see if a library can be found by FFI, use this:

  ruby -rffi -e 'FFI::DynamicLibrary.open("libglib-2.0.so", 
FFI::DynamicLibrary::RTLD_LAZY | FFI::DynamicLibrary::RTLD_LOCAL)'


As for the pointer result, NULL is handled fine - just use Pointer#null? to 
check if the return value is NULL.


On Monday, 11 March 2013 02:50:27 UTC+10, Maurizio De Santis wrote:
>
> Thank you, the porting is going well; if you want you can see the progress 
> at https://github.com/ProGNOMmers/gtop .
>
> Now I have some troubles: I need to use g_free from glib, so I tried to 
> wrap it:
>
> require 'gtop'
>
> module GTop
>   module GLib
>     extend FFI::Library
>     ffi_lib 'libglib2.0'
>
>     typedef :pointer, :gpointer
>
>     attach_function :g_free, [:gpointer], :void
>   end
> end
>
> On my pc libglib2.0.so is located inside /usr/lib/x86_64-linux-gnu/ , 
> which should be found since it is inside the ld paths, which on my machine 
> are
>
> # Multiarch support
> /lib/i386-linux-gnu
> /usr/lib/i386-linux-gnu
> /lib/i686-linux-gnu
> /usr/lib/i686-linux-gnu
> # libc default configuration
> /usr/local/lib
> /usr/lib/nvidia-settings
> # Multiarch support
> /lib/x86_64-linux-gnu
> /usr/lib/x86_64-linux-gnu
> /usr/lib/x86_64-linux-gnu/mesa
>
> but I get a LoadError:
>
> Could not open library 'libglib2.0': libglib2.0: cannot open shared object 
> file: No such file or directory.
> Could not open library 'libglib2.0.so': libglib2.0.so: cannot open shared 
> object file: No such file or directory
> /home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/ffi-1.4.0/lib/ffi/library.rb:123:in 
> `block in ffi_lib'
> /home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/ffi-1.4.0/lib/ffi/library.rb:90:in 
> `map'
> /home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/ffi-1.4.0/lib/ffi/library.rb:90:in 
> `ffi_lib'
> /home/user/github/me/gtop/lib/gtop/glib.rb:6:in `<module:GLib>'
> /home/user/github/me/gtop/lib/gtop/glib.rb:4:in `<module:GTop>'
> /home/user/github/me/gtop/lib/gtop/glib.rb:3:in `<top (required)>'
> /home/user/.rbenv/versions/2.0.0-p0/lib/ruby/site_ruby/2.0.0/rubygems/core_ext/kernel_require.rb:45:in 
> `require'
> /home/user/.rbenv/versions/2.0.0-p0/lib/ruby/site_ruby/2.0.0/rubygems/core_ext/kernel_require.rb:45:in 
> `require'
> /home/user/github/me/gtop/lib/gtop.rb:7:in `<module:GTop>'
> /home/user/github/me/gtop/lib/gtop.rb:3:in `<top (required)>'
> /home/user/.rbenv/versions/2.0.0-p0/lib/ruby/site_ruby/2.0.0/rubygems/core_ext/kernel_require.rb:45:in 
> `require'
> /home/user/.rbenv/versions/2.0.0-p0/lib/ruby/site_ruby/2.0.0/rubygems/core_ext/kernel_require.rb:45:in 
> `require'
> /home/user/github/me/gtop/Rakefile:4:in `block in <top (required)>'
> /home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/task.rb:228:in 
> `call'
> /home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/task.rb:228:in 
> `block in execute'
> /home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/task.rb:223:in 
> `each'
> /home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/task.rb:223:in 
> `execute'
> /home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/task.rb:166:in 
> `block in invoke_with_call_chain'
> /home/user/.rbenv/versions/2.0.0-p0/lib/ruby/2.0.0/monitor.rb:211:in 
> `mon_synchronize'
> /home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/task.rb:159:in 
> `invoke_with_call_chain'
> /home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/task.rb:152:in 
> `invoke'
> /home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/application.rb:143:in 
> `invoke_task'
> /home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/application.rb:101:in 
> `block (2 levels) in top_level'
> /home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/application.rb:101:in 
> `each'
> /home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/application.rb:101:in 
> `block in top_level'
> /home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/application.rb:110:in 
> `run_with_threads'
> /home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/application.rb:95:in 
> `top_level'
> /home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/application.rb:73:in 
> `block in run'
> /home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/application.rb:160:in 
> `standard_exception_handling'
> /home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/application.rb:70:in 
> `run'
> /home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/bin/rake:33:in 
> `<top (required)>'
> /home/user/.rbenv/versions/2.0.0-p0/bin/rake:23:in `load'
> /home/user/.rbenv/versions/2.0.0-p0/bin/rake:23:in `<main>'
>
> I tried to set LD_LIBRARY_PATH too, but without success.
>
> Oh, and I have another doubt: gpointer is the return value of 
> `glibtop_get_proclist', and can be either `NULL' on error or a `unsigned *' 
> list of pids.
> I defined it as :pointer, it is correct? could the NULL value give 
> problems? should I manage it?
>
> --
>
> Maurizio De Santis
>
>
> 2013/3/5 Wayne Meissner <wmei...@gmail.com <javascript:>>
>
>>
>> :buffer_in, and :buffer_out are optimization hints for VMs when they need 
>> to copy data from VM heap memory to native memory:
>>
>> :buffer_in means "allocate some temporary native memory, copy the 
>> contents of this object to it, then pass the temporary memory address to 
>> the function"
>>
>> :buffer_out means "allocate some temporary native memory, pass that 
>> address to the function, then afterwards, copy the contents of the 
>> temporary memory area back to the VM heap object"
>>
>> :pointer and :buffer_inout are analogous and mean "do both of the above" 
>> - i.e. copies both in to and out of the temporary memory area.
>>
>> If you're using a MemoryPointer as your memory (as Struct does), then it 
>> is already native, so it doesn't matter, so you can just use :pointer.
>>
>> The original rationale behind the :buffer_in and :buffer_out directives 
>> was that allocating VM heap objects is really cheap, and most VMs have a 
>> very hard time managing native memory allocations.  So from an 
>> implementation point of view, it was better to bias towards VM heap 
>> allocations and copy data in/out of temporary native memory.  Thats where 
>> FFI::Buffer came from - it was VM heap memory that was always copied 
>> to/from native memory when passed as a parameter.
>>
>> In practice, people found it difficult and confusing to understand, so I 
>> just made native allocation management work as best it could in JRuby-1.7.
>>
>>
>> tl;dr - just use :pointer - it will work just fine, at an occasional 
>> minor performance penalty.
>>
>>
>> On Monday, 4 March 2013 11:45:38 UTC+10, Postmodern wrote:
>>
>>>  You want :pointer in this case. I believe :buffer_out is a meant as a 
>>> hint to FFI that data will be written back into an Array of chars/ints.
>>>
>>> On 03/03/2013 05:41 PM, Maurizio De Santis wrote:
>>>  
>>>  Another question: glibtop_get_cpu takes a struct as parameter, and 
>>> fills it with informations about cpu.
>>>
>>>  I declared it as 
>>>
>>> attach_function :glibtop_get_cpu, [:pointer], :void
>>>
>>>  I think I can substitute :pointer with :buffer_out , am I right?
>>>  
>>> -- 
>>>
>>> Maurizio De Santis
>>>  
>>>
>>> 2013/3/4 Maurizio De Santis <desantis...@gmail.com>
>>>
>>>> Thank you a lot, your suggestions are precious.
>>>>   
>>>> -- 
>>>>
>>>> Maurizio De Santis
>>>>  
>>>>
>>>> 2013/3/3 postmodern <postmod...@gmail.com>
>>>>
>>>>>  You can simplify that code to just:
>>>>>
>>>>> a = LibGtop::GlibtopCpu.new
>>>>> LibGtop.glibtop_get_cpu(a)
>>>>> p a[:frequency]
>>>>>
>>>>>  This will allocate memory for a GlibtopCpu struct, pass the pointer 
>>>>> to the memory to glibtop_get_cpu and access to the struct field within the 
>>>>> memory. Once you are done with the "a" variable, Ruby will just GC it and 
>>>>> FFI will free the underlying memory. 
>>>>>
>>>>>
>>>>> On 03/02/2013 07:54 PM, Maurizio De Santis wrote:
>>>>>    
>>>>>  Thank you. Now, the code runs without errors:
>>>>>
>>>>> require 'ffi'
>>>>>
>>>>> module LibGtop
>>>>>   
>>>>>   extend FFI::Library
>>>>>   ffi_lib 'libgtop-2.0'
>>>>>
>>>>>   typedef :uint64, :guint64
>>>>>
>>>>>   attach_function :glibtop_get_cpu, [:pointer], :void
>>>>>
>>>>>   class GlibtopCpu < FFI::Struct
>>>>>     layout :flags,         :guint64,
>>>>>            :total,         :guint64,
>>>>>            :user,          :guint64,
>>>>>            :nice,          :guint64,
>>>>>            :sys,           :guint64,
>>>>>            :idle,          :guint64,
>>>>>            :iowait,        :guint64,
>>>>>            :irq,           :guint64,
>>>>>            :softirq,       :guint64,
>>>>>            :frequency,     :guint64,
>>>>>            :xcpu_total,   [:guint64, 32],
>>>>>            :xcpu_user,    [:guint64, 32],
>>>>>            :xcpu_nice,    [:guint64, 32],
>>>>>            :xcpu_sys,     [:guint64, 32],
>>>>>            :xcpu_idle,    [:guint64, 32],
>>>>>            :xcpu_iowait,  [:guint64, 32],
>>>>>            :xcpu_irq,     [:guint64, 32],
>>>>>            :xcpu_softirq, [:guint64, 32],
>>>>>            :xcpu_flags,    :guint64
>>>>>   end
>>>>>
>>>>> end
>>>>>
>>>>>
>>>>> # taken from https://github.com/ffi/ffi/**wiki/Structs<https://github.com/ffi/ffi/wiki/Structs>
>>>>> pointer = FFI::MemoryPointer.new :uint64, LibGtop::GlibtopCpu.size, 
>>>>> true
>>>>> a = LibGtop::GlibtopCpu.new pointer
>>>>> LibGtop.glibtop_get_cpu(a)
>>>>> p a[:frequency]
>>>>>
>>>>>  Another question: I initialized the pointer with clear = true, 
>>>>> because the struct pointed by the pointer gets filled by glibtop_get_cpu, 
>>>>> and then must be managed by Ruby, since glibtop_get_cpu just fills 
>>>>> the struct. Am I wrong?
>>>>>  
>>>>> -- 
>>>>>
>>>>> Maurizio De Santis
>>>>>  
>>>>>
>>>>> 2013/3/3 postmodern <postmod...@gmail.com>
>>>>>
>>>>>>  You need to find out guint64's underlying type, and create the 
>>>>>> typedef in Ruby:
>>>>>>
>>>>>>  module LibGtop
>>>>>>   extend FFI::Library
>>>>>>
>>>>>>   typedef :uint64, :guint64
>>>>>> end
>>>>>>
>>>>>>   
>>>>>> On 03/02/2013 06:06 PM, Maurizio De Santis wrote:
>>>>>>   
>>>>>>  I am writing a libgtop2 wrapper using ffi in order to learn how to 
>>>>>> use ffi; I am new to ffi, so I have a lot of doubts.
>>>>>>
>>>>>> libgtop2 lets get system and processes informations (cpu usage, 
>>>>>> memory usage, ...).
>>>>>>
>>>>>> Here some informations about glibtop_get_cpu:
>>>>>>
>>>>>> Library function `glibtop_get_cpu':
>>>>>>
>>>>>>      void glibtop_get_cpu (glibtop_cpu *buf);
>>>>>>      void glibtop_get_cpu_l (glibtop *server, glibtop_cpu *buf);
>>>>>>
>>>>>>    Declaration of `glibtop_cpu' in `<glibtop/cpu.h>':
>>>>>>
>>>>>>      typedef struct _glibtop_cpu     glibtop_cpu;
>>>>>>
>>>>>>      struct _glibtop_cpu
>>>>>>      {
>>>>>>          guint64   flags,
>>>>>>              total,
>>>>>>              user,
>>>>>>              nice,
>>>>>>              sys,
>>>>>>              idle,
>>>>>>              iowait,
>>>>>>              irq,
>>>>>>              softirq,
>>>>>>              frequency,
>>>>>>              xcpu_total [GLIBTOP_NCPU],
>>>>>>              xcpu_user [GLIBTOP_NCPU],
>>>>>>              xcpu_nice [GLIBTOP_NCPU],
>>>>>>              xcpu_sys  [GLIBTOP_NCPU],
>>>>>>              xcpu_idle [GLIBTOP_NCPU],
>>>>>>              xcpu_iowait [GLIBTOP_NCPU],
>>>>>>              xcpu_irq [GLIBTOP_NCPU],
>>>>>>              xcpu_softirq [GLIBTOP_NCPU],
>>>>>>              xcpu_flags;
>>>>>>      };
>>>>>>
>>>>>> ...
>>>>>>
>>>>>>
>>>>>> Here is what I wrote:
>>>>>>
>>>>>> require 'ffi'
>>>>>>
>>>>>> class GlibtopCpu < FFI::Struct
>>>>>>   layout :flags,        :guint64,
>>>>>>          :total,        :guint64,
>>>>>>          :user,         :guint64,
>>>>>>          :nice,         :guint64,
>>>>>>          :sys,          :guint64,
>>>>>>          :idle,         :guint64,
>>>>>>          :iowait,       :guint64,
>>>>>>          :irq,          :guint64,
>>>>>>          :softirq,      :guint64,
>>>>>>          :frequency,    :guint64,
>>>>>>          :xcpu_total,   :guint64,
>>>>>>          :xcpu_user,    :guint64,
>>>>>>          :xcpu_nice,    :guint64,
>>>>>>          :xcpu_sys,     :guint64,
>>>>>>          :xcpu_idle,    :guint64,
>>>>>>          :xcpu_iowait,  :guint64,
>>>>>>          :xcpu_irq,     :guint64,
>>>>>>          :xcpu_softirq, :guint64,
>>>>>>          :xcpu_flags,   :guint64
>>>>>> end
>>>>>>
>>>>>> module LibGtop
>>>>>>   
>>>>>>   extend FFI::Library
>>>>>>   ffi_lib 'libgtop-2.0'
>>>>>>   attach_function :glibtop_get_cpu, [:pointer], :void
>>>>>>
>>>>>> end
>>>>>>
>>>>>> # taken from https://github.com/ffi/ffi/**wiki/Structs<https://github.com/ffi/ffi/wiki/Structs>
>>>>>> pointer = FFI::MemoryPointer.new :byte, GlibtopCpu.size, false
>>>>>> a = GlibtopCpu.new pointer
>>>>>> p LibGtop.glibtop_get_cpu(a)
>>>>>>
>>>>>> Executing this gives (unsurprisingly) an error:
>>>>>>
>>>>>> $ ruby lib/lib_gtop.rb 
>>>>>> /home/izietto/.rbenv/versions/**2.0.0-p0/lib/ruby/gems/2.0.0/**
>>>>>> gems/ffi-1.4.0/lib/ffi/types.**rb:57:in `find_type': unable to 
>>>>>> resolve type 'guint64' (TypeError)
>>>>>>     from /home/izietto/.rbenv/versions/**
>>>>>> 2.0.0-p0/lib/ruby/gems/2.0.0/**gems/ffi-1.4.0/lib/ffi/struct.**rb:316:in 
>>>>>> `find_type'
>>>>>>     from /home/izietto/.rbenv/versions/**
>>>>>> 2.0.0-p0/lib/ruby/gems/2.0.0/**gems/ffi-1.4.0/lib/ffi/struct.**rb:309:in 
>>>>>> `find_field_type'
>>>>>>     from /home/izietto/.rbenv/versions/**
>>>>>> 2.0.0-p0/lib/ruby/gems/2.0.0/**gems/ffi-1.4.0/lib/ffi/struct.**rb:351:in 
>>>>>> `array_layout'
>>>>>>     from /home/izietto/.rbenv/versions/**
>>>>>> 2.0.0-p0/lib/ruby/gems/2.0.0/**gems/ffi-1.4.0/lib/ffi/struct.**rb:261:in 
>>>>>> `layout'
>>>>>>     from lib/lib_gtop.rb:4:in `<class:GlibtopCpu>'
>>>>>>     from lib/lib_gtop.rb:3:in `<main>'
>>>>>>
>>>>>> It doesn't find the guint64 type; how should I declare it?
>>>>>>
>>>>>> Also: xcpu_total, xcpu_user are arrays... how should I declare them?
>>>>>>
>>>>>> Finally... if someone could give me an explanation and an example of 
>>>>>> how to implement the bind to glibtop_get_cpu, I would appreciate it very 
>>>>>> much :) -- 
>>>>>>  
>>>>>> --- 
>>>>>>  You received this message because you are subscribed to the Google 
>>>>>> Groups "ruby-ffi" group.
>>>>>> To unsubscribe from this group and stop receiving emails from it, 
>>>>>> send an email to ruby-ffi+u...@**googlegroups.com. 
>>>>>>
>>>>>> For more options, visit https://groups.google.com/**groups/opt_out<https://groups.google.com/groups/opt_out>
>>>>>> .
>>>>>>  
>>>>>>  
>>>>>>  
>>>>>>  
>>>>>>
>>>>>> -- 
>>>>>> Blog: http://postmodern.github.com/
>>>>>> GitHub: https://github.com/postmodern
>>>>>> Twitter: @postmodern_mod3
>>>>>> PGP: 0xB9515E77
>>>>>>
>>>>>>   
>>>>>  -- 
>>>>>  
>>>>> --- 
>>>>> You received this message because you are subscribed to the Google 
>>>>> Groups "ruby-ffi" group.
>>>>> To unsubscribe from this group and stop receiving emails from it, send 
>>>>> an email to ruby-ffi+u...@**googlegroups.com.
>>>>>
>>>>> For more options, visit https://groups.google.com/**groups/opt_out<https://groups.google.com/groups/opt_out>
>>>>> .
>>>>>  
>>>>>  
>>>>>
>>>>>
>>>>>
>>>>> -- 
>>>>> Blog: http://postmodern.github.com/
>>>>> GitHub: https://github.com/postmodern
>>>>> Twitter: @postmodern_mod3
>>>>> PGP: 0xB9515E77
>>>>>
>>>>>    
>>>>    
>>>  -- 
>>>  
>>> --- 
>>> You received this message because you are subscribed to the Google 
>>> Groups "ruby-ffi" group.
>>> To unsubscribe from this group and stop receiving emails from it, send 
>>> an email to ruby-ffi+u...@**googlegroups.com.
>>>
>>> For more options, visit https://groups.google.com/**groups/opt_out<https://groups.google.com/groups/opt_out>
>>> .
>>>  
>>>  
>>>
>>>
>>>
>>> -- 
>>> Blog: http://postmodern.github.com/
>>> GitHub: https://github.com/postmodern
>>> Twitter: @postmodern_mod3
>>> PGP: 0xB9515E77
>>>
>>>   -- 
>>  
>> --- 
>> You received this message because you are subscribed to a topic in the 
>> Google Groups "ruby-ffi" group.
>> To unsubscribe from this topic, visit 
>> https://groups.google.com/d/topic/ruby-ffi/sG-TsAHcWiM/unsubscribe?hl=en.
>> To unsubscribe from this group and all its topics, send an email to 
>> ruby-ffi+u...@googlegroups.com <javascript:>.
>>
>> For more options, visit https://groups.google.com/groups/opt_out.
>>  
>>  
>>
>
>

-- 

--- 
You received this message because you are subscribed to the Google Groups "ruby-ffi" group.
To unsubscribe from this group and stop receiving emails from it, send an email to ruby-ffi+unsubscribe@googlegroups.com.
For more options, visit https://groups.google.com/groups/opt_out.



------=_Part_450_25269614.1362990040812
Content-Type: text/html; charset=ISO-8859-1
Content-Transfer-Encoding: quoted-printable

<div><br></div>Isn't it libglib-2.0.so ?<div><br></div><div>i.e. try:</div>=
<div><br></div><div>&nbsp; ffi_lib 'glib-2.0'</div><div><br></div><div>If y=
ou just want to try and see if a library can be found by FFI, use this:</di=
v><div><br></div><div>&nbsp; ruby -rffi -e 'FFI::DynamicLibrary.open("libgl=
ib-2.0.so", FFI::DynamicLibrary::RTLD_LAZY | FFI::DynamicLibrary::RTLD_LOCA=
L)'<br></div><div><br></div><div><br></div><div>As for the pointer result, =
NULL is handled fine - just use Pointer#null? to check if the return value =
is NULL.</div><div><br><br>On Monday, 11 March 2013 02:50:27 UTC+10, Mauriz=
io De Santis  wrote:<blockquote class=3D"gmail_quote" style=3D"margin: 0;ma=
rgin-left: 0.8ex;border-left: 1px #ccc solid;padding-left: 1ex;"><div dir=
=3D"ltr"><div><div>Thank you, the porting is going well; if you want you ca=
n see the progress at <a href=3D"https://github.com/ProGNOMmers/gtop" targe=
t=3D"_blank">https://github.com/<wbr>ProGNOMmers/gtop</a> .<br><br></div>No=
w I have some troubles: I need to use <span style=3D"font-family:courier ne=
w,monospace">g_free</span> from <span style=3D"font-family:courier new,mono=
space">glib</span>, so I tried to wrap it:<br>

<br><span style=3D"font-family:courier new,monospace">require 'gtop'<br><br=
>module GTop<br>&nbsp; module GLib<br>&nbsp;&nbsp;&nbsp; extend FFI::Librar=
y<br>&nbsp;&nbsp;&nbsp; ffi_lib 'libglib2.0'<br><br>&nbsp;&nbsp;&nbsp; type=
def :pointer, :gpointer<br><br>
&nbsp;&nbsp;&nbsp; attach_function :g_free, [:gpointer], :void<br>
&nbsp; end<br>end</span><br><br>On my pc <a href=3D"http://libglib2.0.so" t=
arget=3D"_blank">libglib2.0.so</a> is located inside /usr/lib/x86_64-linux-=
gnu/ , which should be found since it is inside the ld paths, which on my m=
achine are<br><br><span style=3D"font-family:courier new,monospace"># Multi=
arch support<br>

/lib/i386-linux-gnu<br>/usr/lib/i386-linux-gnu<br>/lib/i686-linux-gnu<br>/u=
sr/lib/i686-linux-gnu<br># libc default configuration<br>/usr/local/lib<br>=
/usr/lib/nvidia-settings<br># Multiarch support<br>/lib/x86_64-linux-gnu<br=
>

/usr/lib/x86_64-linux-gnu<br>/usr/lib/x86_64-linux-gnu/mesa</span><br><br><=
/div><div>but I get a LoadError:<br><br><span style=3D"font-family:courier =
new,monospace">Could not open library 'libglib2.0': libglib2.0: cannot open=
 shared object file: No such file or directory.<br>

Could not open library '<a href=3D"http://libglib2.0.so" target=3D"_blank">=
libglib2.0.so</a>': <a href=3D"http://libglib2.0.so" target=3D"_blank">libg=
lib2.0.so</a>: cannot open shared object file: No such file or directory<br=
>/home/user/.rbenv/versions/2.<wbr>0.0-p0/lib/ruby/gems/2.0.0/<wbr>gems/ffi=
-1.4.0/lib/ffi/<wbr>library.rb:123:in `block in ffi_lib'<br>

/home/user/.rbenv/versions/2.<wbr>0.0-p0/lib/ruby/gems/2.0.0/<wbr>gems/ffi-=
1.4.0/lib/ffi/<wbr>library.rb:90:in `map'<br>/home/user/.rbenv/versions/2.<=
wbr>0.0-p0/lib/ruby/gems/2.0.0/<wbr>gems/ffi-1.4.0/lib/ffi/<wbr>library.rb:=
90:in `ffi_lib'<br>

/home/user/github/me/gtop/lib/<wbr>gtop/glib.rb:6:in `&lt;module:GLib&gt;'<=
br>/home/user/github/me/gtop/lib/<wbr>gtop/glib.rb:4:in `&lt;module:GTop&gt=
;'<br>/home/user/github/me/gtop/lib/<wbr>gtop/glib.rb:3:in `&lt;top (requir=
ed)&gt;'<br>

/home/user/.rbenv/versions/2.<wbr>0.0-p0/lib/ruby/site_ruby/2.0.<wbr>0/ruby=
gems/core_ext/kernel_<wbr>require.rb:45:in `require'<br>/home/user/.rbenv/v=
ersions/2.<wbr>0.0-p0/lib/ruby/site_ruby/2.0.<wbr>0/rubygems/core_ext/kerne=
l_<wbr>require.rb:45:in `require'<br>

/home/user/github/me/gtop/lib/<wbr>gtop.rb:7:in `&lt;module:GTop&gt;'<br>/h=
ome/user/github/me/gtop/lib/<wbr>gtop.rb:3:in `&lt;top (required)&gt;'<br>/=
home/user/.rbenv/versions/2.<wbr>0.0-p0/lib/ruby/site_ruby/2.0.<wbr>0/rubyg=
ems/core_ext/kernel_<wbr>require.rb:45:in `require'<br>

/home/user/.rbenv/versions/2.<wbr>0.0-p0/lib/ruby/site_ruby/2.0.<wbr>0/ruby=
gems/core_ext/kernel_<wbr>require.rb:45:in `require'<br>/home/user/github/m=
e/gtop/<wbr>Rakefile:4:in `block in &lt;top (required)&gt;'<br>/home/user/.=
rbenv/versions/2.<wbr>0.0-p0/lib/ruby/gems/2.0.0/<wbr>gems/rake-10.0.3/lib/=
rake/<wbr>task.rb:228:in `call'<br>

/home/user/.rbenv/versions/2.<wbr>0.0-p0/lib/ruby/gems/2.0.0/<wbr>gems/rake=
-10.0.3/lib/rake/<wbr>task.rb:228:in `block in execute'<br>/home/user/.rben=
v/versions/2.<wbr>0.0-p0/lib/ruby/gems/2.0.0/<wbr>gems/rake-10.0.3/lib/rake=
/<wbr>task.rb:223:in `each'<br>

/home/user/.rbenv/versions/2.<wbr>0.0-p0/lib/ruby/gems/2.0.0/<wbr>gems/rake=
-10.0.3/lib/rake/<wbr>task.rb:223:in `execute'<br>/home/user/.rbenv/version=
s/2.<wbr>0.0-p0/lib/ruby/gems/2.0.0/<wbr>gems/rake-10.0.3/lib/rake/<wbr>tas=
k.rb:166:in `block in invoke_with_call_chain'<br>

/home/user/.rbenv/versions/2.<wbr>0.0-p0/lib/ruby/2.0.0/monitor.<wbr>rb:211=
:in `mon_synchronize'<br>/home/user/.rbenv/versions/2.<wbr>0.0-p0/lib/ruby/=
gems/2.0.0/<wbr>gems/rake-10.0.3/lib/rake/<wbr>task.rb:159:in `invoke_with_=
call_chain'<br>

/home/user/.rbenv/versions/2.<wbr>0.0-p0/lib/ruby/gems/2.0.0/<wbr>gems/rake=
-10.0.3/lib/rake/<wbr>task.rb:152:in `invoke'<br>/home/user/.rbenv/versions=
/2.<wbr>0.0-p0/lib/ruby/gems/2.0.0/<wbr>gems/rake-10.0.3/lib/rake/<wbr>appl=
ication.rb:143:in `invoke_task'<br>

/home/user/.rbenv/versions/2.<wbr>0.0-p0/lib/ruby/gems/2.0.0/<wbr>gems/rake=
-10.0.3/lib/rake/<wbr>application.rb:101:in `block (2 levels) in top_level'=
<br>/home/user/.rbenv/versions/2.<wbr>0.0-p0/lib/ruby/gems/2.0.0/<wbr>gems/=
rake-10.0.3/lib/rake/<wbr>application.rb:101:in `each'<br>

/home/user/.rbenv/versions/2.<wbr>0.0-p0/lib/ruby/gems/2.0.0/<wbr>gems/rake=
-10.0.3/lib/rake/<wbr>application.rb:101:in `block in top_level'<br>/home/u=
ser/.rbenv/versions/2.<wbr>0.0-p0/lib/ruby/gems/2.0.0/<wbr>gems/rake-10.0.3=
/lib/rake/<wbr>application.rb:110:in `run_with_threads'<br>

/home/user/.rbenv/versions/2.<wbr>0.0-p0/lib/ruby/gems/2.0.0/<wbr>gems/rake=
-10.0.3/lib/rake/<wbr>application.rb:95:in `top_level'<br>/home/user/.rbenv=
/versions/2.<wbr>0.0-p0/lib/ruby/gems/2.0.0/<wbr>gems/rake-10.0.3/lib/rake/=
<wbr>application.rb:73:in `block in run'<br>

/home/user/.rbenv/versions/2.<wbr>0.0-p0/lib/ruby/gems/2.0.0/<wbr>gems/rake=
-10.0.3/lib/rake/<wbr>application.rb:160:in `standard_exception_handling'<b=
r>/home/user/.rbenv/versions/2.<wbr>0.0-p0/lib/ruby/gems/2.0.0/<wbr>gems/ra=
ke-10.0.3/lib/rake/<wbr>application.rb:70:in `run'<br>

/home/user/.rbenv/versions/2.<wbr>0.0-p0/lib/ruby/gems/2.0.0/<wbr>gems/rake=
-10.0.3/bin/rake:33:<wbr>in `&lt;top (required)&gt;'<br>/home/user/.rbenv/v=
ersions/2.<wbr>0.0-p0/bin/rake:23:in `load'<br>/home/user/.rbenv/versions/2=
.<wbr>0.0-p0/bin/rake:23:in `&lt;main&gt;'</span><br>

<br></div><div>I tried to set LD_LIBRARY_PATH too, but without success.<br>=
<br></div><div>Oh, and I have another doubt: gpointer is the return value o=
f `glibtop_get_proclist', and can be either `NULL' on error or a `unsigned =
*' list of pids.<br>

</div><div>I defined it as :pointer, it is correct? could the NULL value gi=
ve problems? should I manage it?<br></div></div><div><br clear=3D"all"><div=
>--<div><br>Maurizio De Santis</div></div>
<br><br><div class=3D"gmail_quote">2013/3/5 Wayne Meissner <span dir=3D"ltr=
">&lt;<a href=3D"javascript:" target=3D"_blank" gdf-obfuscated-mailto=3D"0N=
353i9_t6cJ">wmei...@gmail.com</a>&gt;</span><br><blockquote class=3D"gmail_=
quote" style=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1=
ex">

<div><br></div>:buffer_in, and :buffer_out are optimization hints for VMs w=
hen they need to copy data from VM heap memory to native memory:<div><br></=
div><div>:buffer_in means "allocate some temporary native memory, copy the =
contents of this object to it, then pass the temporary memory address to th=
e function"</div>

<div><br></div><div><div>:buffer_out means "allocate some temporary native =
memory, pass that address to the function, then afterwards, copy the conten=
ts of the temporary memory area back to the VM heap object"</div>

</div><div><br></div><div>:pointer and :buffer_inout are analogous and mean=
 "do both of the above" - i.e. copies both in to and out of the temporary m=
emory area.</div><div><br></div><div>If you're using a MemoryPointer as you=
r memory (as Struct does), then it is already native, so it doesn't matter,=
 so you can just use :pointer.</div>

<div><br></div><div>The original rationale behind the :buffer_in and :buffe=
r_out directives was that allocating VM heap objects is really cheap, and m=
ost VMs have a very hard time managing native memory allocations. &nbsp;So =
from an implementation point of view, it was better to bias towards VM heap=
 allocations and copy data in/out of temporary native memory. &nbsp;Thats w=
here FFI::Buffer came from - it was VM heap memory that was always copied t=
o/from native memory when passed as a parameter.</div>

<div><br></div><div>In practice, people found it difficult and confusing to=
 understand, so I just made native allocation management work as best it co=
uld in JRuby-1.7.</div><div><br></div><div><br></div><div>tl;dr - just use =
:pointer - it will work just fine, at an occasional minor performance penal=
ty.</div>

<div><br></div><div><br></div><div><div>On Monday, 4 March 2013 11:45:38 UT=
C+10, Postmodern  wrote:</div><blockquote class=3D"gmail_quote" style=3D"ma=
rgin:0;margin-left:0.8ex;border-left:1px #ccc solid;padding-left:1ex">


 =20
   =20
 =20
  <div bgcolor=3D"#FFFFFF" text=3D"#000000"><div>
    <div>You want :pointer in this case. I
      believe :buffer_out is a meant as a hint to FFI that data will be
      written back into an Array of chars/ints.<br>
      <br>
      On 03/03/2013 05:41 PM, Maurizio De Santis wrote:<br>
    </div>
    </div><blockquote type=3D"cite"><div>
      <div dir=3D"ltr">
        <div>
          <div>Another question: <span style=3D"font-family:courier new,mon=
ospace">glibtop_get_cpu</span> takes a struct as
            parameter, and fills it with informations about cpu.<br>
            <br>
          </div>
          I declared it as <br>
          <br>
          <span style=3D"font-family:courier new,monospace">attach_function
            :glibtop_get_cpu, [:pointer], :void</span><br>
          <br>
        </div>
        I think I can substitute <span style=3D"font-family:courier new,mon=
ospace">:pointer</span> with <span style=3D"font-family:courier new,monospa=
ce">:buffer_out</span> ,
        am I right?<br>
      </div>
      </div><div><br clear=3D"all">
        <div>--
          <div><br>
            Maurizio De Santis</div>
        </div>
        <br>
        <br>
        <div class=3D"gmail_quote">2013/3/4 Maurizio De Santis <span dir=3D=
"ltr">&lt;<a>desantis...@gmail.com</a>&gt;</span><br>
          <blockquote class=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;bord=
er-left:1px #ccc solid;padding-left:1ex"><div>
            <div dir=3D"ltr">Thank you a lot, your suggestions are
              precious.<br>
            </div>
            </div><div>
              <div>
                <div><br clear=3D"all">
                  <div>--
                    <div><br>
                      Maurizio De Santis</div>
                  </div>
                  <br>
                  <br>
                  <div class=3D"gmail_quote">2013/3/3 postmodern <span dir=
=3D"ltr">&lt;<a>postmod...@gmail.com</a>&gt;</span><br>
                    <blockquote class=3D"gmail_quote" style=3D"margin:0 0 0=
 .8ex;border-left:1px #ccc solid;padding-left:1ex">
                      <div bgcolor=3D"#FFFFFF" text=3D"#000000"><div><div>
                        <div>You can simplify that code to just:<br>
                          <blockquote>
                            <pre><span style=3D"font-family:courier new,mon=
ospace">a =3D LibGtop::GlibtopCpu.new
LibGtop.glibtop_get_cpu(a)
p a[:frequency]</span></pre>
                          </blockquote>
                          This will allocate memory for a GlibtopCpu
                          struct, pass the pointer to the memory to
                          glibtop_get_cpu and access to the struct field
                          within the memory. Once you are done with the
                          "a" variable, Ruby will just GC it and FFI
                          will free the underlying memory.
                          <div>
                            <div><br>
                              <br>
                              On 03/02/2013 07:54 PM, Maurizio De Santis
                              wrote:<br>
                            </div>
                          </div>
                        </div>
                        </div></div><div>
                          <div>
                            <blockquote type=3D"cite"><div><div>
                              <div dir=3D"ltr">
                                <div>
                                  <div>Thank you. Now, the code runs
                                    without errors:<br>
                                    <br>
                                    <span style=3D"font-family:courier new,=
monospace">require 'ffi'<br>
                                      <br>
                                      module LibGtop<br>
                                      &nbsp; <br>
                                      &nbsp; extend FFI::Library<br>
                                      &nbsp; ffi_lib 'libgtop-2.0'<br>
                                      <br>
                                      &nbsp; typedef :uint64, :guint64<br>
                                      <br>
                                      &nbsp; attach_function
                                      :glibtop_get_cpu, [:pointer],
                                      :void<br>
                                      <br>
                                      &nbsp; class GlibtopCpu &lt;
                                      FFI::Struct<br>
                                      &nbsp;&nbsp;&nbsp; layout :flags,&nbs=
p;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                      :guint64,<br>
                                      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&=
nbsp;&nbsp;&nbsp;&nbsp; :total,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&n=
bsp;
                                      :guint64,<br>
                                      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&=
nbsp;&nbsp;&nbsp;&nbsp; :user,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nb=
sp;&nbsp;
                                      :guint64,<br>
                                      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&=
nbsp;&nbsp;&nbsp;&nbsp; :nice,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nb=
sp;&nbsp;
                                      :guint64,<br>
                                      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&=
nbsp;&nbsp;&nbsp;&nbsp; :sys,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbs=
p;&nbsp;&nbsp;
                                      :guint64,<br>
                                      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&=
nbsp;&nbsp;&nbsp;&nbsp; :idle,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nb=
sp;&nbsp;
                                      :guint64,<br>
                                      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&=
nbsp;&nbsp;&nbsp;&nbsp; :iowait,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                      :guint64,<br>
                                      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&=
nbsp;&nbsp;&nbsp;&nbsp; :irq,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbs=
p;&nbsp;&nbsp;
                                      :guint64,<br>
                                      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&=
nbsp;&nbsp;&nbsp;&nbsp; :softirq,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                      :guint64,<br>
                                      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&=
nbsp;&nbsp;&nbsp;&nbsp; :frequency,&nbsp;&nbsp;&nbsp;&nbsp;
                                      :guint64,<br>
                                      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&=
nbsp;&nbsp;&nbsp;&nbsp; :xcpu_total,&nbsp;&nbsp;
                                      [:guint64, 32],<br>
                                      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&=
nbsp;&nbsp;&nbsp;&nbsp; :xcpu_user,&nbsp;&nbsp;&nbsp;
                                      [:guint64, 32],<br>
                                      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&=
nbsp;&nbsp;&nbsp;&nbsp; :xcpu_nice,&nbsp;&nbsp;&nbsp;
                                      [:guint64, 32],<br>
                                      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&=
nbsp;&nbsp;&nbsp;&nbsp; :xcpu_sys,&nbsp;&nbsp;&nbsp;&nbsp;
                                      [:guint64, 32],<br>
                                      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&=
nbsp;&nbsp;&nbsp;&nbsp; :xcpu_idle,&nbsp;&nbsp;&nbsp;
                                      [:guint64, 32],<br>
                                      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&=
nbsp;&nbsp;&nbsp;&nbsp; :xcpu_iowait,&nbsp;
                                      [:guint64, 32],<br>
                                      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&=
nbsp;&nbsp;&nbsp;&nbsp; :xcpu_irq,&nbsp;&nbsp;&nbsp;&nbsp;
                                      [:guint64, 32],<br>
                                      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&=
nbsp;&nbsp;&nbsp;&nbsp; :xcpu_softirq,
                                      [:guint64, 32],<br>
                                      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&=
nbsp;&nbsp;&nbsp;&nbsp; :xcpu_flags,&nbsp;&nbsp;&nbsp;
                                      :guint64<br>
                                      &nbsp; end<br>
                                      <br>
                                      end<br>
                                      <br>
                                      <br>
                                      # taken from <a href=3D"https://githu=
b.com/ffi/ffi/wiki/Structs" target=3D"_blank">https://github.com/ffi/ffi/<u=
></u>wik<wbr>i/Structs</a><br>
                                      pointer =3D FFI::MemoryPointer.new
                                      :uint64, LibGtop::GlibtopCpu.size,
                                      true<br>
                                      a =3D LibGtop::GlibtopCpu.new
                                      pointer<br>
                                      LibGtop.glibtop_get_cpu(a)<br>
                                      p a[:frequency]</span><br>
                                    <br>
                                  </div>
                                  Another question: I initialized the
                                  pointer with <span style=3D"font-family:c=
ourier new,monospace">clear =3D true</span>,
                                  because the struct pointed by the
                                  pointer gets filled by
                                  glibtop_get_cpu, and then must be
                                  managed by Ruby, since <span style=3D"fon=
t-family:courier new,monospace">glibtop_get_cpu<font face=3D"arial,helvetic=
a,sans-serif">
                                      just fills the struct. Am I wrong?</f=
ont></span><br>
                                </div>
                              </div>
                              </div></div><div><br clear=3D"all">
                                <div>--
                                  <div><br>
                                    Maurizio De Santis</div>
                                </div>
                                <br>
                                <br>
                                <div class=3D"gmail_quote">2013/3/3
                                  postmodern <span dir=3D"ltr">&lt;<a>postm=
od...@gmail.com</a>&gt;</span><br>
                                  <blockquote class=3D"gmail_quote" style=
=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex">
                                    <div bgcolor=3D"#FFFFFF" text=3D"#00000=
0"><div><div>
                                      <div>You need to find out
                                        guint64's underlying type, and
                                        create the typedef in Ruby:<br>
                                        <br>
                                        <blockquote>
                                          <pre>module <span style=3D"font-f=
amily:courier new,monospace">LibGtop</span>
  extend FFI::Library

  typedef :uint64, :guint64
end
</pre>
                                        </blockquote>
                                        <div>
                                          <div> <br>
                                            On 03/02/2013 06:06 PM,
                                            Maurizio De Santis wrote:<br>
                                          </div>
                                        </div>
                                      </div>
                                      </div></div><blockquote type=3D"cite"=
><div><div>
                                        <div>
                                          <div>I am writing a libgtop2
                                            wrapper using ffi in order
                                            to learn how to use ffi; I
                                            am new to ffi, so I have a
                                            lot of doubts.<br>
                                            <br>
                                            libgtop2 lets get system and
                                            processes informations (cpu
                                            usage, memory usage, ...).<br>
                                            <br>
                                            Here some informations about
                                            <span style=3D"font-family:cour=
ier new,monospace">glibtop_get_cpu</span>:<br>
                                            <br>
                                            <span style=3D"font-family:cour=
ier new,monospace">Library
                                              function
                                              `glibtop_get_cpu':<br>
                                              <br>
                                              &nbsp;&nbsp;&nbsp;&nbsp; void=
 glibtop_get_cpu
                                              (glibtop_cpu *buf);<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp; void
                                              glibtop_get_cpu_l (glibtop
                                              *server, glibtop_cpu
                                              *buf);<br>
                                              <br>
                                              &nbsp;&nbsp; Declaration of
                                              `glibtop_cpu' in
                                              `&lt;glibtop/cpu.h&gt;':<br>
                                              <br>
                                              &nbsp;&nbsp;&nbsp;&nbsp; type=
def struct
                                              _glibtop_cpu&nbsp;&nbsp;&nbsp=
;&nbsp;
                                              glibtop_cpu;<br>
                                              <br>
                                              &nbsp;&nbsp;&nbsp;&nbsp; stru=
ct _glibtop_cpu<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp; {<br=
>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp; guint64&nbsp;&nbsp; flags,<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; total,<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; user,<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nice,<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sys,<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; idle,<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; iowait,<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; irq,<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; softirq,<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; frequency,<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; xcpu_total
                                              [GLIBTOP_NCPU],<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; xcpu_user
                                              [GLIBTOP_NCPU],<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; xcpu_nice
                                              [GLIBTOP_NCPU],<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; xcpu_sys&nbsp;
                                              [GLIBTOP_NCPU],<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; xcpu_idle
                                              [GLIBTOP_NCPU],<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; xcpu_iowait
                                              [GLIBTOP_NCPU],<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; xcpu_irq
                                              [GLIBTOP_NCPU],<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; xcpu_softirq
                                              [GLIBTOP_NCPU],<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; xcpu_flags;<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp; };<b=
r>
                                              <br>
                                              ...</span><br>
                                            <br>
                                            <br>
                                            Here is what I wrote:<br>
                                            <span style=3D"font-family:cour=
ier new,monospace"><br>
                                              require 'ffi'<br>
                                              <br>
                                              class GlibtopCpu &lt;
                                              FFI::Struct<br>
                                              &nbsp; layout :flags,&nbsp;&n=
bsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                              :guint64,<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp; :total,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                              :guint64,<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp; :user,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                              :guint64,<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp; :nice,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                              :guint64,<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp; :sys,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&n=
bsp;
                                              :guint64,<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp; :idle,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                              :guint64,<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp; :iowait,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                              :guint64,<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp; :irq,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&n=
bsp;
                                              :guint64,<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp; :softirq,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                              :guint64,<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp; :frequency,&nbsp;&nbsp;&nbsp;
                                              :guint64,<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp; :xcpu_total,&nbsp;&nbsp;
                                              :guint64,<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp; :xcpu_user,&nbsp;&nbsp;&nbsp;
                                              :guint64,<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp; :xcpu_nice,&nbsp;&nbsp;&nbsp;
                                              :guint64,<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp; :xcpu_sys,&nbsp;&nbsp;&nbsp;&nbsp;
                                              :guint64,<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp; :xcpu_idle,&nbsp;&nbsp;&nbsp;
                                              :guint64,<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp; :xcpu_iowait,&nbsp;
                                              :guint64,<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp; :xcpu_irq,&nbsp;&nbsp;&nbsp;&nbsp;
                                              :guint64,<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp; :xcpu_softirq,
                                              :guint64,<br>
                                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp=
;&nbsp;&nbsp;&nbsp; :xcpu_flags,&nbsp;&nbsp;
                                              :guint64<br>
                                              end<br>
                                              <br>
                                              module LibGtop<br>
                                              &nbsp; <br>
                                              &nbsp; extend FFI::Library<br=
>
                                              &nbsp; ffi_lib 'libgtop-2.0'<=
br>
                                              &nbsp; attach_function
                                              :glibtop_get_cpu,
                                              [:pointer], :void<br>
                                              <br>
                                              end<br>
                                              <br>
                                              # taken from <a href=3D"https=
://github.com/ffi/ffi/wiki/Structs" target=3D"_blank">https://github.com/ff=
i/ffi/<u></u>wik<wbr>i/Structs</a><br>
                                              pointer =3D
                                              FFI::MemoryPointer.new
                                              :byte, GlibtopCpu.size,
                                              false<br>
                                              a =3D GlibtopCpu.new pointer<=
br>
                                              p
                                              LibGtop.glibtop_get_cpu(a)</s=
pan><br>
                                            <br>
                                            Executing this gives
                                            (unsurprisingly) an error:<br>
                                            <br>
                                            <span style=3D"font-family:cour=
ier new,monospace">$ ruby
                                              lib/lib_gtop.rb <br>
                                              /home/izietto/.rbenv/versions=
/<u></u><wbr>2.0.0-p0/lib/ruby/gems/2.0.0/<u></u>g<wbr>ems/ffi-1.4.0/lib/ff=
i/types.<u></u>rb<wbr>:57:in


                                              `find_type': unable to
                                              resolve type 'guint64'
                                              (TypeError)<br>
                                              &nbsp;&nbsp;&nbsp; from
                                              /home/izietto/.rbenv/versions=
/<u></u><wbr>2.0.0-p0/lib/ruby/gems/2.0.0/<u></u>g<wbr>ems/ffi-1.4.0/lib/ff=
i/struct.<u></u>r<wbr>b:316:in


                                              `find_type'<br>
                                              &nbsp;&nbsp;&nbsp; from
                                              /home/izietto/.rbenv/versions=
/<u></u><wbr>2.0.0-p0/lib/ruby/gems/2.0.0/<u></u>g<wbr>ems/ffi-1.4.0/lib/ff=
i/struct.<u></u>r<wbr>b:309:in


                                              `find_field_type'<br>
                                              &nbsp;&nbsp;&nbsp; from
                                              /home/izietto/.rbenv/versions=
/<u></u><wbr>2.0.0-p0/lib/ruby/gems/2.0.0/<u></u>g<wbr>ems/ffi-1.4.0/lib/ff=
i/struct.<u></u>r<wbr>b:351:in


                                              `array_layout'<br>
                                              &nbsp;&nbsp;&nbsp; from
                                              /home/izietto/.rbenv/versions=
/<u></u><wbr>2.0.0-p0/lib/ruby/gems/2.0.0/<u></u>g<wbr>ems/ffi-1.4.0/lib/ff=
i/struct.<u></u>r<wbr>b:261:in


                                              `layout'<br>
                                              &nbsp;&nbsp;&nbsp; from
                                              lib/lib_gtop.rb:4:in
                                              `&lt;class:GlibtopCpu&gt;'<br=
>
                                              &nbsp;&nbsp;&nbsp; from
                                              lib/lib_gtop.rb:3:in
                                              `&lt;main&gt;'</span><br>
                                            <br>
                                            It doesn't find the <span style=
=3D"font-family:courier new,monospace">guint64</span>
                                            type; how should I declare
                                            it?<br>
                                            <br>
                                            Also: <span style=3D"font-famil=
y:courier new,monospace">xcpu_total,
                                              xcpu_user<span style=3D"font-=
family:arial,sans-serif">
                                                are arrays... how should
                                                I declare them?<br>
                                                <br>
                                                Finally... if someone
                                                could give me an
                                                explanation and an
                                                example of how to
                                                implement the bind to
                                                glibtop_get_cpu, I would
                                                appreciate it very much
                                                :)</span></span> -- <br>
                                            &nbsp;<br>
                                            --- <br>
                                          </div>
                                        </div>
                                        You received this message
                                        because you are subscribed to
                                        the Google Groups "ruby-ffi"
                                        group.<br></div></div>
                                        To unsubscribe from this group
                                        and stop receiving emails from
                                        it, send an email to <a>ruby-ffi+u.=
..@<u></u>googlegroups.com</a><wbr>.
                                        <div><div><br>
                                          For more options, visit <a href=
=3D"https://groups.google.com/groups/opt_out" target=3D"_blank">https://gro=
ups.google.com/<u></u>grou<wbr>ps/opt_out</a>.<br>
                                          &nbsp;<br>
                                          &nbsp;<br>
                                        </div>
                                      </div></blockquote><div>
                                      <span><font color=3D"#888888"> <br>
                                          <br>
                                          <pre cols=3D"72">--=20
Blog: <a href=3D"http://postmodern.github.com/" target=3D"_blank">http://po=
stmodern.github.com/</a>
GitHub: <a href=3D"https://github.com/postmodern" target=3D"_blank">https:/=
/github.com/postmodern</a>
Twitter: @postmodern_mod3
PGP: 0xB9515E77</pre>
                                        </font></span></div></div>
                                  </blockquote>
                                </div>
                                <br>
                              </div><div>
                              -- <br>
                              &nbsp;<br>
                              --- <br>
                              You received this message because you are
                              subscribed to the Google Groups "ruby-ffi"
                              group.<br></div>
                              To unsubscribe from this group and stop
                              receiving emails from it, send an email to
                              <a>ruby-ffi+u...@<u></u>googlegroups.com</a><=
wbr>.<div><br>
                              For more options, visit <a href=3D"https://gr=
oups.google.com/groups/opt_out" target=3D"_blank">https://groups.google.com=
/<u></u>grou<wbr>ps/opt_out</a>.<br>
                              &nbsp;<br>
                              &nbsp;<br>
                            </div></blockquote><div>
                            <br>
                            <br>
                            <pre cols=3D"72">--=20
Blog: <a href=3D"http://postmodern.github.com/" target=3D"_blank">http://po=
stmodern.github.com/</a>
GitHub: <a href=3D"https://github.com/postmodern" target=3D"_blank">https:/=
/github.com/postmodern</a>
Twitter: @postmodern_mod3
PGP: 0xB9515E77</pre>
                          </div></div>
                        </div>
                      </div>
                    </blockquote>
                  </div>
                  <br>
                </div>
              </div>
            </div>
          </blockquote>
        </div>
        <br>
      </div><div>
      -- <br>
      &nbsp;<br>
      --- <br>
      You received this message because you are subscribed to the Google
      Groups "ruby-ffi" group.<br></div>
      To unsubscribe from this group and stop receiving emails from it,
      send an email to <a>ruby-ffi+u...@<u></u>googlegroups.com</a><wbr>.<d=
iv><br>
      For more options, visit <a href=3D"https://groups.google.com/groups/o=
pt_out" target=3D"_blank">https://groups.google.com/<u></u>grou<wbr>ps/opt_=
out</a>.<br>
      &nbsp;<br>
      &nbsp;<br>
    </div></blockquote><div>
    <br>
    <br>
    <pre cols=3D"72">--=20
Blog: <a href=3D"http://postmodern.github.com/" target=3D"_blank">http://po=
stmodern.github.com/</a>
GitHub: <a href=3D"https://github.com/postmodern" target=3D"_blank">https:/=
/github.com/postmodern</a>
Twitter: @postmodern_mod3
PGP: 0xB9515E77</pre>
  </div></div><span><font color=3D"#888888">

</font></span></blockquote></div><span><font color=3D"#888888">

<p></p>

-- <br>
&nbsp;<br>
--- <br>
You received this message because you are subscribed to a topic in the Goog=
le Groups "ruby-ffi" group.<br>
To unsubscribe from this topic, visit <a href=3D"https://groups.google.com/=
d/topic/ruby-ffi/sG-TsAHcWiM/unsubscribe?hl=3Den" target=3D"_blank">https:/=
/groups.google.com/d/<wbr>topic/ruby-ffi/sG-TsAHcWiM/<wbr>unsubscribe?hl=3D=
en</a>.<br>
To unsubscribe from this group and all its topics, send an email to <a href=
=3D"javascript:" target=3D"_blank" gdf-obfuscated-mailto=3D"0N353i9_t6cJ">r=
uby-ffi+u...@<wbr>googlegroups.com</a>.</font></span><div><div>

<br>
For more options, visit <a href=3D"https://groups.google.com/groups/opt_out=
" target=3D"_blank">https://groups.google.com/<wbr>groups/opt_out</a>.<br>
&nbsp;<br>
&nbsp;<br>
</div></div></blockquote></div><br></div>
</blockquote></div>

<p></p>

-- <br />
&nbsp;<br />
--- <br />
You received this message because you are subscribed to the Google Groups &=
quot;ruby-ffi&quot; group.<br />
To unsubscribe from this group and stop receiving emails from it, send an e=
mail to ruby-ffi+unsubscribe@googlegroups.com.<br />
For more options, visit <a href=3D"https://groups.google.com/groups/opt_out=
">https://groups.google.com/groups/opt_out</a>.<br />
&nbsp;<br />
&nbsp;<br />

------=_Part_450_25269614.1362990040812--
