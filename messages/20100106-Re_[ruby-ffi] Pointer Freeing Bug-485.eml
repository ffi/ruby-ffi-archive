Delivered-To: headius@headius.com
Received: by 10.100.164.20 with SMTP id m20cs89067ane;
        Wed, 6 Jan 2010 10:38:34 -0800 (PST)
Received: by 10.91.16.25 with SMTP id t25mr5134325agi.118.1262803113431;
        Wed, 06 Jan 2010 10:38:33 -0800 (PST)
Return-Path: <3p9hESwoJCBA1Ay81qBu3qw2qy1.s427ArE-vvyw44w1uw74A58.s42@listserv.bounces.google.com>
Received: from mail-yw0-f137.google.com (mail-yw0-f137.google.com [209.85.211.137])
        by mx.google.com with ESMTP id 10si49149752gxk.12.2010.01.06.10.38.32;
        Wed, 06 Jan 2010 10:38:32 -0800 (PST)
Received-SPF: pass (google.com: domain of 3p9hESwoJCBA1Ay81qBu3qw2qy1.s427ArE-vvyw44w1uw74A58.s42@listserv.bounces.google.com designates 209.85.211.137 as permitted sender) client-ip=209.85.211.137;
Authentication-Results: mx.google.com; spf=pass (google.com: domain of 3p9hESwoJCBA1Ay81qBu3qw2qy1.s427ArE-vvyw44w1uw74A58.s42@listserv.bounces.google.com designates 209.85.211.137 as permitted sender) smtp.mail=3p9hESwoJCBA1Ay81qBu3qw2qy1.s427ArE-vvyw44w1uw74A58.s42@listserv.bounces.google.com; dkim=pass (test mode) header.i=@googlegroups.com
Received: by ywh1 with SMTP id 1sf46450387ywh.22
        for <headius@headius.com>; Wed, 06 Jan 2010 10:38:32 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=googlegroups.com; s=beta;
        h=domainkey-signature:received:x-beenthere:received:received:received
         :received:received-spf:received:mime-version:received:in-reply-to
         :references:from:date:message-id:subject:to
         :x-original-authentication-results:x-original-sender:reply-to
         :precedence:mailing-list:list-id:list-post:list-help:list-archive
         :x-thread-url:x-message-url:sender:list-unsubscribe:list-subscribe
         :content-type:content-transfer-encoding;
        bh=nUFn+tE2K7amP63BjTlpuVmcz6enf85oTnnZddPI5Ow=;
        b=qT8Oew9As/y537NUuHi8GPPL3RKqNn0ufoZgMGpsm9vKFi0vZ+W6UeAj7AEcym8QGh
         ZLt3yjEl9WC4rBadr48iSmgfP/pWAoWtiIxUJjSNDKZEoJEkIqPS16fmvmeM1okk4gm6
         /yk43OwHiIohYtb3I8tWSNcuKuipFJx0b5l+U=
DomainKey-Signature: a=rsa-sha1; c=nofws;
        d=googlegroups.com; s=beta;
        h=x-beenthere:received-spf:mime-version:in-reply-to:references:from
         :date:message-id:subject:to:x-original-authentication-results
         :x-original-sender:reply-to:precedence:mailing-list:list-id
         :list-post:list-help:list-archive:x-thread-url:x-message-url:sender
         :list-unsubscribe:list-subscribe:content-type
         :content-transfer-encoding;
        b=di/uHeJb68SLevGb6D62dUe7G3wAZ8div/NFeD39ljTMCAyOQ57dfbLvdHT1P7ejvs
         mIfDd0HehKZ/XrKutPNlN7lad30EAaNlo2849gJ55o7/W1vdk15vAlBoXb0OkQafxOMZ
         7EZdba9wlsH+d6BqGPMMnEcmY6O2kH4+0m+rs=
Received: by 10.101.188.3 with SMTP id q3mr1245048anp.5.1262803111263;
        Wed, 06 Jan 2010 10:38:31 -0800 (PST)
X-BeenThere: ruby-ffi@googlegroups.com
Received: by 10.87.24.18 with SMTP id b18ls89794fgj.1.p; Wed, 06 Jan 2010 
	10:38:29 -0800 (PST)
Received: by 10.87.70.6 with SMTP id x6mr253711fgk.17.1262803105549;
        Wed, 06 Jan 2010 10:38:25 -0800 (PST)
Received: by 10.87.70.6 with SMTP id x6mr253710fgk.17.1262803105531;
        Wed, 06 Jan 2010 10:38:25 -0800 (PST)
Return-Path: <luislavena@gmail.com>
Received: from mail-fx0-f217.google.com (mail-fx0-f217.google.com [209.85.220.217])
        by gmr-mx.google.com with ESMTP id 17si2034843fxm.11.2010.01.06.10.38.24;
        Wed, 06 Jan 2010 10:38:24 -0800 (PST)
Received-SPF: pass (google.com: domain of luislavena@gmail.com designates 209.85.220.217 as permitted sender) client-ip=209.85.220.217;
Received: by mail-fx0-f217.google.com with SMTP id 9so15785663fxm.10
        for <ruby-ffi@googlegroups.com>; Wed, 06 Jan 2010 10:38:24 -0800 (PST)
MIME-Version: 1.0
Received: by 10.239.170.24 with SMTP id q24mr438103hbe.2.1262803104337; Wed, 
	06 Jan 2010 10:38:24 -0800 (PST)
In-Reply-To: <bd5613e0-04a8-45d5-8fd1-e6550cf11dd7@q4g2000yqm.googlegroups.com>
References: <bd5613e0-04a8-45d5-8fd1-e6550cf11dd7@q4g2000yqm.googlegroups.com>
From: Luis Lavena <luislavena@gmail.com>
Date: Wed, 6 Jan 2010 15:38:04 -0300
Message-ID: <71166b3b1001061038v70c253eajee397a0d56f6a20f@mail.gmail.com>
Subject: Re: [ruby-ffi] Pointer Freeing Bug
To: ruby-ffi@googlegroups.com
X-Original-Authentication-Results: gmr-mx.google.com; spf=pass (google.com: 
	domain of luislavena@gmail.com designates 209.85.220.217 as permitted sender) 
	smtp.mail=luislavena@gmail.com; dkim=pass (test mode) header.i=@gmail.com
X-Original-Sender: luislavena@gmail.com
Reply-To: ruby-ffi@googlegroups.com
Precedence: list
Mailing-list: list ruby-ffi@googlegroups.com; contact ruby-ffi+owners@googlegroups.com
List-ID: <ruby-ffi.googlegroups.com>
List-Post: <http://groups.google.com/group/ruby-ffi/post?hl=>, 
	<mailto:ruby-ffi@googlegroups.com>
List-Help: <http://groups.google.com/support/?hl=>, <mailto:ruby-ffi+help@googlegroups.com>
List-Archive: <http://groups.google.com/group/ruby-ffi?hl=>
X-Thread-Url: http://groups.google.com/group/ruby-ffi/t/9f891a35886cb969
X-Message-Url: http://groups.google.com/group/ruby-ffi/msg/330d14ee3445f51d
Sender: ruby-ffi@googlegroups.com
List-Unsubscribe: <http://groups.google.com/group/ruby-ffi/subscribe?hl=>, 
	<mailto:ruby-ffi+unsubscribe@googlegroups.com>
List-Subscribe: <http://groups.google.com/group/ruby-ffi/subscribe?hl=>, 
	<mailto:ruby-ffi+subscribe@googlegroups.com>
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: quoted-printable

On Wed, Jan 6, 2010 at 2:41 PM, JEG2 <james@graysoftinc.com> wrote:
> [...]
>
> I'm pretty sure I'm looking at a bug that's triggered during GC here.
>
> I thought the "ruby malloc" was a sign that Ruby is freeing up memory
> before it allocates more.
>
> Also, as I said, all of my tests work fine when run alone. =A0It's not
> until they are combined that the problem surfaces. =A0I assume it's the
> longer run triggering GC.
>
> Is this sounding right?
>
> I assume it almost has to be an FFI object being freed. =A0I mean, Ruby
> wouldn't try to free some memory allocated by Tokyo Cabinet, right?
> Are there FFI objects that try to free something as they are GCed?
>
> Any tips for the best way to isolate this issue are greatly
> appreciated.
>

What about forcing the garbage collect process on each spec?

That, in combination with running the specs in a verbose mode may
provide any indication of a individual test that is storing the
pointer in a variable that gets collected before it's time.

--=20
Luis Lavena
AREA 17
-
Perfection in design is achieved not when there is nothing more to add,
but rather when there is nothing more to take away.
Antoine de Saint-Exup=E9ry
