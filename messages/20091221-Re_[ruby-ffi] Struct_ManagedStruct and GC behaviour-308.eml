Delivered-To: headius@headius.com
Received: by 10.100.134.8 with SMTP id h8cs531224and;
        Mon, 21 Dec 2009 15:21:24 -0800 (PST)
Received: by 10.142.8.27 with SMTP id 27mr5302584wfh.77.1261437683896;
        Mon, 21 Dec 2009 15:21:23 -0800 (PST)
Return-Path: <38QIwSwkJCG8jZRVffaReTZNVY.PbZehOl-SSVTbbTYRTebhcf.PbZ@listserv.bounces.google.com>
Received: from mail-px0-f144.google.com (mail-px0-f144.google.com [209.85.216.144])
        by mx.google.com with ESMTP id 28si13588012pzk.27.2009.12.21.15.21.22;
        Mon, 21 Dec 2009 15:21:22 -0800 (PST)
Received-SPF: pass (google.com: domain of 38QIwSwkJCG8jZRVffaReTZNVY.PbZehOl-SSVTbbTYRTebhcf.PbZ@listserv.bounces.google.com designates 209.85.216.144 as permitted sender) client-ip=209.85.216.144;
Authentication-Results: mx.google.com; spf=pass (google.com: domain of 38QIwSwkJCG8jZRVffaReTZNVY.PbZehOl-SSVTbbTYRTebhcf.PbZ@listserv.bounces.google.com designates 209.85.216.144 as permitted sender) smtp.mail=38QIwSwkJCG8jZRVffaReTZNVY.PbZehOl-SSVTbbTYRTebhcf.PbZ@listserv.bounces.google.com; dkim=pass (test mode) header.i=@googlegroups.com
Received: by pxi8 with SMTP id 8sf3184750pxi.22
        for <headius@headius.com>; Mon, 21 Dec 2009 15:21:22 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=googlegroups.com; s=beta;
        h=domainkey-signature:received:x-beenthere:received:received:received
         :received:received-spf:received:mime-version:received:in-reply-to
         :references:date:message-id:subject:from:to
         :x-original-authentication-results:x-original-sender:reply-to
         :precedence:mailing-list:list-id:list-post:list-help:list-archive
         :x-thread-url:x-message-url:sender:list-unsubscribe:list-subscribe
         :content-type;
        bh=Sj3+1ZaLk1sqrVho8IL5nFjvmv5ZW1Gd0szB1vZnOyo=;
        b=dgPdNw4lojElDCVb31TqnI8Jw7sjXHQsbbmujewlgZheZ2g4EGg89fobaRU2EIx5nG
         KODKxO+qVrJLUN1QP5x5wC7zyEACX2DmIJS9cWlQrSa3b8eUfnUOZsIjkXr/b69LmVGp
         BiTH0KcyJc/nRZK7MA6k9I+gDsQi0vot7uLIY=
DomainKey-Signature: a=rsa-sha1; c=nofws;
        d=googlegroups.com; s=beta;
        h=x-beenthere:received-spf:mime-version:in-reply-to:references:date
         :message-id:subject:from:to:x-original-authentication-results
         :x-original-sender:reply-to:precedence:mailing-list:list-id
         :list-post:list-help:list-archive:x-thread-url:x-message-url:sender
         :list-unsubscribe:list-subscribe:content-type;
        b=lbvvkWwideCBR2Zk/LQ+wbaTgTrdCko+awkyj206ekKqfRrI0vPEJRtfhxOqBP6p7E
         Rl7X9kqA3Qy6Pu55YkGn6zo4Ocnm0Dt+sQTSy+xF1KG4kMDzr/pWWr5zpQmmZmVF2PW3
         SvQlzbnfKD97U+E1/YG9V44xrIz2fNIlY+lFk=
Received: by 10.141.124.10 with SMTP id b10mr939478rvn.7.1261437681558;
        Mon, 21 Dec 2009 15:21:21 -0800 (PST)
X-BeenThere: ruby-ffi@googlegroups.com
Received: by 10.141.139.11 with SMTP id r11ls800873rvn.3.p; Mon, 21 Dec 2009 
	15:21:20 -0800 (PST)
Received: by 10.141.124.15 with SMTP id b15mr1556634rvn.9.1261437680778;
        Mon, 21 Dec 2009 15:21:20 -0800 (PST)
Received: by 10.141.124.15 with SMTP id b15mr1556633rvn.9.1261437680754;
        Mon, 21 Dec 2009 15:21:20 -0800 (PST)
Return-Path: <wmeissner@gmail.com>
Received: from mail-px0-f176.google.com (mail-px0-f176.google.com [209.85.216.176])
        by gmr-mx.google.com with ESMTP id 18si1490256pzk.9.2009.12.21.15.21.19;
        Mon, 21 Dec 2009 15:21:19 -0800 (PST)
Received-SPF: pass (google.com: domain of wmeissner@gmail.com designates 209.85.216.176 as permitted sender) client-ip=209.85.216.176;
Received: by pxi6 with SMTP id 6so2056115pxi.0
        for <ruby-ffi@googlegroups.com>; Mon, 21 Dec 2009 15:21:19 -0800 (PST)
MIME-Version: 1.0
Received: by 10.141.125.7 with SMTP id c7mr5558088rvn.262.1261437679642; Mon, 
	21 Dec 2009 15:21:19 -0800 (PST)
In-Reply-To: <4ccee320912211400t18af822coe605c5353cea0950@mail.gmail.com>
References: <20091221152637.62654e37.jon.forums@gmail.com>
	 <4ccee320912211400t18af822coe605c5353cea0950@mail.gmail.com>
Date: Tue, 22 Dec 2009 09:21:19 +1000
Message-ID: <4ccee320912211521r47522a8q1905e1da000cab07@mail.gmail.com>
Subject: Re: [ruby-ffi] Struct/ManagedStruct and GC behaviour
From: Wayne Meissner <wmeissner@gmail.com>
To: ruby-ffi@googlegroups.com
X-Original-Authentication-Results: gmr-mx.google.com; spf=pass (google.com: 
	domain of wmeissner@gmail.com designates 209.85.216.176 as permitted sender) 
	smtp.mail=wmeissner@gmail.com; dkim=pass (test mode) header.i=@gmail.com
X-Original-Sender: wmeissner@gmail.com
Reply-To: ruby-ffi@googlegroups.com
Precedence: list
Mailing-list: list ruby-ffi@googlegroups.com; contact ruby-ffi+owners@googlegroups.com
List-ID: <ruby-ffi.googlegroups.com>
List-Post: <http://groups.google.com/group/ruby-ffi/post?hl=>, 
	<mailto:ruby-ffi@googlegroups.com>
List-Help: <http://groups.google.com/support/?hl=>, <mailto:ruby-ffi+help@googlegroups.com>
List-Archive: <http://groups.google.com/group/ruby-ffi?hl=>
X-Thread-Url: http://groups.google.com/group/ruby-ffi/t/509f727c52cb337
X-Message-Url: http://groups.google.com/group/ruby-ffi/msg/1082be6d4be88557
Sender: ruby-ffi@googlegroups.com
List-Unsubscribe: <http://groups.google.com/group/ruby-ffi/subscribe?hl=>, 
	<mailto:ruby-ffi+unsubscribe@googlegroups.com>
List-Subscribe: <http://groups.google.com/group/ruby-ffi/subscribe?hl=>, 
	<mailto:ruby-ffi+subscribe@googlegroups.com>
Content-Type: text/plain; charset=ISO-8859-1

2009/12/22 Wayne Meissner <wmeissner@gmail.com>:

>  # s can now be collected, the backing memory proxy can be collected,
> which will free the
>  # allocated native memory.

I should have added a footnote that just because it *can* be
collected, there is in fact no guarantee that objects are in fact ever
collected by the GC.  Depending on the implementation, there might not
be sufficient ruby/java memory pressure to cause a GC event, so the
objects are not collected, and the native memory is never freed.

Automated management of native memory is a no-win situation:

If we have it in FFI core, then people will (ab)use it and rely on it
when they really should not.

If we do not have it in core, people will implement them anyway, and
instead of a single known implementation,  there will be a dozen
crappy, broken implementations of the concept, and people will still
abuse these implementations and rely upon them when they should not.

MemoryPointer and AutoPointer are in FFI core because I thought that
was the lesser of two evils.

(and, most instances are small and short lived, so there is enough
object churn to cause a GC event, so the negative effects haven't
massively bitten anyone).

In hindsight, I would probably have just two types of memory - purely
passive native pointers, and ruby heap allocated memory with
copy-in/copy-out to transient native memory semantics.  Structs would
implicitly use the ruby heap memory, unless an explicit native pointer
was passed to the constructor.

People should peruse e.g. the nokogiri FFI backend, and figure out how
one would rewrite it with explicit memory management, before proposing
solutions to the problem.
