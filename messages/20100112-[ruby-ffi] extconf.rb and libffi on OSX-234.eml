Delivered-To: headius@headius.com
Received: by 10.100.164.20 with SMTP id m20cs32745ane;
        Tue, 12 Jan 2010 10:38:40 -0800 (PST)
Received: by 10.150.127.23 with SMTP id z23mr42270760ybc.179.1263321520635;
        Tue, 12 Jan 2010 10:38:40 -0800 (PST)
Return-Path: <3rsFMSw4JCAg0quwv.i.kpqivoouiqt.kwuz2j6-nnqowwotmozw2x0.kwu@listserv.bounces.google.com>
Received: from mail-yw0-f137.google.com (mail-yw0-f137.google.com [209.85.211.137])
        by mx.google.com with ESMTP id 37si41157397ywh.117.2010.01.12.10.38.39;
        Tue, 12 Jan 2010 10:38:39 -0800 (PST)
Received-SPF: pass (google.com: domain of 3rsFMSw4JCAg0quwv.i.kpqivoouiqt.kwuz2j6-nnqowwotmozw2x0.kwu@listserv.bounces.google.com designates 209.85.211.137 as permitted sender) client-ip=209.85.211.137;
Authentication-Results: mx.google.com; spf=pass (google.com: domain of 3rsFMSw4JCAg0quwv.i.kpqivoouiqt.kwuz2j6-nnqowwotmozw2x0.kwu@listserv.bounces.google.com designates 209.85.211.137 as permitted sender) smtp.mail=3rsFMSw4JCAg0quwv.i.kpqivoouiqt.kwuz2j6-nnqowwotmozw2x0.kwu@listserv.bounces.google.com; dkim=pass (test mode) header.i=@googlegroups.com
Received: by ywh1 with SMTP id 1sf59493479ywh.22
        for <headius@headius.com>; Tue, 12 Jan 2010 10:38:39 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=googlegroups.com; s=beta;
        h=domainkey-signature:received:x-beenthere:received:received:received
         :received:received-spf:received:mime-version:received:date:x-ip
         :user-agent:x-http-useragent:message-id:subject:from:to
         :x-original-authentication-results:x-original-sender:reply-to
         :precedence:mailing-list:list-id:list-post:list-help:list-archive
         :x-thread-url:x-message-url:sender:list-unsubscribe:list-subscribe
         :content-type;
        bh=dV39af5y3yKCHJRrdnPAb/1RQVBD/6B5FmUrqUaiPW4=;
        b=rNZcQczgrP8HeTVMM8PGXnDJ1yw0vWjZdOUc/vX/j97Zzf4zgsldECXp0hrzApL3Uw
         Y38AkW24kXp796f6AD9Vs4CVSHRBWnahFv5it18VH6/06ynjXWQCjyYRhFWWb8Td1sTK
         /MtVj8CI6ZVOd7H28daX3d7wUKa6Ledc6KQD4=
DomainKey-Signature: a=rsa-sha1; c=nofws;
        d=googlegroups.com; s=beta;
        h=x-beenthere:received-spf:mime-version:date:x-ip:user-agent
         :x-http-useragent:message-id:subject:from:to
         :x-original-authentication-results:x-original-sender:reply-to
         :precedence:mailing-list:list-id:list-post:list-help:list-archive
         :x-thread-url:x-message-url:sender:list-unsubscribe:list-subscribe
         :content-type;
        b=nMMwSeEq7SXeecjaY0jfjEj6cmZkcdl6Qa7vRAxee1UWkrurnlcmZl2eMHl2iii//o
         aPK8ghIQcyoiDyOjL7c4hjLIlnPCyFc0+6WhzOCYo9WnL9BwGCIXzbVsF7N2Behgn91g
         FP8DTTxUH1FdGUEiU3lxWuMirjIfAo9vS2fdE=
Received: by 10.150.250.2 with SMTP id x2mr262256ybh.76.1263321518442;
        Tue, 12 Jan 2010 10:38:38 -0800 (PST)
X-BeenThere: ruby-ffi@googlegroups.com
Received: by 10.150.46.36 with SMTP id t36ls180800ybt.0.p; Tue, 12 Jan 2010 
	10:38:36 -0800 (PST)
Received: by 10.151.87.15 with SMTP id p15mr37401766ybl.26.1263321516733;
        Tue, 12 Jan 2010 10:38:36 -0800 (PST)
Received: by 10.151.87.15 with SMTP id p15mr37401763ybl.26.1263321516659;
        Tue, 12 Jan 2010 10:38:36 -0800 (PST)
Return-Path: <simon.a.chiang@gmail.com>
Received: from mail-yw0-f145.google.com (mail-yw0-f145.google.com [209.85.211.145])
        by gmr-mx.google.com with ESMTP id 17si4552676gxk.4.2010.01.12.10.38.36;
        Tue, 12 Jan 2010 10:38:36 -0800 (PST)
Received-SPF: pass (google.com: domain of simon.a.chiang@gmail.com designates 209.85.211.145 as permitted sender) client-ip=209.85.211.145;
Received: by mail-yw0-f145.google.com with SMTP id 9so7160393ywh.14
        for <ruby-ffi@googlegroups.com>; Tue, 12 Jan 2010 10:38:36 -0800 (PST)
MIME-Version: 1.0
Received: by 10.101.180.10 with SMTP id h10mr3419589anp.48.1263321516550; Tue, 
	12 Jan 2010 10:38:36 -0800 (PST)
Date: Tue, 12 Jan 2010 10:38:36 -0800 (PST)
X-IP: 65.125.146.33
User-Agent: G2/1.0
X-HTTP-UserAgent: Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.5; en-US; 
	rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7,gzip(gfe),gzip(gfe)
Message-ID: <e2392b2d-e07f-4846-abe2-b7acb34184d1@u7g2000yqm.googlegroups.com>
Subject: [ruby-ffi] extconf.rb and libffi on OSX
From: Simon Chiang <simon.a.chiang@gmail.com>
To: ruby-ffi <ruby-ffi@googlegroups.com>
X-Original-Authentication-Results: gmr-mx.google.com; spf=pass (google.com: 
	domain of simon.a.chiang@gmail.com designates 209.85.211.145 as permitted 
	sender) smtp.mail=simon.a.chiang@gmail.com
X-Original-Sender: simon.a.chiang@gmail.com
Reply-To: ruby-ffi@googlegroups.com
Precedence: list
Mailing-list: list ruby-ffi@googlegroups.com; contact ruby-ffi+owners@googlegroups.com
List-ID: <ruby-ffi.googlegroups.com>
List-Post: <http://groups.google.com/group/ruby-ffi/post?hl=>, 
	<mailto:ruby-ffi@googlegroups.com>
List-Help: <http://groups.google.com/support/?hl=>, <mailto:ruby-ffi+help@googlegroups.com>
List-Archive: <http://groups.google.com/group/ruby-ffi?hl=>
X-Thread-Url: http://groups.google.com/group/ruby-ffi/t/b657c9a1990332ba
X-Message-Url: http://groups.google.com/group/ruby-ffi/msg/cc7ee484158d4d55
Sender: ruby-ffi@googlegroups.com
List-Unsubscribe: <http://groups.google.com/group/ruby-ffi/subscribe?hl=>, 
	<mailto:ruby-ffi+unsubscribe@googlegroups.com>
List-Subscribe: <http://groups.google.com/group/ruby-ffi/subscribe?hl=>, 
	<mailto:ruby-ffi+subscribe@googlegroups.com>
Content-Type: text/plain; charset=ISO-8859-1

I'm trying to use the unreleased 0.6 version of FFI and I'm having an
issue that I ultimately tracked back to this part of extconf.rb:

  unless Config::CONFIG['host_os'] =~ /mswin32|mingw32/
    if pkg_config("libffi") || find_header("ffi.h", "/usr/local/
include")

      # We need at least ffi_call and ffi_prep_closure
      libffi_ok = have_library("ffi", "ffi_call", [ "ffi.h" ]) &&
have_func("ffi_prep_closure")

      # Check if the raw api is available.
      $defs << "-DHAVE_RAW_API" if have_func("ffi_raw_call") &&
have_func("ffi_prep_raw_closure")
    end
  end

Apparently I need to access the raw api and so I think I need -
DHAVE_RAW_API to be set. When I modify extconf.rb to enable that flag,
everything works on OSX 10.5.8 but it still doesn't work on OSX
10.6.2.

By looking at the commits where this code was introduced, I gather
this code is about detecting a functional libffi. So is libffi broke
on OSX or does it vary between 10.5.8 and 10.6.2 in some way that
causes FFI problems? Do I need to update libffi?

Thanks.

Relevant commits:

http://github.com/ffi/ffi/commit/8cbc3f54a875a61e1fb67ac88a25b71940a3ed91
http://github.com/ffi/ffi/commit/31e65abbf7e57b9776557227a41e4cd45886c986
