<html>
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>[ruby-ffi] Re: Segfault when using threads</title>
<link rel="important stylesheet" href="">
<style>div.headerdisplayname {font-weight:bold;}</style></head>
<body>
<table border=0 cellspacing=0 cellpadding=0 width="100%" class="header-part1"><tr><td><div class="headerdisplayname" style="display:inline;">Subject: </div>[ruby-ffi] Re: Segfault when using threads</td></tr><tr><td><div class="headerdisplayname" style="display:inline;">From: </div>patrick.hemmer@gmail.com</td></tr><tr><td><div class="headerdisplayname" style="display:inline;">Date: </div>10/27/13 4:01 AM</td></tr></table><table border=0 cellspacing=0 cellpadding=0 width="100%" class="header-part2"><tr><td><div class="headerdisplayname" style="display:inline;">To: </div>ruby-ffi@googlegroups.com</td></tr></table><br>
<div class="moz-text-html"  lang="x-western"><div dir="ltr">So I managed to come up with a workaround, but it requires Ruby 2.0.<div>In Ruby 2.0, an environment variable, `RUBY_THREAD_MACHINE_STACK_SIZE`, was added. This variable controls the size of the stack allocated to threads. Since the default is 512kb, and corosync allocates a 1mb buffer, I set it to 1572864 (1.5mb). With this everything behaves normally :-)</div><div><br></div><div>-Patrick<br><br>On Saturday, October 26, 2013 5:46:49 PM UTC-4, Wayne Meissner wrote:<blockquote class="gmail_quote" style="margin: 0;margin-left: 0.8ex;border-left: 1px #ccc solid;padding-left: 1ex;"><div dir="ltr"><div><br></div>The amount of debug info you provided, made it easy to track down whether other people had hit the same thing in other languages.<div><br></div><div>But, I think you're boned. &nbsp;Try and push to get that patch included in corosync, since thats the only real solution.</div><div><br></div><div>You *could* do something like compiling a lib that runs the dispatch thread on a custom pthread with an increased stack, but then you run into the tricky situation of other threads also hitting that code path, and blowing up.<br><br>On Sunday, 27 October 2013 07:15:41 UTC+11, <a>patrick...@gmail.com</a>  wrote:<blockquote class="gmail_quote" style="margin:0;margin-left:0.8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir="ltr"><div>I could have sworn when I tried doing everything on the thread that it worked. But I just tried it again and it segfaults.</div><div><br></div><div>When I look at ruby's source code, it looks like it allocates a 512kb stack for threads. When I go into corosync and look at the size of the buffer it's allocating on the stack, it's 1mb.</div><div>So the reason it works on the main thread is that the main thread has an 8mb stack.</div><div><br></div><div>I don't suppose there's any way to work around this behavior? If not I'm fairly well hosed and can only run cpg_dispatch on the main thread :-(</div><div><br></div><div>Thank you for that. I don't know that I would have found that otherwise.<br></div><div><br></div><div>-Patrick</div><div><br></div><div><br>On Saturday, October 26, 2013 8:06:14 AM UTC-4, Wayne Meissner wrote:<blockquote class="gmail_quote" style="margin:0;margin-left:0.8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir="ltr"><div><br></div><div>Try moving all the initialization into the new thread as well, to isolate any cross-threading issues (some libraries have thread-local data, so if you init an object on one thread, but access from another, it could be only partially initialized).</div><div><br></div><div>If that *still* segfaults, then it could be the library - see <a href="http://lists.corosync.org/pipermail/discuss/2013-April/002514.html" target="_blank">http://lists.corosync.org/<wbr>pipermail/discuss/2013-April/<wbr>002514.html</a></div><div>&nbsp;- non-main threads get a smaller and fixed size stack, whereas the main thread gets a growable stack.</div><div><br></div><div><br></div><div><br><br>On Saturday, 26 October 2013 16:15:25 UTC+11, <a>patrick...@gmail.com</a>  wrote:<blockquote class="gmail_quote" style="margin:0;margin-left:0.8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir="ltr">Ok, the subject probably sounds like I've got some variable not being locked or whatnot, but I highly doubt that's the case :-)<div><br></div><div>So, what I've got going on is that I'm developing a gem for interfacing with <a href="http://corosync.github.io/corosync/" target="_blank">corosync</a>. In single threaded mode, it works perfectly. But as soon as I call the corosync library from within a thread, it blows up (sigsegv). The interesting part is that in my test case, I'm not even doing anything in the main thread other than waiting for the new thread to complete. No modifying of shared variables or anything.</div><div><br></div><div>This is the code:</div><div><blockquote class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex"><font face="courier new, monospace" color="#660000">require 'corosync/cpg'<br></font><font face="courier new, monospace" color="#660000">cpg = Corosync::CPG.new('mygroup')<br></font><font face="courier new, monospace" color="#660000">#cpg.dispatch(0) # this line runs perfectly<br></font><font face="courier new, monospace" color="#660000">Thread.new { cpg.dispatch(0) }.join # this line segfaults</font></blockquote></div><div><br></div><div>Move the comment from line 3 to line 4 and it runs fine.</div><div><br></div><div>This is the ruby stack trace:</div><div><blockquote class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex"><font face="courier new, monospace"><font color="#660000">test.rb:4:in `block in &lt;main&gt;'<br></font><font color="#660000">/home/phemmer/git/ruby-<wbr>corosync/lib/corosync/cpg.rb:<wbr>145:in `dispatch'<br></font><font color="#660000">/home/phemmer/git/ruby-<wbr>corosync/lib/corosync/cpg.rb:<wbr>145:in `cpg_dispatch'</font></font></blockquote></div><div><br></div><div><br></div><div>When I throw GDB on it, this is what the stack trace looks like:</div><div><blockquote class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex"><font face="courier new, monospace"><font color="#660000">[New Thread 0x7ffff7ff9700 (LWP 30441)]<br></font><font color="#660000">[New Thread 0x7ffff7ecf700 (LWP 30442)]<br></font><font color="#660000">[New Thread 0x7fffeef7b700 (LWP 30443)]</font><font color="#660000"><br></font><font color="#660000">Program received signal SIGSEGV, Segmentation fault.<br></font><font color="#660000">[Switching to Thread 0x7fffeef7b700 (LWP 30443)]<br></font><font color="#660000">0x00007fffefae4c86 in hdb_handle_get (instance=0x7fffeee78580, handle_in=7749363892505018368,<wbr>&nbsp;<br></font><font color="#660000">&nbsp; &nbsp; handle_database=0x7fffefce7060 &lt;cpg_handle_t_db&gt;) at ../include/corosync/hdb.h:110<br></font><font color="#660000">110<span style="white-space:pre">	</span>../include/corosync/hdb.h: No such file or directory.<br></font><font color="#660000">(gdb) where<br></font><font color="#660000">#0 &nbsp;0x00007fffefae4c86 in hdb_handle_get (instance=0x7fffeee78580, handle_in=7749363892505018368,<wbr>&nbsp;<br></font><font color="#660000">&nbsp; &nbsp; handle_database=0x7fffefce7060 &lt;cpg_handle_t_db&gt;) at ../include/corosync/hdb.h:110<br></font><font color="#660000">#1 &nbsp;cpg_dispatch (handle=7749363892505018368, dispatch_types=CS_DISPATCH_<wbr>ONE_NONBLOCKING)<br></font><font color="#660000">&nbsp; &nbsp; at cpg.c:357<br></font><font color="#660000">#2 &nbsp;0x00007fffefef1010 in ffi_call_unix64 () from /usr/lib64/libffi.so.6<br></font><font color="#660000">#3 &nbsp;0x00007fffefef0a8a in ffi_call () from /usr/lib64/libffi.so.6<br></font><font color="#660000">#4 &nbsp;0x00007ffff0101f3e in rbffi_CallFunction ()<br></font><font color="#660000">&nbsp; &nbsp;from /home/phemmer/.gem/ruby/1.9.1/<wbr>gems/ffi-1.9.0/lib/ffi_c.so<br></font><font color="#660000">#5 &nbsp;0x00007ffff0105956 in custom_trampoline ()<br></font><font color="#660000">&nbsp; &nbsp;from /home/phemmer/.gem/ruby/1.9.1/<wbr>gems/ffi-1.9.0/lib/ffi_c.so<br></font><font color="#660000">#6 &nbsp;0x00007ffff7af9898 in call_cfunc (func=0x7ffff7fee0d8, recv=9748160, len=-1, argc=2,&nbsp;<br></font><font color="#660000">&nbsp; &nbsp; argv=0x7fffeef7c070) at vm_insnhelper.c:317<br></font><font color="#660000">#7 &nbsp;0x00007ffff7afa1b6 in vm_call_cfunc (th=0x837840, reg_cfp=0x7fffef07beb0, num=2, recv=9748160,&nbsp;<br></font><font color="#660000">&nbsp; &nbsp; blockptr=0x0, me=0x87c420) at vm_insnhelper.c:404<br></font><font color="#660000">#8 &nbsp;0x00007ffff7afa893 in vm_call_method (th=0x837840, cfp=0x7fffef07beb0, num=2, blockptr=0x0,&nbsp;<br></font><font color="#660000">&nbsp; &nbsp; flag=0, id=15088, me=0x87c420, recv=9748160) at vm_insnhelper.c:530<br></font><font color="#660000">#9 &nbsp;0x00007ffff7b001ab in vm_exec_core (th=0x837840, initial=0) at insns.def:1018<br></font><font color="#660000">#10 0x00007ffff7b0d5a5 in vm_exec (th=0x837840) at vm.c:1236<br></font><font color="#660000">#11 0x00007ffff7b0beff in invoke_block_from_c (th=0x837840, block=0x607ad0, self=6711000, argc=0,&nbsp;<br></font><font color="#660000">&nbsp; &nbsp; argv=0xa8e7e8, blockptr=0x0, cref=0x0) at vm.c:640<br></font><font color="#660000">#12 0x00007ffff7b0c111 in rb_vm_invoke_proc (th=0x837840, proc=0x607ad0, self=6711000, argc=0,&nbsp;<br></font><font color="#660000">&nbsp; &nbsp; argv=0xa8e7e8, blockptr=0x0) at vm.c:686<br></font><font color="#660000">#13 0x00007ffff7b12eaa in thread_start_func_2 (th=0x837840, stack_start=0x7fffeef7c000)<br></font><font color="#660000">&nbsp; &nbsp; at thread.c:466<br></font><font color="#660000">#14 0x00007ffff7b11b88 in thread_start_func_1 (th_ptr=0x837840) at thread_pthread.c:657<br></font><font color="#660000">#15 0x00007ffff73ba03a in start_thread () from /lib64/libpthread.so.0<br></font><font color="#660000">#16 0x00007ffff76b740d in clone () from /lib64/libc.so.6</font></font></blockquote></div><div>(hdb_handle_get hdb.h:110 is found <a href="https://github.com/corosync/corosync/blob/v2.3.2/include/corosync/hdb.h#L110" target="_blank">here</a>)<br></div><div>(cpg_dispatch&nbsp;cpg.c:357 is found <a href="https://github.com/corosync/corosync/blob/v2.3.2/lib/cpg.c#L357" target="_blank">here</a>)<br></div><div><br></div><div><br></div><div>The corosync gem currently lives at <a href="http://github.com/phemmer/ruby-corosync" target="_blank">http://github.com/phemmer/<wbr>ruby-corosync</a></div><div>For the libraries, I'm running libffi 3.0.11,&nbsp;<a href="https://github.com/corosync/corosync/tree/v2.3.2" target="_blank">corosync 2.3.2</a>, and <a href="https://github.com/ClusterLabs/libqb/tree/v0.14.4" target="_blank">libqb 0.14.4</a>.</div><div>I'm using MRI ruby 1.9.3p448 and ffi gem 1.9.0.</div><div><br></div><div>Any ideas and help would be appreciated. I've been pounding my head on the desk all day long.</div><div><br></div><div>-Patrick</div></div></blockquote></div></div></blockquote></div></div></blockquote></div></div></blockquote></div></div>

<p></p>

-- <br />
&nbsp;<br />
--- <br />
You received this message because you are subscribed to the Google Groups &quot;ruby-ffi&quot; group.<br />
To unsubscribe from this group and stop receiving emails from it, send an email to ruby-ffi+unsubscribe@googlegroups.com.<br />
For more options, visit <a href="https://groups.google.com/groups/opt_out">https://groups.google.com/groups/opt_out</a>.<br />

</div></body>
</html>
</table></div>