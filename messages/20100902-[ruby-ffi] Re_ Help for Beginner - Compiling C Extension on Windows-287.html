<html>
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>[ruby-ffi] Re: Help for Beginner - Compiling C Extension on Windows</title>
<link rel="important stylesheet" href="">
<style>div.headerdisplayname {font-weight:bold;}</style></head>
<body>
<table border=0 cellspacing=0 cellpadding=0 width="100%" class="header-part1"><tr><td><div class="headerdisplayname" style="display:inline;">Subject: </div>[ruby-ffi] Re: Help for Beginner - Compiling C Extension on Windows</td></tr><tr><td><div class="headerdisplayname" style="display:inline;">From: </div>Karl <threadhead@gmail.com></td></tr><tr><td><div class="headerdisplayname" style="display:inline;">Date: </div>9/2/10 4:44 PM</td></tr></table><table border=0 cellspacing=0 cellpadding=0 width="100%" class="header-part2"><tr><td><div class="headerdisplayname" style="display:inline;">To: </div>ruby-ffi <ruby-ffi@googlegroups.com></td></tr></table><br>
<div class="moz-text-plain" wrap=true graphical-quote=true style="font-family: -moz-fixed; font-size: 12px;" lang="x-western"><pre wrap>

On Sep 2, 11:28 am, Luis Lavena <a class="moz-txt-link-rfc2396E" href="mailto:luislav...@gmail.com">&lt;luislav...@gmail.com&gt;</a> wrote:
</pre><blockquote type=cite style="color: #000000;"><pre wrap>
<span class="moz-txt-citetags">&gt; </span>On Thu, Sep 2, 2010 at 1:22 PM, Karl <a class="moz-txt-link-rfc2396E" href="mailto:threadh...@gmail.com">&lt;threadh...@gmail.com&gt;</a> wrote:
</pre><blockquote type=cite style="color: #000000;"><pre wrap>
<span class="moz-txt-citetags">&gt; &gt; </span>Boring Background:
<span class="moz-txt-citetags">&gt; &gt; </span>Let me say first that I'm no Windows expert and it's been 20 years
<span class="moz-txt-citetags">&gt; &gt; </span>since I last compiled anything I wrote in C. But I need to access an
<span class="moz-txt-citetags">&gt; &gt; </span>API on a Windows machine (controls a DAQ board) from Ruby. So I'm
<span class="moz-txt-citetags">&gt; &gt; </span>trying to get the first steps down, compiling a C lib I can access
<span class="moz-txt-citetags">&gt; &gt; </span>through ruby.
</pre></blockquote><pre wrap>
<span class="moz-txt-citetags">&gt;</span>
</pre><blockquote type=cite style="color: #000000;"><pre wrap>
<span class="moz-txt-citetags">&gt; &gt; </span>Also, I apologize if this is the wrong place to post, but it seems
<span class="moz-txt-citetags">&gt; &gt; </span>that this is the only forum that C extension writers on windows
<span class="moz-txt-citetags">&gt; &gt; </span>frequent.
</pre></blockquote><pre wrap>
<span class="moz-txt-citetags">&gt;</span>
<span class="moz-txt-citetags">&gt; </span>Hello Karl
<span class="moz-txt-citetags">&gt;</span>
<span class="moz-txt-citetags">&gt; </span>Ruby FFI aims to replace the need to compile an extension to access a
<span class="moz-txt-citetags">&gt; </span>library, please see the wiki:
<span class="moz-txt-citetags">&gt;</span>
<span class="moz-txt-citetags">&gt; </span><a class="moz-txt-link-freetext" href="http://wiki.github.com/ffi/ffi">http://wiki.github.com/ffi/ffi</a>
<span class="moz-txt-citetags">&gt;</span>
<span class="moz-txt-citetags">&gt; </span>With examples to access Windows API.
</pre></blockquote><pre wrap>

Yes, and I plan on using it. But I still need to create some custom C
code to process the 2M-10M data points generated by the DAQ board. I
could do it in ruby, but the speed would be very poor as I need to de-
bounce the analog input readings.

</pre><blockquote type=cite style="color: #000000;"><pre wrap>
<span class="moz-txt-citetags">&gt; </span>Going to respond your question anyhow, but please read the wiki.
</pre></blockquote><pre wrap>

And I did, many times. I even went to the point of doing everything on
my ubuntu box and everything works exactly as expected. Just when I
try it on WIN does is fail.

</pre><blockquote type=cite style="color: #000000;"><blockquote type=cite style="color: #000000;"><pre wrap>
<span class="moz-txt-citetags">&gt; &gt; </span>Can't Compile Simple C DLL:
<span class="moz-txt-citetags">&gt; &gt; </span>Installed Ruby 1.8.7-p302 from rubyinstaller.org (used the .exe).
<span class="moz-txt-citetags">&gt; &gt; </span>Installed DevKit-4.5.0-20100819-1536-sfx.exe from rubyinstaller.org
<span class="moz-txt-citetags">&gt; &gt; </span>Performed the devkit install, all it working (installing gems that
<span class="moz-txt-citetags">&gt; &gt; </span>require compiling work)
</pre></blockquote><pre wrap>
<span class="moz-txt-citetags">&gt;</span>
</pre><blockquote type=cite style="color: #000000;"><pre wrap>
<span class="moz-txt-citetags">&gt; &gt; </span>Also tried setup up 'fstab' using this site
<span class="moz-txt-citetags">&gt; &gt;</span><a class="moz-txt-link-freetext" href="http://geeksharp.com/2010/01/18/windows-ruby-native-gems-1-9-1/but">http://geeksharp.com/2010/01/18/windows-ruby-native-gems-1-9-1/but</a>
<span class="moz-txt-citetags">&gt; &gt; </span>nothing he shows looks remotely like my installation. So I set C:
<span class="moz-txt-citetags">&gt; &gt; </span>\devkit\etc\fstab to:
<span class="moz-txt-citetags">&gt; &gt; </span> C:/devkit/mingw/lib/gcc/mingw32/4.5.0  /mingw
</pre></blockquote><pre wrap>
<span class="moz-txt-citetags">&gt;</span>
<span class="moz-txt-citetags">&gt; </span>You don't need to modify the fstab.
<span class="moz-txt-citetags">&gt;</span>
<span class="moz-txt-citetags">&gt;</span>
<span class="moz-txt-citetags">&gt;</span>
<span class="moz-txt-citetags">&gt;</span>
<span class="moz-txt-citetags">&gt;</span>
<span class="moz-txt-citetags">&gt;</span>
<span class="moz-txt-citetags">&gt;</span>
</pre><blockquote type=cite style="color: #000000;"><pre wrap>
<span class="moz-txt-citetags">&gt; &gt; </span>Trying to compile the following:
<span class="moz-txt-citetags">&gt; &gt; </span>#stree.c
<span class="moz-txt-citetags">&gt; &gt; </span>#include &lt;ruby.h&gt;
</pre></blockquote><pre wrap>
<span class="moz-txt-citetags">&gt;</span>
</pre><blockquote type=cite style="color: #000000;"><pre wrap>
<span class="moz-txt-citetags">&gt; &gt; </span>static VALUE hello_world(VALUE klass)
<span class="moz-txt-citetags">&gt; &gt; </span>{
<span class="moz-txt-citetags">&gt; &gt; </span> return rb_str_new2("hello world");
<span class="moz-txt-citetags">&gt; &gt; </span>}
</pre></blockquote><pre wrap>
<span class="moz-txt-citetags">&gt;</span>
</pre><blockquote type=cite style="color: #000000;"><pre wrap>
<span class="moz-txt-citetags">&gt; &gt; </span>void Init_stree()
<span class="moz-txt-citetags">&gt; &gt; </span>{
<span class="moz-txt-citetags">&gt; &gt; </span> VALUE mStree = rb_define_module("Stree");
<span class="moz-txt-citetags">&gt; &gt; </span> rb_define_singleton_method(mStree, "hello_world", hello_world, 0);
<span class="moz-txt-citetags">&gt; &gt; </span>}
</pre></blockquote><pre wrap>
<span class="moz-txt-citetags">&gt;</span>
</pre><blockquote type=cite style="color: #000000;"><pre wrap>
<span class="moz-txt-citetags">&gt; &gt; </span>#extconf.rb
<span class="moz-txt-citetags">&gt; &gt; </span>require 'mkmf'
<span class="moz-txt-citetags">&gt; &gt; </span>create_makefile('stree/stree')
</pre></blockquote><pre wrap>
<span class="moz-txt-citetags">&gt;</span>
</pre><blockquote type=cite style="color: #000000;"><pre wrap>
<span class="moz-txt-citetags">&gt; &gt; </span>On the win machine I run: ruby extconf.rb
<span class="moz-txt-citetags">&gt; &gt; </span> creates the Makefile, no errors
</pre></blockquote><pre wrap>
<span class="moz-txt-citetags">&gt;</span>
</pre><blockquote type=cite style="color: #000000;"><pre wrap>
<span class="moz-txt-citetags">&gt; &gt; </span>I run: 'make' and receive the following:
<span class="moz-txt-citetags">&gt; &gt; </span> Compile the C Code to a DLL
<span class="moz-txt-citetags">&gt; &gt; </span> 'cl' is not recognized as an internal or external command, operable
<span class="moz-txt-citetags">&gt; &gt; </span>program or batch file.
<span class="moz-txt-citetags">&gt; &gt; </span> Could Not Find C:\rails\ext_test\stree\ext\stree\*.obj
<span class="moz-txt-citetags">&gt; &gt; </span> Done.
</pre></blockquote><pre wrap>
<span class="moz-txt-citetags">&gt;</span>
<span class="moz-txt-citetags">&gt; </span>You're using the wrong ruby to compile. Basically you're running Ruby
<span class="moz-txt-citetags">&gt; </span>compiled with mswin32 (Visual C) instead of RubyInstaller.
<span class="moz-txt-citetags">&gt;</span>
<span class="moz-txt-citetags">&gt; </span>It trying to look for cl indicates that rbconfig used by your ruby
<span class="moz-txt-citetags">&gt; </span>installation came from mswin32 version.
<span class="moz-txt-citetags">&gt;</span>
<span class="moz-txt-citetags">&gt; </span>So, either you installed RubyInstaller on top of another Ruby, or you
<span class="moz-txt-citetags">&gt; </span>modified anything in your installation.
<span class="moz-txt-citetags">&gt;</span>
<span class="moz-txt-citetags">&gt; </span>Please try a clean Ruby+DevKit installation.
<span class="moz-txt-citetags">&gt;</span>
<span class="moz-txt-citetags">&gt; </span>Also, please read the instructions at our wiki for details on DevKit
<span class="moz-txt-citetags">&gt; </span>installation.
<span class="moz-txt-citetags">&gt;</span>
<span class="moz-txt-citetags">&gt; </span><a class="moz-txt-link-freetext" href="http://github.com/oneclick/rubyinstaller/wiki/Development-Kit">http://github.com/oneclick/rubyinstaller/wiki/Development-Kit</a>
</pre></blockquote><pre wrap>

Honestly, I would have asked here unless I had read the wiki and tried
this many, many times.

Completely removed c:\ruby197 and c:\devkit, also remove all reference
in system environment PATH.

Installed ruby 1.8.7 with rubyinstaller.org.

Installed devkit following the instruction on the wiki, to the letter.
Ran .\devkitvars.bat

Did a 'gem install thin --platform=ruby' just to make sure things
compile... no errors.

Back my source directory: ruby extconf.rb (no errors)

Ran 'make' and I get the exact same error as above.


BTW, I do have VS8 Express installed. Is that causing the issue?

Also, I did a system search for ruby.exe and only one in c:\ruby187 is
found.

And I checked my rbconfig.rb (I can past the entire content if that
helps), all the references I see are to i585-pc-mingw32, mingw32, gcc,
but
   CONFIG["RUBY_SO_NAME"] = "msvcrt-ruby18"

That's the only reference not to mingw32 I see.


So, I'm still where I started.
</pre></div></body>
</html>
</table></div>