Delivered-To: headius@headius.com
Received: by 10.152.22.74 with SMTP id b10csp43845laf;
        Sun, 10 Mar 2013 09:50:50 -0700 (PDT)
X-Received: by 10.194.176.165 with SMTP id cj5mr2038283wjc.37.1362934250385;
        Sun, 10 Mar 2013 09:50:50 -0700 (PDT)
Return-Path: <ruby-ffi+bncBDF6F5MASYDRB2HT6KEQKGQEUZBW57Y@googlegroups.com>
Received: from mail-fa0-x23e.google.com (mail-fa0-x23e.google.com [2a00:1450:4001:c02::23e])
        by mx.google.com with ESMTPS id g8si22562181eem.103.2013.03.10.09.50.50
        (version=TLSv1 cipher=ECDHE-RSA-RC4-SHA bits=128/128);
        Sun, 10 Mar 2013 09:50:50 -0700 (PDT)
Received-SPF: pass (google.com: domain of ruby-ffi+bncBDF6F5MASYDRB2HT6KEQKGQEUZBW57Y@googlegroups.com designates 2a00:1450:4001:c02::23e as permitted sender)
Authentication-Results: mx.google.com;
       spf=pass (google.com: domain of ruby-ffi+bncBDF6F5MASYDRB2HT6KEQKGQEUZBW57Y@googlegroups.com designates 2a00:1450:4001:c02::23e as permitted sender) smtp.mail=ruby-ffi+bncBDF6F5MASYDRB2HT6KEQKGQEUZBW57Y@googlegroups.com;
       dkim=pass header.i=@gmail.com
Received: by mail-fa0-f62.google.com with SMTP id p1sf1499733fap.17
        for <headius@headius.com>; Sun, 10 Mar 2013 09:50:49 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=googlegroups.com; s=20120806;
        h=x-received:x-beenthere:x-received:received-spf:x-received
         :mime-version:in-reply-to:references:from:date:message-id:subject:to
         :x-original-sender:x-original-authentication-results:reply-to
         :precedence:mailing-list:list-id:x-google-group-id:list-post
         :list-help:list-archive:sender:list-subscribe:list-unsubscribe
         :content-type;
        bh=GWM2DILic+MgQMfrkdkgGPRdvYLhHGQzpXFdmRzXU2I=;
        b=O8nEXG2KDc4MsyuFT8/v2hqHZwAbQkMZ6DNGGeX7U+BjFjyLXT9JzdCaGoL/qZgcsD
         nxhEWwO0BsNicEJKybayT94Dh/+0GAHOha3XTnWNneSSlK+EJdqEXc7Ar1H8guHUuHUb
         6sTWP0It06NMvyWDe9K+KqF2UIdM8Y3NFAh6jx3ZOntdsDIpJ2IFzR1daFxpOhtqL6BS
         jHMlTiRjtGNaQzY/+15Me4Jf8NWN0hr92TPUslIKe2iN8r+yUpEa5gdgfxw1ucG8Dt7n
         bj8rIWr49HmsFs7/Mzq59SkfDhlGWnGW1dHVQs9mTFzwz7IHraRQPyt/2X+NEVywmfnw
         8gmA==
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20120113;
        h=x-received:x-beenthere:x-received:received-spf:x-received
         :mime-version:in-reply-to:references:from:date:message-id:subject:to
         :x-original-sender:x-original-authentication-results:reply-to
         :precedence:mailing-list:list-id:x-google-group-id:list-post
         :list-help:list-archive:sender:list-subscribe:list-unsubscribe
         :content-type;
        bh=GWM2DILic+MgQMfrkdkgGPRdvYLhHGQzpXFdmRzXU2I=;
        b=q4Mwj/DpcH5r1sfb7jJYhc+xX1WpR5QSkYVxW52us4CueJyoeX8pzcSuOP20KLudnh
         7//m4ptoOQYiIeFTu9XZ7mPve7A8gb/o5E1HnJpqN/TLwbjdlrCgBWgh0bcdonplkexn
         o8w2XEt1G9iKueZppyntRMpVpMXdjtoMP/2r5ZTnPwvW5ssEH6kLj2DacytRBXD/KGTT
         xp4N0BNBjBYltd+DVxDZVV3tzphYVTMLw5j+SvxtP39iAAtDGpPy/qkavUyaqovcsIfq
         DmchtiOC3f+4spe9zxhwqzo4drsMF58uJ2XmHlotxaskzOXyeZqFYz/acG/QbUnqEkQa
         U1lQ==
X-Received: by 10.180.96.40 with SMTP id dp8mr500817wib.0.1362934249563;
        Sun, 10 Mar 2013 09:50:49 -0700 (PDT)
X-BeenThere: ruby-ffi@googlegroups.com
Received: by 10.180.185.244 with SMTP id ff20ls370072wic.48.canary; Sun, 10
 Mar 2013 09:50:48 -0700 (PDT)
X-Received: by 10.180.76.235 with SMTP id n11mr1367715wiw.0.1362934248231;
        Sun, 10 Mar 2013 09:50:48 -0700 (PDT)
Received: from mail-we0-x235.google.com ([2a00:1450:400c:c03::235])
        by gmr-mx.google.com with ESMTPS id k1si296872wia.0.2013.03.10.09.50.48
        (version=TLSv1 cipher=ECDHE-RSA-RC4-SHA bits=128/128);
        Sun, 10 Mar 2013 09:50:48 -0700 (PDT)
Received-SPF: pass (google.com: domain of desantis.maurizio@gmail.com designates 2a00:1450:400c:c03::235 as permitted sender) client-ip=2a00:1450:400c:c03::235;
Received: by mail-we0-f181.google.com with SMTP id t44so2685964wey.26
        for <ruby-ffi@googlegroups.com>; Sun, 10 Mar 2013 09:50:48 -0700 (PDT)
X-Received: by 10.194.63.240 with SMTP id j16mr14401085wjs.45.1362934248084;
 Sun, 10 Mar 2013 09:50:48 -0700 (PDT)
MIME-Version: 1.0
Received: by 10.216.1.78 with HTTP; Sun, 10 Mar 2013 09:50:27 -0700 (PDT)
In-Reply-To: <e12edc65-9eab-4390-a263-38c47720dfbd@googlegroups.com>
References: <4a4d0927-7aea-4469-aa6f-d7763c7a2610@googlegroups.com>
 <5132B5C7.6070604@gmail.com> <CA+_M_JcXJ-wd1ZvqH7C3Xdk7QWTW=z+MvxLfNYPgPC2QgeT3og@mail.gmail.com>
 <5132D072.9060604@gmail.com> <CA+_M_Jf_ccD8O+9Pt90dBYy7KEvXgrFsjkBnzoax_SPBSmdbcA@mail.gmail.com>
 <CA+_M_JckNW58+dmW8Lza_XoXZskQ54A8Bx+oOp6ZOyFEJrjv=w@mail.gmail.com>
 <5133FCC2.6040403@gmail.com> <e12edc65-9eab-4390-a263-38c47720dfbd@googlegroups.com>
From: Maurizio De Santis <desantis.maurizio@gmail.com>
Date: Sun, 10 Mar 2013 17:50:27 +0100
Message-ID: <CA+_M_Jc2x-Xof4Kc=dscvnvMr1pvkC5tjyusnZCQFLW=GStpUQ@mail.gmail.com>
Subject: Re: [ruby-ffi] Passing a struct by value, and typedef
To: ruby-ffi@googlegroups.com
X-Original-Sender: desantis.maurizio@gmail.com
X-Original-Authentication-Results: gmr-mx.google.com;       spf=pass
 (google.com: domain of desantis.maurizio@gmail.com designates
 2a00:1450:400c:c03::235 as permitted sender) smtp.mail=desantis.maurizio@gmail.com;
       dkim=pass header.i=@gmail.com
Reply-To: ruby-ffi@googlegroups.com
Precedence: list
Mailing-list: list ruby-ffi@googlegroups.com; contact ruby-ffi+owners@googlegroups.com
List-ID: <ruby-ffi.googlegroups.com>
X-Google-Group-Id: 238405446264
List-Post: <http://groups.google.com/group/ruby-ffi/post?hl=en_US>, <mailto:ruby-ffi@googlegroups.com>
List-Help: <http://groups.google.com/support/?hl=en_US>, <mailto:ruby-ffi+help@googlegroups.com>
List-Archive: <http://groups.google.com/group/ruby-ffi?hl=en_US>
Sender: ruby-ffi@googlegroups.com
List-Subscribe: <http://groups.google.com/group/ruby-ffi/subscribe?hl=en_US>, <mailto:ruby-ffi+subscribe@googlegroups.com>
List-Unsubscribe: <http://groups.google.com/group/ruby-ffi/subscribe?hl=en_US>,
 <mailto:googlegroups-manage+238405446264+unsubscribe@googlegroups.com>
Content-Type: multipart/alternative; boundary=047d7ba97b72b59e7404d794db36

--047d7ba97b72b59e7404d794db36
Content-Type: text/plain; charset=ISO-8859-1

Thank you, the porting is going well; if you want you can see the progress
at https://github.com/ProGNOMmers/gtop .

Now I have some troubles: I need to use g_free from glib, so I tried to
wrap it:

require 'gtop'

module GTop
  module GLib
    extend FFI::Library
    ffi_lib 'libglib2.0'

    typedef :pointer, :gpointer

    attach_function :g_free, [:gpointer], :void
  end
end

On my pc libglib2.0.so is located inside /usr/lib/x86_64-linux-gnu/ , which
should be found since it is inside the ld paths, which on my machine are

# Multiarch support
/lib/i386-linux-gnu
/usr/lib/i386-linux-gnu
/lib/i686-linux-gnu
/usr/lib/i686-linux-gnu
# libc default configuration
/usr/local/lib
/usr/lib/nvidia-settings
# Multiarch support
/lib/x86_64-linux-gnu
/usr/lib/x86_64-linux-gnu
/usr/lib/x86_64-linux-gnu/mesa

but I get a LoadError:

Could not open library 'libglib2.0': libglib2.0: cannot open shared object
file: No such file or directory.
Could not open library 'libglib2.0.so': libglib2.0.so: cannot open shared
object file: No such file or directory
/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/ffi-1.4.0/lib/ffi/library.rb:123:in
`block in ffi_lib'
/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/ffi-1.4.0/lib/ffi/library.rb:90:in
`map'
/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/ffi-1.4.0/lib/ffi/library.rb:90:in
`ffi_lib'
/home/user/github/me/gtop/lib/gtop/glib.rb:6:in `<module:GLib>'
/home/user/github/me/gtop/lib/gtop/glib.rb:4:in `<module:GTop>'
/home/user/github/me/gtop/lib/gtop/glib.rb:3:in `<top (required)>'
/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/site_ruby/2.0.0/rubygems/core_ext/kernel_require.rb:45:in
`require'
/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/site_ruby/2.0.0/rubygems/core_ext/kernel_require.rb:45:in
`require'
/home/user/github/me/gtop/lib/gtop.rb:7:in `<module:GTop>'
/home/user/github/me/gtop/lib/gtop.rb:3:in `<top (required)>'
/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/site_ruby/2.0.0/rubygems/core_ext/kernel_require.rb:45:in
`require'
/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/site_ruby/2.0.0/rubygems/core_ext/kernel_require.rb:45:in
`require'
/home/user/github/me/gtop/Rakefile:4:in `block in <top (required)>'
/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/task.rb:228:in
`call'
/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/task.rb:228:in
`block in execute'
/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/task.rb:223:in
`each'
/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/task.rb:223:in
`execute'
/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/task.rb:166:in
`block in invoke_with_call_chain'
/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/2.0.0/monitor.rb:211:in
`mon_synchronize'
/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/task.rb:159:in
`invoke_with_call_chain'
/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/task.rb:152:in
`invoke'
/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/application.rb:143:in
`invoke_task'
/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/application.rb:101:in
`block (2 levels) in top_level'
/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/application.rb:101:in
`each'
/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/application.rb:101:in
`block in top_level'
/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/application.rb:110:in
`run_with_threads'
/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/application.rb:95:in
`top_level'
/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/application.rb:73:in
`block in run'
/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/application.rb:160:in
`standard_exception_handling'
/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/application.rb:70:in
`run'
/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/bin/rake:33:in
`<top (required)>'
/home/user/.rbenv/versions/2.0.0-p0/bin/rake:23:in `load'
/home/user/.rbenv/versions/2.0.0-p0/bin/rake:23:in `<main>'

I tried to set LD_LIBRARY_PATH too, but without success.

Oh, and I have another doubt: gpointer is the return value of
`glibtop_get_proclist', and can be either `NULL' on error or a `unsigned *'
list of pids.
I defined it as :pointer, it is correct? could the NULL value give
problems? should I manage it?

--

Maurizio De Santis


2013/3/5 Wayne Meissner <wmeissner@gmail.com>

>
> :buffer_in, and :buffer_out are optimization hints for VMs when they need
> to copy data from VM heap memory to native memory:
>
> :buffer_in means "allocate some temporary native memory, copy the contents
> of this object to it, then pass the temporary memory address to the
> function"
>
> :buffer_out means "allocate some temporary native memory, pass that
> address to the function, then afterwards, copy the contents of the
> temporary memory area back to the VM heap object"
>
> :pointer and :buffer_inout are analogous and mean "do both of the above" -
> i.e. copies both in to and out of the temporary memory area.
>
> If you're using a MemoryPointer as your memory (as Struct does), then it
> is already native, so it doesn't matter, so you can just use :pointer.
>
> The original rationale behind the :buffer_in and :buffer_out directives
> was that allocating VM heap objects is really cheap, and most VMs have a
> very hard time managing native memory allocations.  So from an
> implementation point of view, it was better to bias towards VM heap
> allocations and copy data in/out of temporary native memory.  Thats where
> FFI::Buffer came from - it was VM heap memory that was always copied
> to/from native memory when passed as a parameter.
>
> In practice, people found it difficult and confusing to understand, so I
> just made native allocation management work as best it could in JRuby-1.7.
>
>
> tl;dr - just use :pointer - it will work just fine, at an occasional minor
> performance penalty.
>
>
> On Monday, 4 March 2013 11:45:38 UTC+10, Postmodern wrote:
>
>>  You want :pointer in this case. I believe :buffer_out is a meant as a
>> hint to FFI that data will be written back into an Array of chars/ints.
>>
>> On 03/03/2013 05:41 PM, Maurizio De Santis wrote:
>>
>>  Another question: glibtop_get_cpu takes a struct as parameter, and
>> fills it with informations about cpu.
>>
>>  I declared it as
>>
>> attach_function :glibtop_get_cpu, [:pointer], :void
>>
>>  I think I can substitute :pointer with :buffer_out , am I right?
>>
>> --
>>
>> Maurizio De Santis
>>
>>
>> 2013/3/4 Maurizio De Santis <desantis...@gmail.com>
>>
>>> Thank you a lot, your suggestions are precious.
>>>
>>> --
>>>
>>> Maurizio De Santis
>>>
>>>
>>> 2013/3/3 postmodern <postmod...@gmail.com>
>>>
>>>>  You can simplify that code to just:
>>>>
>>>> a = LibGtop::GlibtopCpu.new
>>>> LibGtop.glibtop_get_cpu(a)
>>>> p a[:frequency]
>>>>
>>>>  This will allocate memory for a GlibtopCpu struct, pass the pointer to
>>>> the memory to glibtop_get_cpu and access to the struct field within the
>>>> memory. Once you are done with the "a" variable, Ruby will just GC it and
>>>> FFI will free the underlying memory.
>>>>
>>>>
>>>> On 03/02/2013 07:54 PM, Maurizio De Santis wrote:
>>>>
>>>>  Thank you. Now, the code runs without errors:
>>>>
>>>> require 'ffi'
>>>>
>>>> module LibGtop
>>>>
>>>>   extend FFI::Library
>>>>   ffi_lib 'libgtop-2.0'
>>>>
>>>>   typedef :uint64, :guint64
>>>>
>>>>   attach_function :glibtop_get_cpu, [:pointer], :void
>>>>
>>>>   class GlibtopCpu < FFI::Struct
>>>>     layout :flags,         :guint64,
>>>>            :total,         :guint64,
>>>>            :user,          :guint64,
>>>>            :nice,          :guint64,
>>>>            :sys,           :guint64,
>>>>            :idle,          :guint64,
>>>>            :iowait,        :guint64,
>>>>            :irq,           :guint64,
>>>>            :softirq,       :guint64,
>>>>            :frequency,     :guint64,
>>>>            :xcpu_total,   [:guint64, 32],
>>>>            :xcpu_user,    [:guint64, 32],
>>>>            :xcpu_nice,    [:guint64, 32],
>>>>            :xcpu_sys,     [:guint64, 32],
>>>>            :xcpu_idle,    [:guint64, 32],
>>>>            :xcpu_iowait,  [:guint64, 32],
>>>>            :xcpu_irq,     [:guint64, 32],
>>>>            :xcpu_softirq, [:guint64, 32],
>>>>            :xcpu_flags,    :guint64
>>>>   end
>>>>
>>>> end
>>>>
>>>>
>>>> # taken from https://github.com/ffi/ffi/**wiki/Structs<https://github.com/ffi/ffi/wiki/Structs>
>>>> pointer = FFI::MemoryPointer.new :uint64, LibGtop::GlibtopCpu.size, true
>>>> a = LibGtop::GlibtopCpu.new pointer
>>>> LibGtop.glibtop_get_cpu(a)
>>>> p a[:frequency]
>>>>
>>>>  Another question: I initialized the pointer with clear = true,
>>>> because the struct pointed by the pointer gets filled by glibtop_get_cpu,
>>>> and then must be managed by Ruby, since glibtop_get_cpu just fills the
>>>> struct. Am I wrong?
>>>>
>>>> --
>>>>
>>>> Maurizio De Santis
>>>>
>>>>
>>>> 2013/3/3 postmodern <postmod...@gmail.com>
>>>>
>>>>>  You need to find out guint64's underlying type, and create the
>>>>> typedef in Ruby:
>>>>>
>>>>>  module LibGtop
>>>>>   extend FFI::Library
>>>>>
>>>>>   typedef :uint64, :guint64
>>>>> end
>>>>>
>>>>>
>>>>> On 03/02/2013 06:06 PM, Maurizio De Santis wrote:
>>>>>
>>>>>  I am writing a libgtop2 wrapper using ffi in order to learn how to
>>>>> use ffi; I am new to ffi, so I have a lot of doubts.
>>>>>
>>>>> libgtop2 lets get system and processes informations (cpu usage, memory
>>>>> usage, ...).
>>>>>
>>>>> Here some informations about glibtop_get_cpu:
>>>>>
>>>>> Library function `glibtop_get_cpu':
>>>>>
>>>>>      void glibtop_get_cpu (glibtop_cpu *buf);
>>>>>      void glibtop_get_cpu_l (glibtop *server, glibtop_cpu *buf);
>>>>>
>>>>>    Declaration of `glibtop_cpu' in `<glibtop/cpu.h>':
>>>>>
>>>>>      typedef struct _glibtop_cpu     glibtop_cpu;
>>>>>
>>>>>      struct _glibtop_cpu
>>>>>      {
>>>>>          guint64   flags,
>>>>>              total,
>>>>>              user,
>>>>>              nice,
>>>>>              sys,
>>>>>              idle,
>>>>>              iowait,
>>>>>              irq,
>>>>>              softirq,
>>>>>              frequency,
>>>>>              xcpu_total [GLIBTOP_NCPU],
>>>>>              xcpu_user [GLIBTOP_NCPU],
>>>>>              xcpu_nice [GLIBTOP_NCPU],
>>>>>              xcpu_sys  [GLIBTOP_NCPU],
>>>>>              xcpu_idle [GLIBTOP_NCPU],
>>>>>              xcpu_iowait [GLIBTOP_NCPU],
>>>>>              xcpu_irq [GLIBTOP_NCPU],
>>>>>              xcpu_softirq [GLIBTOP_NCPU],
>>>>>              xcpu_flags;
>>>>>      };
>>>>>
>>>>> ...
>>>>>
>>>>>
>>>>> Here is what I wrote:
>>>>>
>>>>> require 'ffi'
>>>>>
>>>>> class GlibtopCpu < FFI::Struct
>>>>>   layout :flags,        :guint64,
>>>>>          :total,        :guint64,
>>>>>          :user,         :guint64,
>>>>>          :nice,         :guint64,
>>>>>          :sys,          :guint64,
>>>>>          :idle,         :guint64,
>>>>>          :iowait,       :guint64,
>>>>>          :irq,          :guint64,
>>>>>          :softirq,      :guint64,
>>>>>          :frequency,    :guint64,
>>>>>          :xcpu_total,   :guint64,
>>>>>          :xcpu_user,    :guint64,
>>>>>          :xcpu_nice,    :guint64,
>>>>>          :xcpu_sys,     :guint64,
>>>>>          :xcpu_idle,    :guint64,
>>>>>          :xcpu_iowait,  :guint64,
>>>>>          :xcpu_irq,     :guint64,
>>>>>          :xcpu_softirq, :guint64,
>>>>>          :xcpu_flags,   :guint64
>>>>> end
>>>>>
>>>>> module LibGtop
>>>>>
>>>>>   extend FFI::Library
>>>>>   ffi_lib 'libgtop-2.0'
>>>>>   attach_function :glibtop_get_cpu, [:pointer], :void
>>>>>
>>>>> end
>>>>>
>>>>> # taken from https://github.com/ffi/ffi/**wiki/Structs<https://github.com/ffi/ffi/wiki/Structs>
>>>>> pointer = FFI::MemoryPointer.new :byte, GlibtopCpu.size, false
>>>>> a = GlibtopCpu.new pointer
>>>>> p LibGtop.glibtop_get_cpu(a)
>>>>>
>>>>> Executing this gives (unsurprisingly) an error:
>>>>>
>>>>> $ ruby lib/lib_gtop.rb
>>>>> /home/izietto/.rbenv/versions/**2.0.0-p0/lib/ruby/gems/2.0.0/**
>>>>> gems/ffi-1.4.0/lib/ffi/types.**rb:57:in `find_type': unable to
>>>>> resolve type 'guint64' (TypeError)
>>>>>     from /home/izietto/.rbenv/versions/**2.0.0-p0/lib/ruby/gems/2.0.0/
>>>>> **gems/ffi-1.4.0/lib/ffi/struct.**rb:316:in `find_type'
>>>>>     from /home/izietto/.rbenv/versions/**2.0.0-p0/lib/ruby/gems/2.0.0/
>>>>> **gems/ffi-1.4.0/lib/ffi/struct.**rb:309:in `find_field_type'
>>>>>     from /home/izietto/.rbenv/versions/**2.0.0-p0/lib/ruby/gems/2.0.0/
>>>>> **gems/ffi-1.4.0/lib/ffi/struct.**rb:351:in `array_layout'
>>>>>     from /home/izietto/.rbenv/versions/**2.0.0-p0/lib/ruby/gems/2.0.0/
>>>>> **gems/ffi-1.4.0/lib/ffi/struct.**rb:261:in `layout'
>>>>>     from lib/lib_gtop.rb:4:in `<class:GlibtopCpu>'
>>>>>     from lib/lib_gtop.rb:3:in `<main>'
>>>>>
>>>>> It doesn't find the guint64 type; how should I declare it?
>>>>>
>>>>> Also: xcpu_total, xcpu_user are arrays... how should I declare them?
>>>>>
>>>>> Finally... if someone could give me an explanation and an example of
>>>>> how to implement the bind to glibtop_get_cpu, I would appreciate it very
>>>>> much :) --
>>>>>
>>>>> ---
>>>>>  You received this message because you are subscribed to the Google
>>>>> Groups "ruby-ffi" group.
>>>>> To unsubscribe from this group and stop receiving emails from it, send
>>>>> an email to ruby-ffi+u...@**googlegroups.com.
>>>>>
>>>>> For more options, visit https://groups.google.com/**groups/opt_out<https://groups.google.com/groups/opt_out>
>>>>> .
>>>>>
>>>>>
>>>>>
>>>>>
>>>>>
>>>>> --
>>>>> Blog: http://postmodern.github.com/
>>>>> GitHub: https://github.com/postmodern
>>>>> Twitter: @postmodern_mod3
>>>>> PGP: 0xB9515E77
>>>>>
>>>>>
>>>>  --
>>>>
>>>> ---
>>>> You received this message because you are subscribed to the Google
>>>> Groups "ruby-ffi" group.
>>>> To unsubscribe from this group and stop receiving emails from it, send
>>>> an email to ruby-ffi+u...@**googlegroups.com.
>>>>
>>>> For more options, visit https://groups.google.com/**groups/opt_out<https://groups.google.com/groups/opt_out>
>>>> .
>>>>
>>>>
>>>>
>>>>
>>>>
>>>> --
>>>> Blog: http://postmodern.github.com/
>>>> GitHub: https://github.com/postmodern
>>>> Twitter: @postmodern_mod3
>>>> PGP: 0xB9515E77
>>>>
>>>>
>>>
>>  --
>>
>> ---
>> You received this message because you are subscribed to the Google Groups
>> "ruby-ffi" group.
>> To unsubscribe from this group and stop receiving emails from it, send an
>> email to ruby-ffi+u...@**googlegroups.com.
>>
>> For more options, visit https://groups.google.com/**groups/opt_out<https://groups.google.com/groups/opt_out>
>> .
>>
>>
>>
>>
>>
>> --
>> Blog: http://postmodern.github.com/
>> GitHub: https://github.com/postmodern
>> Twitter: @postmodern_mod3
>> PGP: 0xB9515E77
>>
>>   --
>
> ---
> You received this message because you are subscribed to a topic in the
> Google Groups "ruby-ffi" group.
> To unsubscribe from this topic, visit
> https://groups.google.com/d/topic/ruby-ffi/sG-TsAHcWiM/unsubscribe?hl=en.
> To unsubscribe from this group and all its topics, send an email to
> ruby-ffi+unsubscribe@googlegroups.com.
>
> For more options, visit https://groups.google.com/groups/opt_out.
>
>
>

-- 

--- 
You received this message because you are subscribed to the Google Groups "ruby-ffi" group.
To unsubscribe from this group and stop receiving emails from it, send an email to ruby-ffi+unsubscribe@googlegroups.com.
For more options, visit https://groups.google.com/groups/opt_out.



--047d7ba97b72b59e7404d794db36
Content-Type: text/html; charset=ISO-8859-1
Content-Transfer-Encoding: quoted-printable

<div dir=3D"ltr"><div><div>Thank you, the porting is going well; if you wan=
t you can see the progress at <a href=3D"https://github.com/ProGNOMmers/gto=
p">https://github.com/ProGNOMmers/gtop</a> .<br><br></div>Now I have some t=
roubles: I need to use <span style=3D"font-family:courier new,monospace">g_=
free</span> from <span style=3D"font-family:courier new,monospace">glib</sp=
an>, so I tried to wrap it:<br>

<br><span style=3D"font-family:courier new,monospace">require &#39;gtop&#39=
;<br><br>module GTop<br>=A0 module GLib<br>=A0=A0=A0 extend FFI::Library<br=
>=A0=A0=A0 ffi_lib &#39;libglib2.0&#39;<br><br>=A0=A0=A0 typedef :pointer, =
:gpointer<br><br>
=A0=A0=A0 attach_function :g_free, [:gpointer], :void<br>
=A0 end<br>end</span><br><br>On my pc <a href=3D"http://libglib2.0.so">libg=
lib2.0.so</a> is located inside /usr/lib/x86_64-linux-gnu/ , which should b=
e found since it is inside the ld paths, which on my machine are<br><br><sp=
an style=3D"font-family:courier new,monospace"># Multiarch support<br>

/lib/i386-linux-gnu<br>/usr/lib/i386-linux-gnu<br>/lib/i686-linux-gnu<br>/u=
sr/lib/i686-linux-gnu<br># libc default configuration<br>/usr/local/lib<br>=
/usr/lib/nvidia-settings<br># Multiarch support<br>/lib/x86_64-linux-gnu<br=
>

/usr/lib/x86_64-linux-gnu<br>/usr/lib/x86_64-linux-gnu/mesa</span><br><br><=
/div><div>but I get a LoadError:<br><br><span style=3D"font-family:courier =
new,monospace">Could not open library &#39;libglib2.0&#39;: libglib2.0: can=
not open shared object file: No such file or directory.<br>

Could not open library &#39;<a href=3D"http://libglib2.0.so">libglib2.0.so<=
/a>&#39;: <a href=3D"http://libglib2.0.so">libglib2.0.so</a>: cannot open s=
hared object file: No such file or directory<br>/home/user/.rbenv/versions/=
2.0.0-p0/lib/ruby/gems/2.0.0/gems/ffi-1.4.0/lib/ffi/library.rb:123:in `bloc=
k in ffi_lib&#39;<br>

/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/ffi-1.4.0/lib/=
ffi/library.rb:90:in `map&#39;<br>/home/user/.rbenv/versions/2.0.0-p0/lib/r=
uby/gems/2.0.0/gems/ffi-1.4.0/lib/ffi/library.rb:90:in `ffi_lib&#39;<br>

/home/user/github/me/gtop/lib/gtop/glib.rb:6:in `&lt;module:GLib&gt;&#39;<b=
r>/home/user/github/me/gtop/lib/gtop/glib.rb:4:in `&lt;module:GTop&gt;&#39;=
<br>/home/user/github/me/gtop/lib/gtop/glib.rb:3:in `&lt;top (required)&gt;=
&#39;<br>

/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/site_ruby/2.0.0/rubygems/core_=
ext/kernel_require.rb:45:in `require&#39;<br>/home/user/.rbenv/versions/2.0=
.0-p0/lib/ruby/site_ruby/2.0.0/rubygems/core_ext/kernel_require.rb:45:in `r=
equire&#39;<br>

/home/user/github/me/gtop/lib/gtop.rb:7:in `&lt;module:GTop&gt;&#39;<br>/ho=
me/user/github/me/gtop/lib/gtop.rb:3:in `&lt;top (required)&gt;&#39;<br>/ho=
me/user/.rbenv/versions/2.0.0-p0/lib/ruby/site_ruby/2.0.0/rubygems/core_ext=
/kernel_require.rb:45:in `require&#39;<br>

/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/site_ruby/2.0.0/rubygems/core_=
ext/kernel_require.rb:45:in `require&#39;<br>/home/user/github/me/gtop/Rake=
file:4:in `block in &lt;top (required)&gt;&#39;<br>/home/user/.rbenv/versio=
ns/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/task.rb:228:in `c=
all&#39;<br>

/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/li=
b/rake/task.rb:228:in `block in execute&#39;<br>/home/user/.rbenv/versions/=
2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/task.rb:223:in `each=
&#39;<br>

/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/li=
b/rake/task.rb:223:in `execute&#39;<br>/home/user/.rbenv/versions/2.0.0-p0/=
lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/task.rb:166:in `block in invo=
ke_with_call_chain&#39;<br>

/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/2.0.0/monitor.rb:211:in `mon_s=
ynchronize&#39;<br>/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/=
gems/rake-10.0.3/lib/rake/task.rb:159:in `invoke_with_call_chain&#39;<br>

/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/li=
b/rake/task.rb:152:in `invoke&#39;<br>/home/user/.rbenv/versions/2.0.0-p0/l=
ib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/application.rb:143:in `invoke_=
task&#39;<br>

/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/li=
b/rake/application.rb:101:in `block (2 levels) in top_level&#39;<br>/home/u=
ser/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/=
application.rb:101:in `each&#39;<br>

/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/li=
b/rake/application.rb:101:in `block in top_level&#39;<br>/home/user/.rbenv/=
versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/application=
.rb:110:in `run_with_threads&#39;<br>

/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/li=
b/rake/application.rb:95:in `top_level&#39;<br>/home/user/.rbenv/versions/2=
.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/application.rb:73:in =
`block in run&#39;<br>

/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/li=
b/rake/application.rb:160:in `standard_exception_handling&#39;<br>/home/use=
r/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/lib/rake/ap=
plication.rb:70:in `run&#39;<br>

/home/user/.rbenv/versions/2.0.0-p0/lib/ruby/gems/2.0.0/gems/rake-10.0.3/bi=
n/rake:33:in `&lt;top (required)&gt;&#39;<br>/home/user/.rbenv/versions/2.0=
.0-p0/bin/rake:23:in `load&#39;<br>/home/user/.rbenv/versions/2.0.0-p0/bin/=
rake:23:in `&lt;main&gt;&#39;</span><br>

<br></div><div>I tried to set LD_LIBRARY_PATH too, but without success.<br>=
<br></div><div>Oh, and I have another doubt: gpointer is the return value o=
f `glibtop_get_proclist&#39;, and can be either `NULL&#39; on error or a `u=
nsigned *&#39; list of pids.<br>

</div><div>I defined it as :pointer, it is correct? could the NULL value gi=
ve problems? should I manage it?<br></div></div><div class=3D"gmail_extra">=
<br clear=3D"all"><div>--<div><br>Maurizio De Santis</div></div>
<br><br><div class=3D"gmail_quote">2013/3/5 Wayne Meissner <span dir=3D"ltr=
">&lt;<a href=3D"mailto:wmeissner@gmail.com" target=3D"_blank">wmeissner@gm=
ail.com</a>&gt;</span><br><blockquote class=3D"gmail_quote" style=3D"margin=
:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex">

<div><br></div>:buffer_in, and :buffer_out are optimization hints for VMs w=
hen they need to copy data from VM heap memory to native memory:<div><br></=
div><div>:buffer_in means &quot;allocate some temporary native memory, copy=
 the contents of this object to it, then pass the temporary memory address =
to the function&quot;</div>

<div><br></div><div><div>:buffer_out means &quot;allocate some temporary na=
tive memory, pass that address to the function, then afterwards, copy the c=
ontents of the temporary memory area back to the VM heap object&quot;</div>

</div><div><br></div><div>:pointer and :buffer_inout are analogous and mean=
 &quot;do both of the above&quot; - i.e. copies both in to and out of the t=
emporary memory area.</div><div><br></div><div>If you&#39;re using a Memory=
Pointer as your memory (as Struct does), then it is already native, so it d=
oesn&#39;t matter, so you can just use :pointer.</div>

<div><br></div><div>The original rationale behind the :buffer_in and :buffe=
r_out directives was that allocating VM heap objects is really cheap, and m=
ost VMs have a very hard time managing native memory allocations. =A0So fro=
m an implementation point of view, it was better to bias towards VM heap al=
locations and copy data in/out of temporary native memory. =A0Thats where F=
FI::Buffer came from - it was VM heap memory that was always copied to/from=
 native memory when passed as a parameter.</div>

<div><br></div><div>In practice, people found it difficult and confusing to=
 understand, so I just made native allocation management work as best it co=
uld in JRuby-1.7.</div><div><br></div><div><br></div><div>tl;dr - just use =
:pointer - it will work just fine, at an occasional minor performance penal=
ty.</div>

<div><br></div><div><br></div><div><div class=3D"im">On Monday, 4 March 201=
3 11:45:38 UTC+10, Postmodern  wrote:</div><blockquote class=3D"gmail_quote=
" style=3D"margin:0;margin-left:0.8ex;border-left:1px #ccc solid;padding-le=
ft:1ex">


 =20
   =20
 =20
  <div bgcolor=3D"#FFFFFF" text=3D"#000000"><div class=3D"im">
    <div>You want :pointer in this case. I
      believe :buffer_out is a meant as a hint to FFI that data will be
      written back into an Array of chars/ints.<br>
      <br>
      On 03/03/2013 05:41 PM, Maurizio De Santis wrote:<br>
    </div>
    </div><blockquote type=3D"cite"><div class=3D"im">
      <div dir=3D"ltr">
        <div>
          <div>Another question: <span style=3D"font-family:courier new,mon=
ospace">glibtop_get_cpu</span> takes a struct as
            parameter, and fills it with informations about cpu.<br>
            <br>
          </div>
          I declared it as <br>
          <br>
          <span style=3D"font-family:courier new,monospace">attach_function
            :glibtop_get_cpu, [:pointer], :void</span><br>
          <br>
        </div>
        I think I can substitute <span style=3D"font-family:courier new,mon=
ospace">:pointer</span> with <span style=3D"font-family:courier new,monospa=
ce">:buffer_out</span> ,
        am I right?<br>
      </div>
      </div><div><br clear=3D"all">
        <div>--
          <div><br>
            Maurizio De Santis</div>
        </div>
        <br>
        <br>
        <div class=3D"gmail_quote">2013/3/4 Maurizio De Santis <span dir=3D=
"ltr">&lt;<a>desantis...@gmail.com</a>&gt;</span><br>
          <blockquote class=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;bord=
er-left:1px #ccc solid;padding-left:1ex"><div class=3D"im">
            <div dir=3D"ltr">Thank you a lot, your suggestions are
              precious.<br>
            </div>
            </div><div>
              <div>
                <div><br clear=3D"all">
                  <div>--
                    <div><br>
                      Maurizio De Santis</div>
                  </div>
                  <br>
                  <br>
                  <div class=3D"gmail_quote">2013/3/3 postmodern <span dir=
=3D"ltr">&lt;<a>postmod...@gmail.com</a>&gt;</span><br>
                    <blockquote class=3D"gmail_quote" style=3D"margin:0 0 0=
 .8ex;border-left:1px #ccc solid;padding-left:1ex">
                      <div bgcolor=3D"#FFFFFF" text=3D"#000000"><div><div c=
lass=3D"h5">
                        <div>You can simplify that code to just:<br>
                          <blockquote>
                            <pre><span style=3D"font-family:courier new,mon=
ospace">a =3D LibGtop::GlibtopCpu.new
LibGtop.glibtop_get_cpu(a)
p a[:frequency]</span></pre>
                          </blockquote>
                          This will allocate memory for a GlibtopCpu
                          struct, pass the pointer to the memory to
                          glibtop_get_cpu and access to the struct field
                          within the memory. Once you are done with the
                          &quot;a&quot; variable, Ruby will just GC it and =
FFI
                          will free the underlying memory.
                          <div>
                            <div><br>
                              <br>
                              On 03/02/2013 07:54 PM, Maurizio De Santis
                              wrote:<br>
                            </div>
                          </div>
                        </div>
                        </div></div><div>
                          <div>
                            <blockquote type=3D"cite"><div><div class=3D"h5=
">
                              <div dir=3D"ltr">
                                <div>
                                  <div>Thank you. Now, the code runs
                                    without errors:<br>
                                    <br>
                                    <span style=3D"font-family:courier new,=
monospace">require &#39;ffi&#39;<br>
                                      <br>
                                      module LibGtop<br>
                                      =A0 <br>
                                      =A0 extend FFI::Library<br>
                                      =A0 ffi_lib &#39;libgtop-2.0&#39;<br>
                                      <br>
                                      =A0 typedef :uint64, :guint64<br>
                                      <br>
                                      =A0 attach_function
                                      :glibtop_get_cpu, [:pointer],
                                      :void<br>
                                      <br>
                                      =A0 class GlibtopCpu &lt;
                                      FFI::Struct<br>
                                      =A0=A0=A0 layout :flags,=A0=A0=A0=A0=
=A0=A0=A0=A0
                                      :guint64,<br>
                                      =A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 :total=
,=A0=A0=A0=A0=A0=A0=A0=A0
                                      :guint64,<br>
                                      =A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 :user,=
=A0=A0=A0=A0=A0=A0=A0=A0=A0
                                      :guint64,<br>
                                      =A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 :nice,=
=A0=A0=A0=A0=A0=A0=A0=A0=A0
                                      :guint64,<br>
                                      =A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 :sys,=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0
                                      :guint64,<br>
                                      =A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 :idle,=
=A0=A0=A0=A0=A0=A0=A0=A0=A0
                                      :guint64,<br>
                                      =A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 :iowai=
t,=A0=A0=A0=A0=A0=A0=A0
                                      :guint64,<br>
                                      =A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 :irq,=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0
                                      :guint64,<br>
                                      =A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 :softi=
rq,=A0=A0=A0=A0=A0=A0
                                      :guint64,<br>
                                      =A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 :frequ=
ency,=A0=A0=A0=A0
                                      :guint64,<br>
                                      =A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 :xcpu_=
total,=A0=A0
                                      [:guint64, 32],<br>
                                      =A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 :xcpu_=
user,=A0=A0=A0
                                      [:guint64, 32],<br>
                                      =A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 :xcpu_=
nice,=A0=A0=A0
                                      [:guint64, 32],<br>
                                      =A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 :xcpu_=
sys,=A0=A0=A0=A0
                                      [:guint64, 32],<br>
                                      =A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 :xcpu_=
idle,=A0=A0=A0
                                      [:guint64, 32],<br>
                                      =A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 :xcpu_=
iowait,=A0
                                      [:guint64, 32],<br>
                                      =A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 :xcpu_=
irq,=A0=A0=A0=A0
                                      [:guint64, 32],<br>
                                      =A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 :xcpu_=
softirq,
                                      [:guint64, 32],<br>
                                      =A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 :xcpu_=
flags,=A0=A0=A0
                                      :guint64<br>
                                      =A0 end<br>
                                      <br>
                                      end<br>
                                      <br>
                                      <br>
                                      # taken from <a href=3D"https://githu=
b.com/ffi/ffi/wiki/Structs" target=3D"_blank">https://github.com/ffi/ffi/<u=
></u>wiki/Structs</a><br>
                                      pointer =3D FFI::MemoryPointer.new
                                      :uint64, LibGtop::GlibtopCpu.size,
                                      true<br>
                                      a =3D LibGtop::GlibtopCpu.new
                                      pointer<br>
                                      LibGtop.glibtop_get_cpu(a)<br>
                                      p a[:frequency]</span><br>
                                    <br>
                                  </div>
                                  Another question: I initialized the
                                  pointer with <span style=3D"font-family:c=
ourier new,monospace">clear =3D true</span>,
                                  because the struct pointed by the
                                  pointer gets filled by
                                  glibtop_get_cpu, and then must be
                                  managed by Ruby, since <span style=3D"fon=
t-family:courier new,monospace">glibtop_get_cpu<font face=3D"arial,helvetic=
a,sans-serif">
                                      just fills the struct. Am I wrong?</f=
ont></span><br>
                                </div>
                              </div>
                              </div></div><div><br clear=3D"all">
                                <div>--
                                  <div><br>
                                    Maurizio De Santis</div>
                                </div>
                                <br>
                                <br>
                                <div class=3D"gmail_quote">2013/3/3
                                  postmodern <span dir=3D"ltr">&lt;<a>postm=
od...@gmail.com</a>&gt;</span><br>
                                  <blockquote class=3D"gmail_quote" style=
=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex">
                                    <div bgcolor=3D"#FFFFFF" text=3D"#00000=
0"><div><div class=3D"h5">
                                      <div>You need to find out
                                        guint64&#39;s underlying type, and
                                        create the typedef in Ruby:<br>
                                        <br>
                                        <blockquote>
                                          <pre>module <span style=3D"font-f=
amily:courier new,monospace">LibGtop</span>
  extend FFI::Library

  typedef :uint64, :guint64
end
</pre>
                                        </blockquote>
                                        <div>
                                          <div> <br>
                                            On 03/02/2013 06:06 PM,
                                            Maurizio De Santis wrote:<br>
                                          </div>
                                        </div>
                                      </div>
                                      </div></div><blockquote type=3D"cite"=
><div><div class=3D"h5">
                                        <div>
                                          <div>I am writing a libgtop2
                                            wrapper using ffi in order
                                            to learn how to use ffi; I
                                            am new to ffi, so I have a
                                            lot of doubts.<br>
                                            <br>
                                            libgtop2 lets get system and
                                            processes informations (cpu
                                            usage, memory usage, ...).<br>
                                            <br>
                                            Here some informations about
                                            <span style=3D"font-family:cour=
ier new,monospace">glibtop_get_cpu</span>:<br>
                                            <br>
                                            <span style=3D"font-family:cour=
ier new,monospace">Library
                                              function
                                              `glibtop_get_cpu&#39;:<br>
                                              <br>
                                              =A0=A0=A0=A0 void glibtop_get=
_cpu
                                              (glibtop_cpu *buf);<br>
                                              =A0=A0=A0=A0 void
                                              glibtop_get_cpu_l (glibtop
                                              *server, glibtop_cpu
                                              *buf);<br>
                                              <br>
                                              =A0=A0 Declaration of
                                              `glibtop_cpu&#39; in
                                              `&lt;glibtop/cpu.h&gt;&#39;:<=
br>
                                              <br>
                                              =A0=A0=A0=A0 typedef struct
                                              _glibtop_cpu=A0=A0=A0=A0
                                              glibtop_cpu;<br>
                                              <br>
                                              =A0=A0=A0=A0 struct _glibtop_=
cpu<br>
                                              =A0=A0=A0=A0 {<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0 guin=
t64=A0=A0 flags,<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0 total,<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0 user,<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0 nice,<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0 sys,<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0 idle,<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0 iowait,<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0 irq,<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0 softirq,<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0 frequency,<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0 xcpu_total
                                              [GLIBTOP_NCPU],<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0 xcpu_user
                                              [GLIBTOP_NCPU],<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0 xcpu_nice
                                              [GLIBTOP_NCPU],<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0 xcpu_sys=A0
                                              [GLIBTOP_NCPU],<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0 xcpu_idle
                                              [GLIBTOP_NCPU],<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0 xcpu_iowait
                                              [GLIBTOP_NCPU],<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0 xcpu_irq
                                              [GLIBTOP_NCPU],<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0 xcpu_softirq
                                              [GLIBTOP_NCPU],<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0 xcpu_flags;<br>
                                              =A0=A0=A0=A0 };<br>
                                              <br>
                                              ...</span><br>
                                            <br>
                                            <br>
                                            Here is what I wrote:<br>
                                            <span style=3D"font-family:cour=
ier new,monospace"><br>
                                              require &#39;ffi&#39;<br>
                                              <br>
                                              class GlibtopCpu &lt;
                                              FFI::Struct<br>
                                              =A0 layout :flags,=A0=A0=A0=
=A0=A0=A0=A0
                                              :guint64,<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0 :tot=
al,=A0=A0=A0=A0=A0=A0=A0
                                              :guint64,<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0 :use=
r,=A0=A0=A0=A0=A0=A0=A0=A0
                                              :guint64,<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0 :nic=
e,=A0=A0=A0=A0=A0=A0=A0=A0
                                              :guint64,<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0 :sys=
,=A0=A0=A0=A0=A0=A0=A0=A0=A0
                                              :guint64,<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0 :idl=
e,=A0=A0=A0=A0=A0=A0=A0=A0
                                              :guint64,<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0 :iow=
ait,=A0=A0=A0=A0=A0=A0
                                              :guint64,<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0 :irq=
,=A0=A0=A0=A0=A0=A0=A0=A0=A0
                                              :guint64,<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0 :sof=
tirq,=A0=A0=A0=A0=A0
                                              :guint64,<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0 :fre=
quency,=A0=A0=A0
                                              :guint64,<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0 :xcp=
u_total,=A0=A0
                                              :guint64,<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0 :xcp=
u_user,=A0=A0=A0
                                              :guint64,<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0 :xcp=
u_nice,=A0=A0=A0
                                              :guint64,<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0 :xcp=
u_sys,=A0=A0=A0=A0
                                              :guint64,<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0 :xcp=
u_idle,=A0=A0=A0
                                              :guint64,<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0 :xcp=
u_iowait,=A0
                                              :guint64,<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0 :xcp=
u_irq,=A0=A0=A0=A0
                                              :guint64,<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0 :xcp=
u_softirq,
                                              :guint64,<br>
                                              =A0=A0=A0=A0=A0=A0=A0=A0 :xcp=
u_flags,=A0=A0
                                              :guint64<br>
                                              end<br>
                                              <br>
                                              module LibGtop<br>
                                              =A0 <br>
                                              =A0 extend FFI::Library<br>
                                              =A0 ffi_lib &#39;libgtop-2.0&=
#39;<br>
                                              =A0 attach_function
                                              :glibtop_get_cpu,
                                              [:pointer], :void<br>
                                              <br>
                                              end<br>
                                              <br>
                                              # taken from <a href=3D"https=
://github.com/ffi/ffi/wiki/Structs" target=3D"_blank">https://github.com/ff=
i/ffi/<u></u>wiki/Structs</a><br>
                                              pointer =3D
                                              FFI::MemoryPointer.new
                                              :byte, GlibtopCpu.size,
                                              false<br>
                                              a =3D GlibtopCpu.new pointer<=
br>
                                              p
                                              LibGtop.glibtop_get_cpu(a)</s=
pan><br>
                                            <br>
                                            Executing this gives
                                            (unsurprisingly) an error:<br>
                                            <br>
                                            <span style=3D"font-family:cour=
ier new,monospace">$ ruby
                                              lib/lib_gtop.rb <br>
                                              /home/izietto/.rbenv/versions=
/<u></u>2.0.0-p0/lib/ruby/gems/2.0.0/<u></u>gems/ffi-1.4.0/lib/ffi/types.<u=
></u>rb:57:in


                                              `find_type&#39;: unable to
                                              resolve type &#39;guint64&#39=
;
                                              (TypeError)<br>
                                              =A0=A0=A0 from
                                              /home/izietto/.rbenv/versions=
/<u></u>2.0.0-p0/lib/ruby/gems/2.0.0/<u></u>gems/ffi-1.4.0/lib/ffi/struct.<=
u></u>rb:316:in


                                              `find_type&#39;<br>
                                              =A0=A0=A0 from
                                              /home/izietto/.rbenv/versions=
/<u></u>2.0.0-p0/lib/ruby/gems/2.0.0/<u></u>gems/ffi-1.4.0/lib/ffi/struct.<=
u></u>rb:309:in


                                              `find_field_type&#39;<br>
                                              =A0=A0=A0 from
                                              /home/izietto/.rbenv/versions=
/<u></u>2.0.0-p0/lib/ruby/gems/2.0.0/<u></u>gems/ffi-1.4.0/lib/ffi/struct.<=
u></u>rb:351:in


                                              `array_layout&#39;<br>
                                              =A0=A0=A0 from
                                              /home/izietto/.rbenv/versions=
/<u></u>2.0.0-p0/lib/ruby/gems/2.0.0/<u></u>gems/ffi-1.4.0/lib/ffi/struct.<=
u></u>rb:261:in


                                              `layout&#39;<br>
                                              =A0=A0=A0 from
                                              lib/lib_gtop.rb:4:in
                                              `&lt;class:GlibtopCpu&gt;&#39=
;<br>
                                              =A0=A0=A0 from
                                              lib/lib_gtop.rb:3:in
                                              `&lt;main&gt;&#39;</span><br>
                                            <br>
                                            It doesn&#39;t find the <span s=
tyle=3D"font-family:courier new,monospace">guint64</span>
                                            type; how should I declare
                                            it?<br>
                                            <br>
                                            Also: <span style=3D"font-famil=
y:courier new,monospace">xcpu_total,
                                              xcpu_user<span style=3D"font-=
family:arial,sans-serif">
                                                are arrays... how should
                                                I declare them?<br>
                                                <br>
                                                Finally... if someone
                                                could give me an
                                                explanation and an
                                                example of how to
                                                implement the bind to
                                                glibtop_get_cpu, I would
                                                appreciate it very much
                                                :)</span></span> -- <br>
                                            =A0<br>
                                            --- <br>
                                          </div>
                                        </div>
                                        You received this message
                                        because you are subscribed to
                                        the Google Groups &quot;ruby-ffi&qu=
ot;
                                        group.<br></div></div>
                                        To unsubscribe from this group
                                        and stop receiving emails from
                                        it, send an email to <a>ruby-ffi+u.=
..@<u></u>googlegroups.com</a>.
                                        <div class=3D"im"><div><br>
                                          For more options, visit <a href=
=3D"https://groups.google.com/groups/opt_out" target=3D"_blank">https://gro=
ups.google.com/<u></u>groups/opt_out</a>.<br>
                                          =A0<br>
                                          =A0<br>
                                        </div>
                                      </div></blockquote><div class=3D"im">
                                      <span><font color=3D"#888888"> <br>
                                          <br>
                                          <pre cols=3D"72">--=20
Blog: <a href=3D"http://postmodern.github.com/" target=3D"_blank">http://po=
stmodern.github.com/</a>
GitHub: <a href=3D"https://github.com/postmodern" target=3D"_blank">https:/=
/github.com/postmodern</a>
Twitter: @postmodern_mod3
PGP: 0xB9515E77</pre>
                                        </font></span></div></div>
                                  </blockquote>
                                </div>
                                <br>
                              </div><div class=3D"im">
                              -- <br>
                              =A0<br>
                              --- <br>
                              You received this message because you are
                              subscribed to the Google Groups &quot;ruby-ff=
i&quot;
                              group.<br></div>
                              To unsubscribe from this group and stop
                              receiving emails from it, send an email to
                              <a>ruby-ffi+u...@<u></u>googlegroups.com</a>.=
<div class=3D"im"><br>
                              For more options, visit <a href=3D"https://gr=
oups.google.com/groups/opt_out" target=3D"_blank">https://groups.google.com=
/<u></u>groups/opt_out</a>.<br>
                              =A0<br>
                              =A0<br>
                            </div></blockquote><div class=3D"im">
                            <br>
                            <br>
                            <pre cols=3D"72">--=20
Blog: <a href=3D"http://postmodern.github.com/" target=3D"_blank">http://po=
stmodern.github.com/</a>
GitHub: <a href=3D"https://github.com/postmodern" target=3D"_blank">https:/=
/github.com/postmodern</a>
Twitter: @postmodern_mod3
PGP: 0xB9515E77</pre>
                          </div></div>
                        </div>
                      </div>
                    </blockquote>
                  </div>
                  <br>
                </div>
              </div>
            </div>
          </blockquote>
        </div>
        <br>
      </div><div class=3D"im">
      -- <br>
      =A0<br>
      --- <br>
      You received this message because you are subscribed to the Google
      Groups &quot;ruby-ffi&quot; group.<br></div>
      To unsubscribe from this group and stop receiving emails from it,
      send an email to <a>ruby-ffi+u...@<u></u>googlegroups.com</a>.<div cl=
ass=3D"im"><br>
      For more options, visit <a href=3D"https://groups.google.com/groups/o=
pt_out" target=3D"_blank">https://groups.google.com/<u></u>groups/opt_out</=
a>.<br>
      =A0<br>
      =A0<br>
    </div></blockquote><div class=3D"im">
    <br>
    <br>
    <pre cols=3D"72">--=20
Blog: <a href=3D"http://postmodern.github.com/" target=3D"_blank">http://po=
stmodern.github.com/</a>
GitHub: <a href=3D"https://github.com/postmodern" target=3D"_blank">https:/=
/github.com/postmodern</a>
Twitter: @postmodern_mod3
PGP: 0xB9515E77</pre>
  </div></div><span class=3D"HOEnZb"><font color=3D"#888888">

</font></span></blockquote></div><span class=3D"HOEnZb"><font color=3D"#888=
888">

<p></p>

-- <br>
=A0<br>
--- <br>
You received this message because you are subscribed to a topic in the Goog=
le Groups &quot;ruby-ffi&quot; group.<br>
To unsubscribe from this topic, visit <a href=3D"https://groups.google.com/=
d/topic/ruby-ffi/sG-TsAHcWiM/unsubscribe?hl=3Den" target=3D"_blank">https:/=
/groups.google.com/d/topic/ruby-ffi/sG-TsAHcWiM/unsubscribe?hl=3Den</a>.<br=
>
To unsubscribe from this group and all its topics, send an email to <a href=
=3D"mailto:ruby-ffi%2Bunsubscribe@googlegroups.com" target=3D"_blank">ruby-=
ffi+unsubscribe@googlegroups.com</a>.</font></span><div class=3D"HOEnZb"><d=
iv class=3D"h5">

<br>
For more options, visit <a href=3D"https://groups.google.com/groups/opt_out=
" target=3D"_blank">https://groups.google.com/groups/opt_out</a>.<br>
=A0<br>
=A0<br>
</div></div></blockquote></div><br></div>

<p></p>

-- <br />
&nbsp;<br />
--- <br />
You received this message because you are subscribed to the Google Groups &=
quot;ruby-ffi&quot; group.<br />
To unsubscribe from this group and stop receiving emails from it, send an e=
mail to ruby-ffi+unsubscribe@googlegroups.com.<br />
For more options, visit <a href=3D"https://groups.google.com/groups/opt_out=
">https://groups.google.com/groups/opt_out</a>.<br />
&nbsp;<br />
&nbsp;<br />

--047d7ba97b72b59e7404d794db36--
