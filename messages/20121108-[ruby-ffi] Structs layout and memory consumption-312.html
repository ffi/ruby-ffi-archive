<html>
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>[ruby-ffi] Structs layout and memory consumption</title>
<link rel="important stylesheet" href="">
<style>div.headerdisplayname {font-weight:bold;}</style></head>
<body>
<table border=0 cellspacing=0 cellpadding=0 width="100%" class="header-part1"><tr><td><div class="headerdisplayname" style="display:inline;">Subject: </div>[ruby-ffi] Structs layout and memory consumption</td></tr><tr><td><div class="headerdisplayname" style="display:inline;">From: </div>Hans Hasselberg <hans@hans.io></td></tr><tr><td><div class="headerdisplayname" style="display:inline;">Date: </div>11/8/12 1:45 PM</td></tr></table><table border=0 cellspacing=0 cellpadding=0 width="100%" class="header-part2"><tr><td><div class="headerdisplayname" style="display:inline;">To: </div>ruby-ffi@googlegroups.com</td></tr></table><br>
<div class="moz-text-html"  lang="x-unicode">Hello!<div><br></div><div>Thank you very much for this library!</div><div>I stumbled over a problem with code I 'inherited', it is a gem which wraps libcurl.</div><div>This code works, but consumes too much memory for my taste and looks suspicious!</div><div><br></div><div>https://github.com/typhoeus/ethon/blob/master/lib/ethon/curls/classes.rb:<br></div><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div><font face="courier new, monospace">class FDSet &lt; FFI::Struct</font></div><div><font face="courier new, monospace">&nbsp; FD_SETSIZE = 524288</font></div><div><font face="courier new, monospace">&nbsp; layout :fds_bits, [:long, FD_SETSIZE / FFI::Type::LONG.size]</font></div><div><font face="courier new, monospace">end</font></div></blockquote><div><br></div><div>I can change that code to:</div><div><br></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div><span style="font-family: 'courier new', monospace;">class FDSet &lt; FFI::Struct</span></div><div><span style="font-family: 'courier new', monospace;">&nbsp; layout :fds_bits, :long</span><br></div><div><font face="courier new, monospace">end</font></div></blockquote><div><br></div><div>Instances of FDSet do not consume so much memory any more, but I get segfaults on a regular basis. It seems to me, that fds_bits is just a memory placeholder.</div><div>The ffi code in that particular project looks quite understandable except for that FDSet.&nbsp;</div><div><br></div><div>Could you explain to me, why my code segfaults with the changed code and if FDSet is correct specified? I bet you need more information, but I don't know which, so feel free to ask!</div><div><br></div><div><br></div><div>Cheers,</div><div>Hans</div>
</div></body>
</html>
</table></div>