<html>
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>[ruby-ffi] Reading struct elements returning incorrect values</title>
<link rel="important stylesheet" href="">
<style>div.headerdisplayname {font-weight:bold;}</style></head>
<body>
<table border=0 cellspacing=0 cellpadding=0 width="100%" class="header-part1"><tr><td><div class="headerdisplayname" style="display:inline;">Subject: </div>[ruby-ffi] Reading struct elements returning incorrect values</td></tr><tr><td><div class="headerdisplayname" style="display:inline;">From: </div>Navaneeth KN <navaneethkn@gmail.com></td></tr><tr><td><div class="headerdisplayname" style="display:inline;">Date: </div>6/14/12 9:42 PM</td></tr></table><table border=0 cellspacing=0 cellpadding=0 width="100%" class="header-part2"><tr><td><div class="headerdisplayname" style="display:inline;">To: </div>ruby-ffi@googlegroups.com</td></tr></table><br>
<div class="moz-text-html"  lang="x-unicode">Hello,<br><br>I have a C function like,<br><br>&nbsp;&nbsp; int varray_length (varray*)<br>&nbsp;&nbsp; void* varray_get(int index)<br><br>FFI mappings like,<br><br>&nbsp; attach_function :varray_get, [:pointer, :int], :pointer<br>&nbsp; attach_function :varray_length, [:pointer], :int<br><br>My C structure looks like,<br><br>typedef struct token {<br>&nbsp;&nbsp;&nbsp; int type, match_type;<br>&nbsp;&nbsp;&nbsp; char tag[TOKEN_TAG_MAX];<br>&nbsp;&nbsp;&nbsp; char pattern[SYMBOL_MAX];<br>&nbsp;&nbsp;&nbsp; char value1[SYMBOL_MAX];<br>&nbsp;&nbsp;&nbsp; char value2[SYMBOL_MAX];<br>&nbsp;&nbsp;&nbsp; int children;<br>} vtoken;<br><br>FFI struct like,<br><br>&nbsp; class Token &lt; FFI::Struct<br>&nbsp;&nbsp;&nbsp; layout :type, :int,<br>&nbsp;&nbsp;&nbsp; :match_type, :int,<br>&nbsp;&nbsp;&nbsp; :tag, [:char, TOKEN_TAG_MAX],<br>&nbsp;&nbsp;&nbsp; :pattern, [:char, SYMBOL_MAX],<br>&nbsp;&nbsp;&nbsp; :value1, [:char, SYMBOL_MAX],<br>&nbsp;&nbsp;&nbsp; :value2, [:char, SYMBOL_MAX],<br>&nbsp;&nbsp;&nbsp; :children, :int,<br>&nbsp; end<br><br>I am invoking a C function which has signature like,<br><br>&nbsp; int get_all_tokens(varnam*, int, varray **output)<br><br>Invoiking this using FFI like,<br><br>&nbsp; token_ptr = FFI::MemoryPointer.new :pointer<br>&nbsp; done = VarnamLibrary.varnam_get_all_tokens($varnam_handle.get_pointer(0), token_type, token_ptr);<br><br>This call succedes and I get a varray instance assigned to token_ptr. All is good. Now when I try to read data from this pointer, I am getting empty values. I am doing it like,<br><br>&nbsp; size = VarnamLibrary.varray_length(token_ptr.get_pointer(0)) --- This works<br>&nbsp; i = 0<br>&nbsp; until i &gt;= size<br>&nbsp;&nbsp;&nbsp; tok = VarnamLibrary.varray_get(token_ptr.get_pointer(0), i)&nbsp;&nbsp; - This succeds<br>&nbsp;&nbsp;&nbsp; ptr = token_ptr.read_pointer<br>&nbsp;&nbsp;&nbsp; item = VarnamLibrary::Token.new(ptr)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - This works, but all properties of item will be empty.<br>&nbsp;&nbsp;&nbsp; varnam_token = VarnamToken.new(item[:type],<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ffito_string(item[:pattern]), ffito_string(item[:value1]),<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ffito_string(item[:value2]), item[:match_type])&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - This gives me a token with empty values for strings and some random values for integers<br>&nbsp;&nbsp;&nbsp; i += 1<br>&nbsp; end<br><br>I am wondering why this happens. Any help would be great. <br><br>Thanks<br>Navaneeth<br>
</div></body>
</html>
</table></div>