X-Mozilla-Keys: notjunk $notjunk
Delivered-To: headius@headius.com
Received: by 10.112.81.161 with SMTP id b1csp549265lby;
        Wed, 14 Nov 2012 17:07:22 -0800 (PST)
Received: by 10.50.214.66 with SMTP id ny2mr931836igc.21.1352941641035;
        Wed, 14 Nov 2012 17:07:21 -0800 (PST)
Return-Path: <ruby-ffi+bncBC3ZHK4B2AFBBSEASGCQKGQEEVQ4F3A@googlegroups.com>
Received: from mail-ia0-f188.google.com (mail-ia0-f188.google.com [209.85.210.188])
        by mx.google.com with ESMTPS id gv1si3151964igb.19.2012.11.14.17.07.20
        (version=TLSv1/SSLv3 cipher=OTHER);
        Wed, 14 Nov 2012 17:07:21 -0800 (PST)
Received-SPF: pass (google.com: domain of ruby-ffi+bncBC3ZHK4B2AFBBSEASGCQKGQEEVQ4F3A@googlegroups.com designates 209.85.216.176 as permitted sender) client-ip=209.85.216.176;
Authentication-Results: mx.google.com; spf=pass (google.com: domain of ruby-ffi+bncBC3ZHK4B2AFBBSEASGCQKGQEEVQ4F3A@googlegroups.com designates 209.85.216.176 as permitted sender) smtp.mail=ruby-ffi+bncBC3ZHK4B2AFBBSEASGCQKGQEEVQ4F3A@googlegroups.com; dkim=pass header.i=@googlegroups.com
Received: by mail-ia0-f188.google.com with SMTP id k32sf1023800iak.25
        for <headius@headius.com>; Wed, 14 Nov 2012 17:07:20 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=googlegroups.com; s=20120806;
        h=x-beenthere:received-spf:date:from:to:subject:message-id
         :in-reply-to:references:x-mailer:mime-version:x-original-sender
         :x-original-authentication-results:reply-to:precedence:mailing-list
         :list-id:x-google-group-id:list-post:list-help:list-archive:sender
         :list-subscribe:list-unsubscribe:content-type
         :content-transfer-encoding;
        bh=M/Pbv6pblEQAiz6DRssTYB8mb7fgXneSkwxh3vA7bmg=;
        b=stgr6mB6k8dbbRv8RvSsNtNJ1iKoJYc0mmd+PdjURyN68Pfk3RRQogfN/QQpLEAM80
         MlTVaOMEmesM6YAfC+ij70N3LnhKYKW3LBwW6PihkxqDwQGQPKegrTZ9DC3vSg/GNnVy
         y6uMKXS2eVRHt6wTavw5ib3sh2P1VTFR6x++NcY4qBYphVyApxI2APKjKMdg+gz/A2rW
         ZAM6X8bqXovyJQzb9Jamqc96oz1npn5itv1YoWTVBwttHq+iSohkU1Zn81e2KUa4KRi/
         fn7jsATdFWWh+q/sR6yisqEbxnQ87Hz0lKW8ZwnXsVBXjxmcjJmZm5T3vL7WtgE3P5f6
         XPhA==
Received: by 10.49.116.193 with SMTP id jy1mr49645qeb.2.1352941640297;
        Wed, 14 Nov 2012 17:07:20 -0800 (PST)
X-BeenThere: ruby-ffi@googlegroups.com
Received: by 10.49.132.105 with SMTP id ot9ls67211qeb.20.gmail; Wed, 14 Nov
 2012 17:07:20 -0800 (PST)
Received: by 10.224.111.140 with SMTP id s12mr11052298qap.5.1352941640041;
        Wed, 14 Nov 2012 17:07:20 -0800 (PST)
Received: by 10.224.111.140 with SMTP id s12mr11052297qap.5.1352941640029;
        Wed, 14 Nov 2012 17:07:20 -0800 (PST)
Received: from mail-qc0-f176.google.com (mail-qc0-f176.google.com [209.85.216.176])
        by gmr-mx.google.com with ESMTPS id eb7si1632585qcb.3.2012.11.14.17.07.20
        (version=TLSv1/SSLv3 cipher=OTHER);
        Wed, 14 Nov 2012 17:07:20 -0800 (PST)
Received-SPF: pass (google.com: domain of jon.forums@gmail.com designates 209.85.216.176 as permitted sender) client-ip=209.85.216.176;
Received: by mail-qc0-f176.google.com with SMTP id n41so635476qco.7
        for <ruby-ffi@googlegroups.com>; Wed, 14 Nov 2012 17:07:19 -0800 (PST)
Received: by 10.224.146.74 with SMTP id g10mr4520274qav.93.1352941639834;
        Wed, 14 Nov 2012 17:07:19 -0800 (PST)
Received: from Red (cpe-65-185-110-237.woh.res.rr.com. [65.185.110.237])
        by mx.google.com with ESMTPS id jw1sm2658272qeb.13.2012.11.14.17.07.19
        (version=TLSv1/SSLv3 cipher=OTHER);
        Wed, 14 Nov 2012 17:07:19 -0800 (PST)
Date: Wed, 14 Nov 2012 20:07:22 -0500
From: Jon <jon.forums@gmail.com>
To: ruby-ffi@googlegroups.com
Subject: Re: [ruby-ffi] 1.2.0.pre6 testing
Message-Id: <20121114200722.3476b8bdc2e3a635d43d365e@gmail.com>
In-Reply-To: <20121114173715.26b0f2fc4ebc3c3087adf18e@gmail.com>
References: <ded4dedd-a8fc-42da-a5d1-7ce046e56d00@googlegroups.com>
	<20121113231711.59b543ca9e6a6510786ca3de@gmail.com>
	<39b46a99-c1b4-477e-92ea-fc1a1417552a@googlegroups.com>
	<20121114173715.26b0f2fc4ebc3c3087adf18e@gmail.com>
X-Mailer: Sylpheed 3.3.0 (GTK+ 2.10.14; i686-pc-mingw32)
Mime-Version: 1.0
X-Original-Sender: jon.forums@gmail.com
X-Original-Authentication-Results: gmr-mx.google.com; spf=pass (google.com:
 domain of jon.forums@gmail.com designates 209.85.216.176 as permitted sender)
 smtp.mail=jon.forums@gmail.com; dkim=pass header.i=@gmail.com
Reply-To: ruby-ffi@googlegroups.com
Precedence: list
Mailing-list: list ruby-ffi@googlegroups.com; contact ruby-ffi+owners@googlegroups.com
List-ID: <ruby-ffi.googlegroups.com>
X-Google-Group-Id: 238405446264
List-Post: <http://groups.google.com/group/ruby-ffi/post?hl=en_US>, <mailto:ruby-ffi@googlegroups.com>
List-Help: <http://groups.google.com/support/?hl=en_US>, <mailto:ruby-ffi+help@googlegroups.com>
List-Archive: <http://groups.google.com/group/ruby-ffi?hl=en_US>
Sender: ruby-ffi@googlegroups.com
List-Subscribe: <http://groups.google.com/group/ruby-ffi/subscribe?hl=en_US>, <mailto:ruby-ffi+subscribe@googlegroups.com>
List-Unsubscribe: <http://groups.google.com/group/ruby-ffi/subscribe?hl=en_US>,
 <mailto:googlegroups-manage+238405446264+unsubscribe@googlegroups.com>
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit

> > > While I never install ffi this way, jruby+bundler on Win7 32bit with JRuby 
> > > 1.7.0 ended up in Wile E. flames trying to build the C ext due to my 
> > > scheming: 
> > >
> > > C:\Users\Jon\Downloads\temp\ffi-java>type Gemfile 
> > > source :rubygems 
> > > gem 'ffi', '1.2.0.pre6', :platforms => :jruby 
> > >
> > > C:\Users\Jon\Downloads\temp\ffi-java>bundle install 
> > > Fetching gem metadata from http://rubygems.org/........... 
> > > Fetching gem metadata from http://rubygems.org/.. 
> > > Installing ffi (1.2.0.pre6) with native extensions 
> > > Gem::Installer::ExtensionBuildError: ERROR: Failed to build gem native 
> > > extension. 
> > 
> >  
> > Hmm.  When installing on something that is not MRI, extconf.rb generates a 
> > dummy Makefile.  I suspect on win32, the dummy Makefile isn't quite 
> > correct.  Can you investigate this one a bit more (look right at the bottom 
> > of ext/ext_c/extconf.rb)?  It could be something as simple as \r\n vs \n 
> > line termination.
> > 
> > I can continue to publish the ffi-java gem, but, I want to get rid of it in 
> > the long term.
> 
> Likely just need this tweak at extconf.rb:59
> 
> -  File.open("Makefile", "w") do |mf|
> +  File.open("Makefile", "wb") do |mf|
> 
> I'll try it out a bit later.

While binary mode may turn out to be an issue, the bigger issue is the dummy Makefile. If a JRuby on Windows user doesn't have `make` on PATH...eeek.

Perhaps an alternative is to change from a extconf.rb to a Rakefile based extension:

  https://github.com/rubygems/rubygems/blob/master/lib/rubygems/installer.rb#L667-680
  https://github.com/rubygems/rubygems/blob/master/lib/rubygems/ext/rake_builder.rb#L22-36

I don't build native gems this way, but it looks like we could use the Rakefile to wrap 

  https://github.com/rubygems/rubygems/blob/master/lib/rubygems/ext/ext_conf_builder.rb#L12-21

since both `build` class methods take the same args, and both return a `results` Array.

A bit more complicated, but is there any scenario (regardless of platform) where a successful FFI gem install truly requires a JRuby user to have build tools on PATH?

Jon
