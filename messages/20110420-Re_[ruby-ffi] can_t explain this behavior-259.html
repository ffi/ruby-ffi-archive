<html>
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Re: [ruby-ffi] can&#39;t explain this behavior</title>
<link rel="important stylesheet" href="">
<style>div.headerdisplayname {font-weight:bold;}</style></head>
<body>
<table border=0 cellspacing=0 cellpadding=0 width="100%" class="header-part1"><tr><td><div class="headerdisplayname" style="display:inline;">Subject: </div>Re: [ruby-ffi] can&#39;t explain this behavior</td></tr><tr><td><div class="headerdisplayname" style="display:inline;">From: </div>Alexander Kabanov <shurikk@gmail.com></td></tr><tr><td><div class="headerdisplayname" style="display:inline;">Date: </div>4/20/11 5:30 PM</td></tr></table><table border=0 cellspacing=0 cellpadding=0 width="100%" class="header-part2"><tr><td><div class="headerdisplayname" style="display:inline;">To: </div>ruby-ffi@googlegroups.com</td></tr></table><br>
<div class="moz-text-plain" wrap=true graphical-quote=true style="font-family: -moz-fixed; font-size: 12px;" lang="x-unicode"><pre wrap>
Hi,

On Wed, Apr 20, 2011 at 1:25 PM, Chuck Remes <a class="moz-txt-link-rfc2396E" href="mailto:cremes.devlist@mac.com">&lt;cremes.devlist@mac.com&gt;</a> wrote:
[skip]
</pre><blockquote type=cite style="color: #000000;"><blockquote type=cite style="color: #000000;"><pre wrap>
<span class="moz-txt-citetags">&gt;&gt; </span>sometimes function call works as expected, sometimes it doesn't, I
<span class="moz-txt-citetags">&gt;&gt; </span>can't explain why. adding removing few lines of code (random "puts"
<span class="moz-txt-citetags">&gt;&gt; </span>calls etc.) will change the function call behavior (will work 20% or
<span class="moz-txt-citetags">&gt;&gt; </span>100% of times). am I supposed to maintain memory pointers somehow
<span class="moz-txt-citetags">&gt;&gt; </span>(i.e. malloc/free) or my .so lib has bad implementation (i know it's
<span class="moz-txt-citetags">&gt;&gt; </span>used in other places without any issues)?
</pre></blockquote><pre wrap>
<span class="moz-txt-citetags">&gt;</span>
<span class="moz-txt-citetags">&gt; </span>Please pastie the errors you are getting particularly if MRI is crashing. You say it doesn't work up to 80% of the time, but what does "does not work" mean in this case?
</pre></blockquote><pre wrap>

it's not crushing, there is no errors, function call might not return
anything or might work as expected and return expected result. minor
changes to the script, like few more comments or "puts" to debug
something will change the script behavior, feels like some kind of
memory allocation issue but I'm not sure.

</pre><blockquote type=cite style="color: #000000;"><blockquote type=cite style="color: #000000;"><pre wrap>
<span class="moz-txt-citetags">&gt;&gt; </span>I tried to use LibC approach described on wiki page using malloc, same
<span class="moz-txt-citetags">&gt;&gt; </span>deal.
<span class="moz-txt-citetags">&gt;&gt;</span>
<span class="moz-txt-citetags">&gt;&gt; </span>ruby 1.8.7 (2010-12-23 patchlevel 330) [i386-linux] RHEL 5.4
<span class="moz-txt-citetags">&gt;&gt; </span>ffi (1.0.7)
</pre></blockquote></blockquote><pre wrap>

</pre><blockquote type=cite style="color: #000000;"><pre wrap>
<span class="moz-txt-citetags">&gt; </span>This might be your issue. I think that 1.8.x support is "best effort" and no longer a target. Try your code again with 1.9.2 and see if it functions more reliably. Alternately, try your code with some other ruby runtimes (JRuby, Rubinius) that have FFI support and see if they provide additional details in their errors. Those other runtimes could greatly aid in debugging.
</pre></blockquote><pre wrap>

Let me try with 1.9.2. Is there a way I can debug this to provide more
info (i.e. with gdb or something else)?

Thanks

--Alex
</pre></div></body>
</html>
</table></div>