Delivered-To: headius@headius.com
Received: by 10.100.164.20 with SMTP id m20cs86131ane;
        Wed, 6 Jan 2010 09:41:48 -0800 (PST)
Received: by 10.150.6.17 with SMTP id 17mr203521ybf.154.1262799708378;
        Wed, 06 Jan 2010 09:41:48 -0800 (PST)
Return-Path: <3WstESwUPCLUeVhZnbmVtnjaodiX.XjhmpWt-aadbjjbgZbmjpkn.Xjh@listserv.bounces.google.com>
Received: from mail-yw0-f137.google.com (mail-yw0-f137.google.com [209.85.211.137])
        by mx.google.com with ESMTP id 42si26725973ywh.105.2010.01.06.09.41.47;
        Wed, 06 Jan 2010 09:41:47 -0800 (PST)
Received-SPF: pass (google.com: domain of 3WstESwUPCLUeVhZnbmVtnjaodiX.XjhmpWt-aadbjjbgZbmjpkn.Xjh@listserv.bounces.google.com designates 209.85.211.137 as permitted sender) client-ip=209.85.211.137;
Authentication-Results: mx.google.com; spf=pass (google.com: domain of 3WstESwUPCLUeVhZnbmVtnjaodiX.XjhmpWt-aadbjjbgZbmjpkn.Xjh@listserv.bounces.google.com designates 209.85.211.137 as permitted sender) smtp.mail=3WstESwUPCLUeVhZnbmVtnjaodiX.XjhmpWt-aadbjjbgZbmjpkn.Xjh@listserv.bounces.google.com; dkim=pass (test mode) header.i=@googlegroups.com
Received: by ywh1 with SMTP id 1sf46374400ywh.22
        for <headius@headius.com>; Wed, 06 Jan 2010 09:41:47 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=googlegroups.com; s=beta;
        h=domainkey-signature:received:x-beenthere:received:received:received
         :received:received-spf:received:mime-version:received:date:x-ip
         :user-agent:x-http-useragent:message-id:subject:from:to
         :x-original-authentication-results:x-original-sender:reply-to
         :precedence:mailing-list:list-id:list-post:list-help:list-archive
         :x-thread-url:x-message-url:sender:list-unsubscribe:list-subscribe
         :content-type;
        bh=ex9pzJVlpKN8SoCAy38jxLR9ebZDsKzfSlPHpPNw9iM=;
        b=fBdf/k0E+cWUuDJRVm+GPfG8ASWc1gLmamaAp3aR/05UcmVIsP8xB3qTpDZ5KmYmuM
         /Lp4R0FyGF+plhMUbUtjN6LJ+J2qmg7ROjhQymQpClqBEjXWz7KdcdDmydwsxqFLBTrr
         sIiuiC7hfzYUvwi8+M5wPiCmF/Ljvh1FQNvfA=
DomainKey-Signature: a=rsa-sha1; c=nofws;
        d=googlegroups.com; s=beta;
        h=x-beenthere:received-spf:mime-version:date:x-ip:user-agent
         :x-http-useragent:message-id:subject:from:to
         :x-original-authentication-results:x-original-sender:reply-to
         :precedence:mailing-list:list-id:list-post:list-help:list-archive
         :x-thread-url:x-message-url:sender:list-unsubscribe:list-subscribe
         :content-type;
        b=RvumJPMMt9wxbDC9JeHTjcIuiQz9ax9vOQwmhTLpdCIFUdfmeXtBf2FBZeLyDzNKNi
         Xn1X1Ib8f1C50IEkuTUHLEAX1X/VaRa5c5iOZB+yRTHmUdjBUcAfYlB8i4oeA5I/+0Vm
         Z4dKBL1zQg4apfWl3hx3cF3mZHr6LuKAMl0DA=
Received: by 10.150.90.2 with SMTP id n2mr2087299ybb.55.1262799706259;
        Wed, 06 Jan 2010 09:41:46 -0800 (PST)
X-BeenThere: ruby-ffi@googlegroups.com
Received: by 10.151.2.23 with SMTP id e23ls925086ybi.1.p; Wed, 06 Jan 2010 
	09:41:45 -0800 (PST)
Received: by 10.150.75.7 with SMTP id x7mr10329808yba.17.1262799705484;
        Wed, 06 Jan 2010 09:41:45 -0800 (PST)
Received: by 10.150.75.7 with SMTP id x7mr10329801yba.17.1262799705292;
        Wed, 06 Jan 2010 09:41:45 -0800 (PST)
Return-Path: <james@graysoftinc.com>
Received: from mail-yw0-f144.google.com (mail-yw0-f144.google.com [209.85.211.144])
        by gmr-mx.google.com with ESMTP id 19si2847136ywh.6.2010.01.06.09.41.45;
        Wed, 06 Jan 2010 09:41:45 -0800 (PST)
Received-SPF: neutral (google.com: 209.85.211.144 is neither permitted nor denied by best guess record for domain of james@graysoftinc.com) client-ip=209.85.211.144;
Received: by mail-yw0-f144.google.com with SMTP id 8so51090574ywh.3
        for <ruby-ffi@googlegroups.com>; Wed, 06 Jan 2010 09:41:45 -0800 (PST)
MIME-Version: 1.0
Received: by 10.101.180.36 with SMTP id h36mr2897028anp.54.1262799704866; Wed, 
	06 Jan 2010 09:41:44 -0800 (PST)
Date: Wed, 6 Jan 2010 09:41:44 -0800 (PST)
X-IP: 72.198.101.76
User-Agent: G2/1.0
X-HTTP-UserAgent: Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10_6_2; en-us) 
	AppleWebKit/531.21.8 (KHTML, like Gecko) Version/4.0.4 Safari/531.21.10,gzip(gfe),gzip(gfe)
Message-ID: <bd5613e0-04a8-45d5-8fd1-e6550cf11dd7@q4g2000yqm.googlegroups.com>
Subject: [ruby-ffi] Pointer Freeing Bug
From: JEG2 <james@graysoftinc.com>
To: ruby-ffi <ruby-ffi@googlegroups.com>
X-Original-Authentication-Results: gmr-mx.google.com; spf=neutral (google.com: 
	209.85.211.144 is neither permitted nor denied by best guess record for 
	domain of james@graysoftinc.com) smtp.mail=james@graysoftinc.com
X-Original-Sender: james@graysoftinc.com
Reply-To: ruby-ffi@googlegroups.com
Precedence: list
Mailing-list: list ruby-ffi@googlegroups.com; contact ruby-ffi+owners@googlegroups.com
List-ID: <ruby-ffi.googlegroups.com>
List-Post: <http://groups.google.com/group/ruby-ffi/post?hl=>, 
	<mailto:ruby-ffi@googlegroups.com>
List-Help: <http://groups.google.com/support/?hl=>, <mailto:ruby-ffi+help@googlegroups.com>
List-Archive: <http://groups.google.com/group/ruby-ffi?hl=>
X-Thread-Url: http://groups.google.com/group/ruby-ffi/t/9f891a35886cb969
X-Message-Url: http://groups.google.com/group/ruby-ffi/msg/688dcda42f86ab19
Sender: ruby-ffi@googlegroups.com
List-Unsubscribe: <http://groups.google.com/group/ruby-ffi/subscribe?hl=>, 
	<mailto:ruby-ffi+unsubscribe@googlegroups.com>
List-Subscribe: <http://groups.google.com/group/ruby-ffi/subscribe?hl=>, 
	<mailto:ruby-ffi+subscribe@googlegroups.com>
Content-Type: text/plain; charset=ISO-8859-1

I'm working on a new FFI interface to Tokyo Cabinet and have run into
a difficult to debug issue.  If I run individual files in my test
suite, they pass just fine.  When I run them all together though, I
have started seeing this issue:

(in /Users/james/Documents/oklahoma_mixer)
/usr/local/bin/ruby -w -I"lib:test" "/usr/local/lib/ruby/gems/1.8/gems/
rake-0.8.7/lib/rake/rake_test_loader.rb" "test/
b_tree_binary_data_test.rb" "test/b_tree_tuning_test.rb" "test/
binary_data_test.rb" "test/cursor_based_iteration_test.rb" "test/
duplicate_storage_test.rb" "test/file_system_test.rb" "test/
getting_and_setting_keys_test.rb" "test/iteration_test.rb" "test/
key_range_test.rb" "test/order_test.rb" "test/
top_level_interface_test.rb" "test/transactions_test.rb" "test/
tuning_test.rb"
Loaded suite /usr/local/lib/ruby/gems/1.8/gems/rake-0.8.7/lib/rake/
rake_test_loader
Started
.......................................................................................................................................ruby
(610) malloc: *** error for object 0x101c42060: pointer being freed
was not allocated
*** set a breakpoint in malloc_error_break to debug
rake aborted!
Command failed with status (): [/usr/local/bin/ruby -w -I"lib:test" "/
usr/...]

(See full trace by running task with --trace)

I'm pretty sure I'm looking at a bug that's triggered during GC here.

I thought the "ruby malloc" was a sign that Ruby is freeing up memory
before it allocates more.

Also, as I said, all of my tests work fine when run alone.  It's not
until they are combined that the problem surfaces.  I assume it's the
longer run triggering GC.

Is this sounding right?

I assume it almost has to be an FFI object being freed.  I mean, Ruby
wouldn't try to free some memory allocated by Tokyo Cabinet, right?
Are there FFI objects that try to free something as they are GCed?

Any tips for the best way to isolate this issue are greatly
appreciated.

James Edward Gray II
