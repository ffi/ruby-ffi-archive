<html>
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>[ruby-ffi] Install ffi on Mac gives trouble with asm insert</title>
<link rel="important stylesheet" href="">
<style>div.headerdisplayname {font-weight:bold;}</style></head>
<body>
<table border=0 cellspacing=0 cellpadding=0 width="100%" class="header-part1"><tr><td><div class="headerdisplayname" style="display:inline;">Subject: </div>[ruby-ffi] Install ffi on Mac gives trouble with asm insert</td></tr><tr><td><div class="headerdisplayname" style="display:inline;">From: </div>Jim Clarke <clarke@cs.utoronto.ca></td></tr><tr><td><div class="headerdisplayname" style="display:inline;">Date: </div>7/23/12 2:19 PM</td></tr></table><table border=0 cellspacing=0 cellpadding=0 width="100%" class="header-part2"><tr><td><div class="headerdisplayname" style="display:inline;">To: </div>ruby-ffi@googlegroups.com</td></tr></table><br>
<div class="moz-text-html"  lang="x-unicode"><div>The problem: &nbsp;Installing ffi-1.1.0 on my Mac (system details below) produces</div><div>output including this error message:</div><div><br></div><div>---------</div><div><span class="Apple-style-span" style="font-family: 'courier new', monospace; ">$ gem install ffi</span><br></div><div><font class="Apple-style-span" face="'courier new', monospace">Building native extensions. &nbsp;This could take a while...</font></div><div><font class="Apple-style-span" face="'courier new', monospace">ERROR: &nbsp;Error installing ffi:</font></div><div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; &nbsp; ERROR: Failed to build gem native extension.</font></div><div><font class="Apple-style-span" face="'courier new', monospace"><br></font></div><div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; &nbsp; /Users/clarke/.rvm/rubies/ruby-1.9.3-p194/bin/ruby extconf.rb</font></div><div><font class="Apple-style-span" face="'courier new', monospace">checking for ffi_call() in -lffi... yes</font></div><div><font class="Apple-style-span" face="'courier new', monospace">checking for ffi_prep_closure()... yes</font></div><div><font class="Apple-style-span" face="'courier new', monospace">checking for ffi_raw_call()... yes</font></div><div><font class="Apple-style-span" face="'courier new', monospace">checking for ffi_prep_raw_closure()... yes</font></div><div><font class="Apple-style-span" face="'courier new', monospace">checking for rb_thread_blocking_region()... yes</font></div><div><font class="Apple-style-span" face="'courier new', monospace">checking for ruby_native_thread_p()... yes</font></div><div><font class="Apple-style-span" face="'courier new', monospace">checking for rb_thread_call_with_gvl()... yes</font></div><div><font class="Apple-style-span" face="'courier new', monospace">creating extconf.h</font></div><div><font class="Apple-style-span" face="'courier new', monospace">creating Makefile</font></div><div><font class="Apple-style-span" face="'courier new', monospace"><br></font></div><div><font class="Apple-style-span" face="'courier new', monospace">make</font></div><div><font class="Apple-style-span" face="'courier new', monospace">[...]</font></div><div><font class="Apple-style-span" face="'courier new', monospace">compiling MethodHandle.c</font></div><div><font class="Apple-style-span" face="'courier new', monospace">MethodHandle.c:204: error: expected declaration specifiers or '...' before string constant</font></div><div><font class="Apple-style-span" face="'courier new', monospace">[...]</font></div><div><font class="Apple-style-span" face="'courier new', monospace">make: *** [MethodHandle.o] Error 1</font></div><div><font class="Apple-style-span" face="'courier new', monospace"><br></font></div><div><font class="Apple-style-span" face="'courier new', monospace"><br></font></div><div><font class="Apple-style-span" face="'courier new', monospace">Gem files will remain installed in /Users/clarke/.rvm/gems/ruby-1.9.3-p194/gems/ffi-1.1.0 for inspection.</font></div><div><font class="Apple-style-span" face="'courier new', monospace">Results logged to /Users/clarke/.rvm/gems/ruby-1.9.3-p194/gems/ffi-1.1.0/ext/ffi_c/gem_make.out</font></div><div>---------<br></div><div><br></div><div>Essentially the same error appeared with ffi-1.0.11. Given the line number,</div><div>it seems that the asm() insert is being rejected.</div><div><br></div><div>My system:</div><div>Mac OX X 10.7.4 (Lion)</div><div>Xcode 4.3.3</div><div>gcc: i686-apple-darwin11-llvm-gcc-4.2 (GCC) 4.2.1</div><div><br></div><div>---------</div><div><br></div><div>Here are two changes, either one of which seems to allow make to run in the ext directory.</div><div>Both changes affect&nbsp;this line in ext/Makefile:</div><div><br></div><div><font class="Apple-style-span" face="'courier new', monospace">CFLAGS &nbsp; = -fno-common -std=c99 -pedantic -Wall -fno-common -pipe -I/opt/local/lib/libffi-3.0.11/include &nbsp; $(ARCH_FLAG)</font></div><div><br></div><div>First fix: remove <font class="Apple-style-span" face="'courier new', monospace">-std=c99</font></div><div><br></div><div><i><b>or</b></i></div><div><br></div><div>Second fix: replace&nbsp;<span class="Apple-style-span" style="font-family: 'courier new', monospace; ">-std=c99</span>&nbsp;with <font class="Apple-style-span" face="'courier new', monospace">-std=gnu99</font></div><div><br></div><div>Since I don't do much C programming on the Mac (and have never used asm in a</div><div>C program), and since I'm totally new to Ruby, I offer these fixes&nbsp;more as guesses</div><div>than as firm suggestions. However, Googling turned up one or&nbsp;two unresolved</div><div>queries about the same problem, so maybe I'm not alone?</div><div><br></div><div>I'd be a little unhappy to try becoming my own ffi expert. Any chance of a</div><div>more authoritative fix?</div><div><br></div>
</div></body>
</html>
</table></div>