Delivered-To: headius@headius.com
Received: by 10.224.67.198 with SMTP id s6cs279397qai;
        Mon, 14 Sep 2009 13:23:14 -0700 (PDT)
Received: by 10.101.10.13 with SMTP id n13mr6633299ani.88.1252959793833;
        Mon, 14 Sep 2009 13:23:13 -0700 (PDT)
Return-Path: <grbounce-oS_-awUAAACicsVXPUFstTOYQmrUJNfw=headius=headius.com@googlegroups.com>
Received: from mail-iw0-f163.google.com (mail-iw0-f163.google.com [209.85.223.163])
        by mx.google.com with ESMTP id 7si11406057iwn.76.2009.09.14.13.23.12;
        Mon, 14 Sep 2009 13:23:12 -0700 (PDT)
Received-SPF: pass (google.com: domain of grbounce-oS_-awUAAACicsVXPUFstTOYQmrUJNfw=headius=headius.com@googlegroups.com designates 209.85.223.163 as permitted sender) client-ip=209.85.223.163;
Authentication-Results: mx.google.com; spf=pass (google.com: domain of grbounce-oS_-awUAAACicsVXPUFstTOYQmrUJNfw=headius=headius.com@googlegroups.com designates 209.85.223.163 as permitted sender) smtp.mail=grbounce-oS_-awUAAACicsVXPUFstTOYQmrUJNfw=headius=headius.com@googlegroups.com; dkim=pass (test mode) header.i=@googlegroups.com
Received: by iwn35 with SMTP id 35so1202197iwn.22
        for <headius@headius.com>; Mon, 14 Sep 2009 13:23:12 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=googlegroups.com; s=beta;
        h=domainkey-signature:received:received:x-sender:x-apparently-to
         :received:received:received:received-spf:received:dkim-signature
         :domainkey-signature:mime-version:received:in-reply-to:references
         :date:message-id:subject:from:to:content-type
         :content-transfer-encoding:reply-to:sender:precedence:x-google-loop
         :mailing-list:list-id:list-post:list-help:list-unsubscribe
         :x-beenthere-env:x-beenthere;
        bh=0cQ2HCVjI53PWeiuDrPd3ujgCijaGNUBh96OAp+a20I=;
        b=p3HmgA6ocHyrIh5bhSiTJX/conQTfRF4EHUO539fjw+KMr/Ix2PcCl9nqTj9UWiH6l
         nDddrm98uOuT3WWoRSuIjN7xW1q2GzJN/F6HeCmcrHOiOXt/SaF4DXTqMUDnBdgjLIBl
         CYCB4z1lAFAYf7cIG4qsMecHvcZZY8HCifg9E=
DomainKey-Signature: a=rsa-sha1; c=nofws;
        d=googlegroups.com; s=beta;
        h=x-sender:x-apparently-to:received-spf:authentication-results
         :dkim-signature:domainkey-signature:mime-version:in-reply-to
         :references:date:message-id:subject:from:to:content-type
         :content-transfer-encoding:reply-to:sender:precedence:x-google-loop
         :mailing-list:list-id:list-post:list-help:list-unsubscribe
         :x-beenthere-env:x-beenthere;
        b=6lLZAL0jmMueBLjhwcD5plIXqU2WEKwb36OBiyEz3qMBm1Ba1Exq8k0JxJDFzAlovL
         SYEmmdkx4VMNlQ3Soz6c3idCbWdaw89/GHGaiev821z6fyiP5xhevt3ssbD1ICqZ1bBf
         UzvUaserRFYcmxNYtW+ANJ1nXLbs9L5fi6dHM=
Received: by 10.150.18.31 with SMTP id 31mr2055757ybr.11.1252959790576;
        Mon, 14 Sep 2009 13:23:10 -0700 (PDT)
Received: by 10.176.133.2 with SMTP id g2gr23yqd.0;
	Mon, 14 Sep 2009 13:23:10 -0700 (PDT)
X-Sender: themastermind1@gmail.com
X-Apparently-To: ruby-ffi@googlegroups.com
Received: by 10.101.194.31 with SMTP id w31mr3527481anp.25.1252959790142; Mon, 14 Sep 2009 13:23:10 -0700 (PDT)
Received: by 10.101.194.31 with SMTP id w31mr3527480anp.25.1252959790119; Mon, 14 Sep 2009 13:23:10 -0700 (PDT)
Return-Path: <themastermind1@gmail.com>
Received: from mail-yw0-f178.google.com (mail-yw0-f178.google.com [209.85.211.178]) by gmr-mx.google.com with ESMTP id 19si654939ywh.10.2009.09.14.13.23.09; Mon, 14 Sep 2009 13:23:09 -0700 (PDT)
Received-SPF: pass (google.com: domain of themastermind1@gmail.com designates 209.85.211.178 as permitted sender) client-ip=209.85.211.178;
Received: by mail-yw0-f178.google.com with SMTP id 8so5502553ywh.14 for <ruby-ffi@googlegroups.com>; Mon, 14 Sep 2009 13:23:09 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=gamma; h=domainkey-signature:mime-version:received:in-reply-to:references :date:message-id:subject:from:to:content-type :content-transfer-encoding; bh=fw2leEXRNII8+JYaxgCnCeksCJAlPArsyEUZ+e855qI=; b=T+fKDyIvBYbNeI2ENXBk2f/JJOReblBBD4t3LdKLU6ZV2HLWw4chTByGdbew05lkMP KSDf+t5nUv3JvCzz6wQsm5BQPpEyuiBlqyi7rCG+scUf9nICB3sZNHWyTUnDk3djjDIV DBcTtxHpuXyw7Z2W6PZkKuGwvlqHqsJpFpbp0=
DomainKey-Signature: a=rsa-sha1; c=nofws; d=gmail.com; s=gamma; h=mime-version:in-reply-to:references:date:message-id:subject:from:to :content-type:content-transfer-encoding; b=i3UPLX/e3UTPmT0NJq/6rdPTq04ultZLF8C6MtzK/w1v4AAgiudGVtwf8D+YP7cTfq Y/ymNFxCtJJpNp8S2tidgJYEeerdXcrPVBhu0v9fWlU6LAtnQxklzsp/d21P7v0LHwOM GjOhrlzb+DUjn0c2WfDFuEfnB7ZdGl3HslDLc=
MIME-Version: 1.0
Received: by 10.150.104.11 with SMTP id b11mr10822240ybc.21.1252959788745;  Mon, 14 Sep 2009 13:23:08 -0700 (PDT)
In-Reply-To: <1252952479-sup-7349@ganimoide>
References: <c5a49969-580f-4bfd-8d72-23b5e677a28c@l35g2000pra.googlegroups.com> <1252952479-sup-7349@ganimoide>
Date: Mon, 14 Sep 2009 13:23:08 -0700
Message-ID: <e1c05edd0909141323w2e21ae32w4d5e94a7bf43ba2d@mail.gmail.com>
Subject: [ruby-ffi] Re: cannot define function pointers that take function 
 pointer arguments in jruby struct layout
From: Aman Gupta <themastermind1@gmail.com>
To: ruby-ffi@googlegroups.com
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: quoted-printable
Reply-To: ruby-ffi@googlegroups.com
Sender: ruby-ffi@googlegroups.com
Precedence: bulk
X-Google-Loop: groups
Mailing-List: list ruby-ffi@googlegroups.com;
	contact ruby-ffi+owner@googlegroups.com
List-Id: <ruby-ffi.googlegroups.com>
List-Post: <mailto:ruby-ffi@googlegroups.com>
List-Help: <mailto:ruby-ffi+help@googlegroups.com>
List-Unsubscribe: <http://googlegroups.com/group/ruby-ffi/subscribe>,
	<mailto:ruby-ffi+unsubscribe@googlegroups.com>
X-BeenThere-Env: ruby-ffi@googlegroups.com
X-BeenThere: ruby-ffi@googlegroups.com


On Mon, Sep 14, 2009 at 11:35 AM, Andrea Fazzi <andrea.fazzi@alcacoop.it> w=
rote:
>
> Excerpts from Aman Gupta's message of lun set 14 11:28:58 +0200 2009:
>>
>> I'm using ffi-swig-generator on:
>>
>> typedef void (*MyCallback) (void *data);
>> typedef struct {
>> =A0 void (*member) (MyCallback cb);
>> } MyStruct;
>>
>> which generates:
>>
>> =A0 callback(:MyCallback, [ :pointer ], :void)
>> =A0 class MyStruct < FFI::Struct
>> =A0 =A0 layout(
>> =A0 =A0 =A0 :member, callback([ :MyCallback ], :void)
>> =A0 =A0 )
>> =A0 end
>>
>> This works fine on with ruby-ffi, but on jruby I get:
>>
>> /custom/jruby/lib/ruby/1.8/ffi/types.rb:17:in `find_type': Unable to
>> resolve type 'MyCallback' (FFI::TypeError)
>> =A0 =A0 from /custom/jruby/lib/ruby/1.8/ffi/library.rb:213:in `find_type=
'
>> =A0 =A0 from /custom/jruby/lib/ruby/1.8/ffi/struct.rb:149:in `find_type'
>> =A0 =A0 from /custom/jruby/lib/ruby/1.8/ffi/library.rb:148:in `callback'
>> =A0 =A0 from /custom/jruby/lib/ruby/1.8/ffi/library.rb:148:in `each'
>> =A0 =A0 from /custom/jruby/lib/ruby/1.8/ffi/library.rb:148:in `map'
>> =A0 =A0 from /custom/jruby/lib/ruby/1.8/ffi/library.rb:148:in `callback'
>
> Ruby-FFI support for callback parameters in callbacks was added in rev
>
> 8d6045c2305f32929f4da5a28d28397523df0170
>
> Maybe that JRuby still doesn't implement it?

JRuby supports it, just doesn't recognize the callback if its defined
before the struct the way ffi-swig-generator does it. The issue is in
FFI::Struct#find_type, but I got very confused trying to fix it.

If I nest the callback definition inline, it works as expected:

  class MyStruct < FFI::Struct
    layout(
      :member, callback([ callback([ :pointer ], :void) ], :void)
    )
  end

>
> --
> Andrea Fazzi @ alca.le.it
> Follow me on http://twitter.com/remogatto
>
