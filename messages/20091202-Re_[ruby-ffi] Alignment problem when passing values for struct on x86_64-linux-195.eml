Delivered-To: headius@headius.com
Received: by 10.142.52.18 with SMTP id z18cs380751wfz;
        Wed, 2 Dec 2009 02:53:13 -0800 (PST)
Received: by 10.114.3.17 with SMTP id 17mr928002wac.210.1259751193577;
        Wed, 02 Dec 2009 02:53:13 -0800 (PST)
Return-Path: <3F0cWSwkJCL81rjnxxsjwlrfnq.htrwzg3-kknlttlqjlwtzux.htr@listserv.bounces.google.com>
Received: from mail-px0-f150.google.com (mail-px0-f150.google.com [209.85.216.150])
        by mx.google.com with ESMTP id 27si1136033pxi.41.2009.12.02.02.53.12;
        Wed, 02 Dec 2009 02:53:12 -0800 (PST)
Received-SPF: pass (google.com: domain of 3F0cWSwkJCL81rjnxxsjwlrfnq.htrwzg3-kknlttlqjlwtzux.htr@listserv.bounces.google.com designates 209.85.216.150 as permitted sender) client-ip=209.85.216.150;
Authentication-Results: mx.google.com; spf=pass (google.com: domain of 3F0cWSwkJCL81rjnxxsjwlrfnq.htrwzg3-kknlttlqjlwtzux.htr@listserv.bounces.google.com designates 209.85.216.150 as permitted sender) smtp.mail=3F0cWSwkJCL81rjnxxsjwlrfnq.htrwzg3-kknlttlqjlwtzux.htr@listserv.bounces.google.com; dkim=pass (test mode) header.i=@gmail.com
Received: by pxi14 with SMTP id 14sf16924pxi.3
        for <headius@headius.com>; Wed, 02 Dec 2009 02:53:12 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=gamma;
        h=domainkey-signature:received:x-beenthere:received:received:received
         :received:received-spf:received:mime-version:received:in-reply-to
         :references:date:message-id:subject:from:to
         :x-original-authentication-results:reply-to:precedence:mailing-list
         :list-id:list-post:list-help:list-archive:x-thread-url:x-message-url
         :list-unsubscribe:list-subscribe:content-type
         :content-transfer-encoding;
        bh=9DVS4hzwUS3Yhp7RLIR4Lepf1fKOJITSIKd4yvZYzwg=;
        b=L+LMBKX+o8wR2QZFapVxrhFlmdO5qDfnAQv3X7TGTzXUVrp4eC0AQAN4txQhFdP61j
         ogk0H1yxXNbrmbIov4+NsKdLzbp37G+k8F6zVGqL4QMr8ZGhe3JTe0iLLwW2DUNyZFWv
         LM8NV2FCfGNXkf1vihxcbNeqYAyAFk0zTD3do=
DomainKey-Signature: a=rsa-sha1; c=nofws;
        d=gmail.com; s=gamma;
        h=x-beenthere:received-spf:mime-version:in-reply-to:references:date
         :message-id:subject:from:to:x-original-authentication-results
         :reply-to:precedence:mailing-list:list-id:list-post:list-help
         :list-archive:x-thread-url:x-message-url:list-unsubscribe
         :list-subscribe:content-type:content-transfer-encoding;
        b=gY++YWuZPvnC86lbj1c+FzZILv9J+2zFxOqrskwAcXS66h4STqn6UF93GykPM0AR/j
         znOlqUyMU1gpdJ/sj73g7M4kbHAL5oTe8FlpEU8V6ny42mTg2HZdeVV/MuD6iRNbf9yn
         xH92ORRq1YmOT+ARgEdKgoh80o2Bge1BLrcd4=
Received: by 10.115.100.14 with SMTP id c14mr449413wam.8.1259751191098;
        Wed, 02 Dec 2009 02:53:11 -0800 (PST)
X-BeenThere: ruby-ffi@googlegroups.com
Received: by 10.114.187.1 with SMTP id k1ls4082108waf.0.p; Wed, 02 Dec 2009 
	02:53:09 -0800 (PST)
Received: by 10.115.66.17 with SMTP id t17mr1449421wak.11.1259751189237;
        Wed, 02 Dec 2009 02:53:09 -0800 (PST)
Received: by 10.115.66.17 with SMTP id t17mr1449420wak.11.1259751189216;
        Wed, 02 Dec 2009 02:53:09 -0800 (PST)
Return-Path: <wmeissner@gmail.com>
Received: from mail-pw0-f54.google.com (mail-pw0-f54.google.com [209.85.160.54])
        by gmr-mx.google.com with ESMTP id 19si120168pzk.8.2009.12.02.02.53.06;
        Wed, 02 Dec 2009 02:53:08 -0800 (PST)
Received-SPF: pass (google.com: domain of wmeissner@gmail.com designates 209.85.160.54 as permitted sender) client-ip=209.85.160.54;
Received: by mail-pw0-f54.google.com with SMTP id 2so42902pwj.33
        for <ruby-ffi@googlegroups.com>; Wed, 02 Dec 2009 02:53:06 -0800 (PST)
MIME-Version: 1.0
Received: by 10.141.14.20 with SMTP id r20mr394133rvi.190.1259751186082; Wed, 
	02 Dec 2009 02:53:06 -0800 (PST)
In-Reply-To: <e715fca9-d6d3-49a0-ba4f-e1beafe6bd9f@v25g2000yqk.googlegroups.com>
References: <e715fca9-d6d3-49a0-ba4f-e1beafe6bd9f@v25g2000yqk.googlegroups.com>
Date: Wed, 2 Dec 2009 20:53:06 +1000
Message-ID: <4ccee320912020253w4299d5cbsa1d9cf211691315b@mail.gmail.com>
Subject: Re: [ruby-ffi] Alignment problem when passing values for struct on 
	x86_64-linux
From: Wayne Meissner <wmeissner@gmail.com>
To: ruby-ffi@googlegroups.com
X-Original-Authentication-Results: gmr-mx.google.com; spf=pass (google.com: 
	domain of wmeissner@gmail.com designates 209.85.160.54 as permitted sender) 
	smtp.mail=wmeissner@gmail.com; dkim=pass (test mode) header.i=@gmail.com
Reply-To: ruby-ffi@googlegroups.com
Precedence: list
Mailing-list: list ruby-ffi@googlegroups.com; contact ruby-ffi+owners@googlegroups.com
List-ID: <ruby-ffi.googlegroups.com>
List-Post: <http://groups.google.com/group/ruby-ffi/post?hl=>, 
	<mailto:ruby-ffi@googlegroups.com>
List-Help: <http://groups.google.com/support/?hl=>, <mailto:ruby-ffi+help@googlegroups.com>
List-Archive: <http://groups.google.com/group/ruby-ffi?hl=>
X-Thread-Url: http://groups.google.com/group/ruby-ffi/t/c32935ad47141ab2
X-Message-Url: http://groups.google.com/group/ruby-ffi/msg/d3512949168dce55
List-Unsubscribe: <http://groups.google.com/group/ruby-ffi/subscribe?hl=>, 
	<mailto:ruby-ffi+unsubscribe@googlegroups.com>
List-Subscribe: <http://groups.google.com/group/ruby-ffi/subscribe?hl=>, 
	<mailto:ruby-ffi+subscribe@googlegroups.com>
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: quoted-printable

2009/12/2 rhp <ronald.pijnacker@gmail.com>:
> --- ffi_test.rb
> #!/usr/bin/ruby -w
>
> require 'rubygems'
> require 'ffi'
>
> module TestFFI extend FFI::Library
> =A0 =A0ffi_lib 'ffi'
> =A0 =A0attach_function :test, [:pointer, :int, :int, :int], :void
> end
>
> ptr =3D FFI::MemoryPointer.new :float, 10
> TestFFI.test(ptr, 10, 1, 2)

That won't pass a struct by value on x86_64 (and it only does it on
i386 due to the way arguments are packed).

Instead, you need:

class S < FFI::Struct
  layout :a, :int, :b, :int
end

module TestFFI
  extend FFI::Library
  attach_function :test, [ :pointer, :int, S.by_value ], :void
end

s =3D S.new
s[:a] =3D 1
s[:b] =3D 2
ptr =3D FFI::MemoryPointer.new :float, 10
TestFFI.test(ptr, 10, s)
