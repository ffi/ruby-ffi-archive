Delivered-To: headius@headius.com
Received: by 10.100.198.7 with SMTP id v7cs116945anf;
        Wed, 20 Apr 2011 13:25:39 -0700 (PDT)
Received: by 10.42.240.66 with SMTP id kz2mr9842517icb.467.1303331139011;
        Wed, 20 Apr 2011 13:25:39 -0700 (PDT)
Return-Path: <ruby-ffi+bncCJ2jt8vbBhC9gr3tBBoER3iq-A@googlegroups.com>
Received: from mail-pv0-f190.google.com (mail-pv0-f190.google.com [74.125.83.190])
        by mx.google.com with ESMTPS id ul5si2759128icb.105.2011.04.20.13.25.38
        (version=TLSv1/SSLv3 cipher=OTHER);
        Wed, 20 Apr 2011 13:25:39 -0700 (PDT)
Received-SPF: pass (google.com: domain of ruby-ffi+bncCJ2jt8vbBhC9gr3tBBoER3iq-A@googlegroups.com designates 74.125.83.190 as permitted sender) client-ip=74.125.83.190;
Authentication-Results: mx.google.com; spf=pass (google.com: domain of ruby-ffi+bncCJ2jt8vbBhC9gr3tBBoER3iq-A@googlegroups.com designates 74.125.83.190 as permitted sender) smtp.mail=ruby-ffi+bncCJ2jt8vbBhC9gr3tBBoER3iq-A@googlegroups.com; dkim=pass (test mode) header.i=@googlegroups.com
Received: by pvg3 with SMTP id 3sf540611pvg.7
        for <headius@headius.com>; Wed, 20 Apr 2011 13:25:38 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=googlegroups.com; s=beta;
        h=domainkey-signature:x-beenthere:received-spf:mime-version
         :x-proofpoint-virus-version:x-proofpoint-spam-details:subject:from
         :in-reply-to:date:message-id:references:to:x-mailer
         :x-original-sender:x-original-authentication-results:reply-to
         :precedence:mailing-list:list-id:x-google-group-id:list-post
         :list-help:list-archive:sender:list-subscribe:list-unsubscribe
         :content-transfer-encoding:content-type;
        bh=TSqxj6KOytupOoD2mymcHkKq23Kp54s9uebxZidvD98=;
        b=4y1W8+NwfhCGfSulKAlmBR9sEFjzSj5BpsadkVkOVXnNGEEnnlzH4HfvMiNukwJNtb
         PHnMLvk8Bd58YiNDRobdtD6X+RNe1lOrHXmIANI/+nBYVZ58l2fKD7N6WWXFlDjazj0E
         sZs6IfVw89BobvdPuLDtUaxuoDl34qxY07wQw=
DomainKey-Signature: a=rsa-sha1; c=nofws;
        d=googlegroups.com; s=beta;
        h=x-beenthere:received-spf:mime-version:x-proofpoint-virus-version
         :x-proofpoint-spam-details:subject:from:in-reply-to:date:message-id
         :references:to:x-mailer:x-original-sender
         :x-original-authentication-results:reply-to:precedence:mailing-list
         :list-id:x-google-group-id:list-post:list-help:list-archive:sender
         :list-subscribe:list-unsubscribe:content-transfer-encoding
         :content-type;
        b=iVA4NNx60INHNGbB4RLhV+rLRiGq2zbwrdtsrefGBprGir6fzhlJxjpVWy/eUSYS5U
         FGwOuUdh7PGR4Vuwa3Q+Zc9xe1+YH0swgPpMn1vdBmdY+8rdYzWRWE48cORdiZ595Ds6
         5Nm9btv+Eck/+QqttSt+FPOCtDH27OLD8IQgA=
Received: by 10.68.41.7 with SMTP id b7mr915011pbl.60.1303331133238;
        Wed, 20 Apr 2011 13:25:33 -0700 (PDT)
X-BeenThere: ruby-ffi@googlegroups.com
Received: by 10.68.39.41 with SMTP id m9ls3269384pbk.2.gmail; Wed, 20 Apr 2011
 13:25:32 -0700 (PDT)
Received: by 10.68.6.1 with SMTP id w1mr1111797pbw.50.1303331132020;
        Wed, 20 Apr 2011 13:25:32 -0700 (PDT)
Received: by 10.68.6.1 with SMTP id w1mr1111796pbw.50.1303331132007;
        Wed, 20 Apr 2011 13:25:32 -0700 (PDT)
Received: from asmtpout021.mac.com (asmtpout021.mac.com [17.148.16.96])
        by gmr-mx.google.com with ESMTP id v3si518842pbp.11.2011.04.20.13.25.31;
        Wed, 20 Apr 2011 13:25:32 -0700 (PDT)
Received-SPF: pass (google.com: domain of cremes.devlist@mac.com designates 17.148.16.96 as permitted sender) client-ip=17.148.16.96;
MIME-version: 1.0
Received: from [192.168.0.101] (unknown [76.8.86.186])
 by asmtp021.mac.com (Oracle Communications Messaging Exchange Server 7u4-20.01
 64bit (built Nov 21 2010)) with ESMTPSA id <0LJY008PYWQ2HG30@asmtp021.mac.com>
 for ruby-ffi@googlegroups.com; Wed, 20 Apr 2011 13:25:16 -0700 (PDT)
X-Proofpoint-Virus-Version: vendor=fsecure
 engine=2.50.10432:5.2.15,1.0.148,0.0.0000
 definitions=2011-04-20_07:2011-04-20,2011-04-20,1970-01-01 signatures=0
X-Proofpoint-Spam-Details: rule=notspam policy=default score=0 spamscore=0
 ipscore=0 suspectscore=4 phishscore=0 bulkscore=0 adultscore=0 classifier=spam
 adjust=0 reason=mlx engine=6.0.2-1012030000 definitions=main-1104200101
Subject: Re: [ruby-ffi] can't explain this behavior
From: Chuck Remes <cremes.devlist@mac.com>
In-reply-to: <527e0f31-eb4b-4145-9495-d2c04422519e@j25g2000vbr.googlegroups.com>
Date: Wed, 20 Apr 2011 15:25:09 -0500
Message-id: <BD5B1BA2-E784-41DD-82AB-2A3063CC2A47@mac.com>
References: <527e0f31-eb4b-4145-9495-d2c04422519e@j25g2000vbr.googlegroups.com>
To: ruby-ffi@googlegroups.com
X-Mailer: Apple Mail (2.1082)
X-Original-Sender: cremes.devlist@mac.com
X-Original-Authentication-Results: gmr-mx.google.com; spf=pass (google.com:
 domain of cremes.devlist@mac.com designates 17.148.16.96 as permitted sender) smtp.mail=cremes.devlist@mac.com
Reply-To: ruby-ffi@googlegroups.com
Precedence: list
Mailing-list: list ruby-ffi@googlegroups.com; contact ruby-ffi+owners@googlegroups.com
List-ID: <ruby-ffi.googlegroups.com>
X-Google-Group-Id: 238405446264
List-Post: <http://groups.google.com/group/ruby-ffi/post?hl=en_US>, <mailto:ruby-ffi@googlegroups.com>
List-Help: <http://groups.google.com/support/?hl=en_US>, <mailto:ruby-ffi+help@googlegroups.com>
List-Archive: <http://groups.google.com/group/ruby-ffi?hl=en_US>
Sender: ruby-ffi@googlegroups.com
List-Subscribe: <http://groups.google.com/group/ruby-ffi/subscribe?hl=en_US>, <mailto:ruby-ffi+subscribe@googlegroups.com>
List-Unsubscribe: <http://groups.google.com/group/ruby-ffi/subscribe?hl=en_US>,
 <mailto:ruby-ffi+unsubscribe@googlegroups.com>
Content-transfer-encoding: 7BIT
Content-type: text/plain; CHARSET=US-ASCII

On Apr 20, 2011, at 1:12 PM, Alexander Kabanov wrote:

> Hi there,
> 
> I'm trying to do something basic in my opinion, and get mixed results
> 
> code example is here: http://pastebin.com/b15rrd6n
> 
> C function signature (arguments in order):
> 
> - pointer to a string (input)
> - string size
> - pointer to final result (string)
> - pointer to result size (int)
> - int (always 0 now)
> - pointer to a string
> 
> sometimes function call works as expected, sometimes it doesn't, I
> can't explain why. adding removing few lines of code (random "puts"
> calls etc.) will change the function call behavior (will work 20% or
> 100% of times). am I supposed to maintain memory pointers somehow
> (i.e. malloc/free) or my .so lib has bad implementation (i know it's
> used in other places without any issues)?

Please pastie the errors you are getting particularly if MRI is crashing. You say it doesn't work up to 80% of the time, but what does "does not work" mean in this case?


> I tried to use LibC approach described on wiki page using malloc, same
> deal.
> 
> ruby 1.8.7 (2010-12-23 patchlevel 330) [i386-linux] RHEL 5.4
> ffi (1.0.7)

This might be your issue. I think that 1.8.x support is "best effort" and no longer a target. Try your code again with 1.9.2 and see if it functions more reliably. Alternately, try your code with some other ruby runtimes (JRuby, Rubinius) that have FFI support and see if they provide additional details in their errors. Those other runtimes could greatly aid in debugging.

cr


