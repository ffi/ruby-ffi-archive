<html>
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>[ruby-ffi] Re: Structs layout and memory consumption</title>
<link rel="important stylesheet" href="">
<style>div.headerdisplayname {font-weight:bold;}</style></head>
<body>
<table border=0 cellspacing=0 cellpadding=0 width="100%" class="header-part1"><tr><td><div class="headerdisplayname" style="display:inline;">Subject: </div>[ruby-ffi] Re: Structs layout and memory consumption</td></tr><tr><td><div class="headerdisplayname" style="display:inline;">From: </div>Wayne Meissner <wmeissner@gmail.com></td></tr><tr><td><div class="headerdisplayname" style="display:inline;">Date: </div>11/8/12 3:30 PM</td></tr></table><table border=0 cellspacing=0 cellpadding=0 width="100%" class="header-part2"><tr><td><div class="headerdisplayname" style="display:inline;">To: </div>ruby-ffi@googlegroups.com</td></tr></table><br>
<div class="moz-text-html"  lang="x-unicode">Yep, that looks right.<div><br>On Friday, 9 November 2012 07:15:23 UTC+10, Hans Hasselberg  wrote:<blockquote class="gmail_quote" style="margin: 0;margin-left: 0.8ex;border-left: 1px #ccc solid;padding-left: 1ex;">Thanks for your answer!<div><br></div><div>My approach for getting&nbsp;getdtablesize() would be something like that:</div><div><br></div><blockquote style="margin:0 0 0 40px;border:none;padding:0px"><div><font face="courier new, monospace" color="#000000">module Libc</font></div><div><font face="courier new, monospace" color="#000000">&nbsp; extend FFI::Library</font></div><div><font face="courier new, monospace" color="#000000">&nbsp; ffi_lib 'c'</font></div><div><font face="courier new, monospace" color="#000000">&nbsp; attach_function :getdtablesize, [], :i<span style="line-height:19px">nt</span></font></div><div><font face="courier new, monospace" color="#000000"><span style="line-height:19px">end</span></font></div></blockquote><div><br></div><div>Is that right?</div><div><br>On Thursday, November 8, 2012 10:06:01 PM UTC+1, Wayne Meissner wrote:<blockquote class="gmail_quote" style="margin:0;margin-left:0.8ex;border-left:1px #ccc solid;padding-left:1ex">The first definition is mostly correct, apart from the FD_SETSIZE defintion (its way too large for the default value on any platform).<div><br></div><div>Have a look at the&nbsp;getdtablesize() function in libc, and use that to set the FD_SETSIZE constant, since that will always return the *actual* open file limit for the process.</div><div><br></div><div>As to why you get segfaults with your new definition, is due to what FDSet (aka fd_set in C) is supposed to represent. &nbsp;Its a bitset that has a bit representing each file descriptor that select(3) is supposed to monitor. &nbsp;Your new definition has only enough space for 32 file descriptors (on a 32bit system), so when you perform an operation that tries to read/write file descriptor 32 or above in that bitset, it will segfault.</div><div><br></div><div><br>On Friday, 9 November 2012 05:45:58 UTC+10, Hans Hasselberg  wrote:<blockquote class="gmail_quote" style="margin:0;margin-left:0.8ex;border-left:1px #ccc solid;padding-left:1ex">Hello!<div><br></div><div>Thank you very much for this library!</div><div>I stumbled over a problem with code I 'inherited', it is a gem which wraps libcurl.</div><div>This code works, but consumes too much memory for my taste and looks suspicious!</div><div><br></div><div><a href="https://github.com/typhoeus/ethon/blob/master/lib/ethon/curls/classes.rb" target="_blank">https://github.com/typhoeus/<wbr>ethon/blob/master/lib/ethon/<wbr>curls/classes.rb</a>:<br></div><div><br></div><blockquote style="margin:0 0 0 40px;border:none;padding:0px"><div><font face="courier new, monospace">class FDSet &lt; FFI::Struct</font></div><div><font face="courier new, monospace">&nbsp; FD_SETSIZE = 524288</font></div><div><font face="courier new, monospace">&nbsp; layout :fds_bits, [:long, FD_SETSIZE / FFI::Type::LONG.size]</font></div><div><font face="courier new, monospace">end</font></div></blockquote><div><br></div><div>I can change that code to:</div><div><br></div><blockquote style="margin:0 0 0 40px;border:none;padding:0px"><div><span style="font-family:'courier new',monospace">class FDSet &lt; FFI::Struct</span></div><div><span style="font-family:'courier new',monospace">&nbsp; layout :fds_bits, :long</span><br></div><div><font face="courier new, monospace">end</font></div></blockquote><div><br></div><div>Instances of FDSet do not consume so much memory any more, but I get segfaults on a regular basis. It seems to me, that fds_bits is just a memory placeholder.</div><div>The ffi code in that particular project looks quite understandable except for that FDSet.&nbsp;</div><div><br></div><div>Could you explain to me, why my code segfaults with the changed code and if FDSet is correct specified? I bet you need more information, but I don't know which, so feel free to ask!</div><div><br></div><div><br></div><div>Cheers,</div><div>Hans</div></blockquote></div></blockquote></div></blockquote></div>
</div></body>
</html>
</table></div>