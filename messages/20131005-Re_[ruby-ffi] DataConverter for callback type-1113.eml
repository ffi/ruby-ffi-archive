Delivered-To: headius@headius.com
Received: by 10.180.7.104 with SMTP id i8csp68424wia;
        Fri, 4 Oct 2013 23:18:29 -0700 (PDT)
X-Received: by 10.180.73.65 with SMTP id j1mr10467675wiv.10.1380953909623;
        Fri, 04 Oct 2013 23:18:29 -0700 (PDT)
Return-Path: <ruby-ffi+bncBD6733FW44FBBNO6X2JAKGQE5CXJMRA@googlegroups.com>
Received: from mail-wi0-x239.google.com (mail-wi0-x239.google.com [2a00:1450:400c:c05::239])
        by mx.google.com with ESMTPS id es6si3865331wic.64.1969.12.31.16.00.00
        (version=TLSv1 cipher=ECDHE-RSA-RC4-SHA bits=128/128);
        Fri, 04 Oct 2013 23:18:29 -0700 (PDT)
Received-SPF: softfail (google.com: domain of transitioning ruby-ffi+bncBD6733FW44FBBNO6X2JAKGQE5CXJMRA@googlegroups.com does not designate 194.109.24.32 as permitted sender) client-ip=194.109.24.32;
Authentication-Results: mx.google.com;
       spf=softfail (google.com: domain of transitioning ruby-ffi+bncBD6733FW44FBBNO6X2JAKGQE5CXJMRA@googlegroups.com does not designate 194.109.24.32 as permitted sender) smtp.mail=ruby-ffi+bncBD6733FW44FBBNO6X2JAKGQE5CXJMRA@googlegroups.com;
       dkim=pass header.i=@googlegroups.com
Received: by mail-wi0-f185.google.com with SMTP id hq15sf228959wib.22
        for <headius@headius.com>; Fri, 04 Oct 2013 23:18:29 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=googlegroups.com; s=20120806;
        h=message-id:date:from:user-agent:mime-version:to:subject:references
         :in-reply-to:content-type:x-original-sender
         :x-original-authentication-results:reply-to:precedence:mailing-list
         :list-id:list-post:list-help:list-archive:sender:list-subscribe
         :list-unsubscribe;
        bh=dta2Pov6QklQg3PdrZXUEy9v8D1csnMP/GEov5nO3ew=;
        b=soi11ZOPCutZ14kSIXiVJqFgawei9z7M03aXEJMAmHsxE6+WDiNTqkNOP5VuGBOEDU
         7jrB1A3MUOWcPgyTwlJnslVEXv9C0sytsz3RjDpxLFHdtRG5ZZ1759ljhM1Png0T6+rv
         Qae/W/1zHGqhfA+NXZ2y9ErXdd7YEZ80nqc3oWYB28srXXboRVQTpwh/Q2DGNXS1dlI5
         i11L0CKYL9lRatkhJj7SMbKRBFPBJhThdCdThGRFbXHmlkkvsl48tNaDExkOrnyBhXQD
         uD2kJegHekvT1C40qhNA114/ApQA85aNTyZcB+WBQWXjD6kDS/XzEvlR+qa9CgRcJZoT
         uDug==
X-Received: by 10.180.87.170 with SMTP id az10mr398243wib.8.1380953909527;
        Fri, 04 Oct 2013 23:18:29 -0700 (PDT)
X-BeenThere: ruby-ffi@googlegroups.com
Received: by 10.180.228.39 with SMTP id sf7ls460138wic.54.canary; Fri, 04 Oct
 2013 23:18:29 -0700 (PDT)
X-Received: by 10.14.251.134 with SMTP id b6mr17643996ees.2.1380953908991;
        Fri, 04 Oct 2013 23:18:28 -0700 (PDT)
Received: from smtp-vbr12.xs4all.nl (smtp-vbr12.xs4all.nl. [194.109.24.32])
        by gmr-mx.google.com with ESMTP id a1si2900492ees.1.1969.12.31.16.00.00;
        Fri, 04 Oct 2013 23:18:28 -0700 (PDT)
Received-SPF: neutral (google.com: 194.109.24.32 is neither permitted nor denied by best guess record for domain of matijs@matijs.net) client-ip=194.109.24.32;
Received: from [10.0.0.34] (mvz.xs4all.nl [83.163.118.181])
	(authenticated bits=0)
	by smtp-vbr12.xs4all.nl (8.13.8/8.13.8) with ESMTP id r956IQo9075764
	(version=TLSv1/SSLv3 cipher=DHE-RSA-AES256-SHA bits=256 verify=NO)
	for <ruby-ffi@googlegroups.com>; Sat, 5 Oct 2013 08:18:27 +0200 (CEST)
	(envelope-from matijs@matijs.net)
Message-ID: <524FAF32.3060300@matijs.net>
Date: Sat, 05 Oct 2013 08:18:26 +0200
From: Matijs van Zuijlen <matijs@matijs.net>
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:17.0) Gecko/20130821 Icedove/17.0.8
MIME-Version: 1.0
To: ruby-ffi@googlegroups.com
Subject: Re: [ruby-ffi] DataConverter for callback type
References: <523ECEE1.4060406@matijs.net> <523F46F3.1070005@matijs.net> <f0a672dd-6203-492c-9bc8-12130dda3c29@googlegroups.com>
In-Reply-To: <f0a672dd-6203-492c-9bc8-12130dda3c29@googlegroups.com>
X-Enigmail-Version: 1.5.1
Content-Type: multipart/signed; micalg=pgp-sha256;
 protocol="application/pgp-signature";
 boundary="----enig2KQEXIEWMNPUIMDWQIOAA"
X-Virus-Scanned: by XS4ALL Virus Scanner
X-Original-Sender: matijs@matijs.net
X-Original-Authentication-Results: gmr-mx.google.com;       spf=neutral
 (google.com: 194.109.24.32 is neither permitted nor denied by best guess
 record for domain of matijs@matijs.net) smtp.mail=matijs@matijs.net
Reply-To: ruby-ffi@googlegroups.com
Precedence: list
Mailing-list: list ruby-ffi@googlegroups.com; contact ruby-ffi+owners@googlegroups.com
List-ID: <ruby-ffi.googlegroups.com>
X-Google-Group-Id: 238405446264
List-Post: <http://groups.google.com/group/ruby-ffi/post>, <mailto:ruby-ffi@googlegroups.com>
List-Help: <http://groups.google.com/support/>, <mailto:ruby-ffi+help@googlegroups.com>
List-Archive: <http://groups.google.com/group/ruby-ffi>
Sender: ruby-ffi@googlegroups.com
List-Subscribe: <http://groups.google.com/group/ruby-ffi/subscribe>, <mailto:ruby-ffi+subscribe@googlegroups.com>
List-Unsubscribe: <http://groups.google.com/group/ruby-ffi/subscribe>, <mailto:googlegroups-manage+238405446264+unsubscribe@googlegroups.com>

This is an OpenPGP/MIME signed message (RFC 4880 and 3156)
------enig2KQEXIEWMNPUIMDWQIOAA
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: quoted-printable

Hi Wayne,

Thanks for your response. Based on your example I got things working. I w=
as
indeed trying to use Type::Function as the native type, and experiencing =
crashes
because of it (although that actually worked on JRuby!).

Regards,
Matijs

On 01/10/13 06:20, Wayne Meissner wrote:
> Hmm.  There are a couple of ways of doing it:
> - making a DataConverter that has a native_type of a Type::Function act=
ually
> *work* instead of crashing the VM (or failing with an error on JRuby)
> - allowing FFI::Function.new() to take a call context and a function
> pointer/proc/block instead of a separate rtype and param_type array for=
 efficiency.
>=20
> In the meantime, you can probably achieve what you want.
> e.g.
>=20
> module QSort
>   extend FFI::Library
>   ffi_lib 'c'
>=20
>   module Comparator
>     RTYPE =3D FFI::Type::SINT
>     PARAM_TYPES =3D  [ FFI::Type::POINTER, FFI::Type::POINTER ].freeze
>     extend FFI::DataConverter
>=20
>     def self.native_type
>       FFI::Type::POINTER
>     end
>=20
>     def self.to_native(value, ctx)
>       FFI::Function.new(RTYPE, PARAM_TYPES, value)
>     end
>   end
>   attach_function :qsort, [ :pointer, :size_t, :size_t, Comparator ], :=
void
> end
>=20
> ptr =3D FFI::MemoryPointer.new(:int, 2)
> ptr[0].write_int(2)
> ptr[1].write_int(1)
> puts "unsorted=3D#{ptr.get_array_of_int(0, 2)}"
> QSort.qsort(ptr, 2, 4, ->(p1, p2) { i1, i2 =3D p1.read_int, p2.read_int=
;  i1 < i2
> ? -1 : i1 > i2 ? 1 : 0 })
> puts "sorted=3D#{ptr.get_array_of_int(0, 2)}"
>=20
>=20
> On Monday, 23 September 2013 05:37:23 UTC+10, Matijs van Zuijlen wrote:=

>=20
>     I've been digging a little further, and it seems that the
>     rbffi_Function_ForProc
>     function defined in Function.c does exactly what I want, since I ha=
ve a
>     FFI::FunctionType (i.e., self::Callback), and a Proc (the value arg=
ument of
>     #to_native), and I would like to turn this into a FFI::Function.
>=20
>     Would it be possible to expose this function to Ruby?
>=20
>     On 22/09/13 13:05, Matijs van Zuijlen wrote:
>     > Hello,
>     >
>     > I'm trying to create a DataConverter that represents a callback f=
unction. The
>     > code basically boils down to this:
>     >
>     > module Lib
>     >   include FFI::Library
>     >   ffi_lib 'some-library'
>     > end
>     >
>     > class Foo < Proc
>     >   extend FFI::DataConverter
>     >
>     >   Callback =3D Lib.callback ... # usual call to FFI::Library.call=
back
>     >
>     >   def self.native_type
>     >     self::Callback
>     >   end
>     > end
>     >
>     > [The reason I'm doing this is that I want to wrap procs passed fr=
om ruby
>     in some
>     > argument conversion code using a method defined on, in this case,=
 Foo]
>     >
>     > Now, I'm unable to figure out what the definition of Foo.to_nativ=
e should be.
>     > Foo::Callback is of type FFI::FunctionType, which doesn't have a =
to_native
>     method.
>     >
>     > Any ideas?
>     >
>     > Thanks and regards,
>     >
>=20
>=20
>     --=20
>     Matijs
>=20
> --=20
> =20
> ---
> You received this message because you are subscribed to the Google Grou=
ps
> "ruby-ffi" group.
> To unsubscribe from this group and stop receiving emails from it, send =
an email
> to ruby-ffi+unsubscribe@googlegroups.com.
> For more options, visit https://groups.google.com/groups/opt_out.


--=20
Matijs


------enig2KQEXIEWMNPUIMDWQIOAA
Content-Type: application/pgp-signature; name="signature.asc"
Content-Description: OpenPGP digital signature
Content-Disposition: attachment; filename="signature.asc"

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.14 (GNU/Linux)

iQEVAwUBUk+vMpZ5CSFec8nfAQgoHAf/drhtHGbEmdFOs5WQLBnXxFD7ArhVcHXG
mb7AYkRAbUEiwFR9Myd2EjeU5Z2qXxoazXfSRS6xKHaZefm4MJ7dOaELIZJ2ZehC
X5eY59pXe0R+UQTd9HNNA1W5D8nqSFe7fJ5WVly0fPNsg01dBQa3mt7Qhs/LDihK
WaS6Up+Np9VdTLoh5u7bBaFbAnVmRwRBKpk0qc9pQuMHGakN6JvP0Po3FilED/Jy
6U/IXODLJCfhV/aOQGXFraFO76+FVBaHbFnxmZIeUf+VMC6PR26VloMcCJj27mwX
worPGEK8b73IQ74yh7b7+TLmPvulVjRXWuxMWeCfmAuMEYxr1gK5Rw==
=QPuU
-----END PGP SIGNATURE-----

------enig2KQEXIEWMNPUIMDWQIOAA--
