Delivered-To: headius@headius.com
Received: by 10.100.5.7 with SMTP id 7cs50311ane;
        Thu, 4 Feb 2010 11:23:44 -0800 (PST)
Received: by 10.100.25.14 with SMTP id 14mr2209050any.158.1265311424576;
        Thu, 04 Feb 2010 11:23:44 -0800 (PST)
Return-Path: <3vh5rSwcHCJMFHGA5HD39K.A1GEHyL-2253BB3813EBHCF.zB9@groups.bounces.google.com>
Received: from mail-yw0-f151.google.com (mail-yw0-f151.google.com [209.85.211.151])
        by mx.google.com with ESMTP id 7si1072241ywh.17.2010.02.04.11.23.43;
        Thu, 04 Feb 2010 11:23:43 -0800 (PST)
Received-SPF: pass (google.com: domain of 3vh5rSwcHCJMFHGA5HD39K.A1GEHyL-2253BB3813EBHCF.zB9@groups.bounces.google.com designates 209.85.211.151 as permitted sender) client-ip=209.85.211.151;
Authentication-Results: mx.google.com; spf=pass (google.com: domain of 3vh5rSwcHCJMFHGA5HD39K.A1GEHyL-2253BB3813EBHCF.zB9@groups.bounces.google.com designates 209.85.211.151 as permitted sender) smtp.mail=3vh5rSwcHCJMFHGA5HD39K.A1GEHyL-2253BB3813EBHCF.zB9@groups.bounces.google.com; dkim=pass (test mode) header.i=@googlegroups.com
Received: by ywh15 with SMTP id 15sf8737793ywh.7
        for <headius@headius.com>; Thu, 04 Feb 2010 11:23:43 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=googlegroups.com; s=beta;
        h=domainkey-signature:received:x-beenthere:received:received:received
         :received:received-spf:received:mime-version:received:date
         :in-reply-to:x-ip:references:user-agent:x-http-useragent:message-id
         :subject:from:to:x-original-authentication-results:x-original-sender
         :reply-to:precedence:mailing-list:list-id:list-post:list-help
         :list-archive:x-thread-url:x-message-url:sender:list-subscribe
         :list-unsubscribe:content-type:content-transfer-encoding;
        bh=A29Ukn7vZjgiXG6RR72MspTFssE947EuiR+M7+CCX0A=;
        b=HjAjhYgBvu7NjjaiD36+CudH4dXnfhzANFFKu0DlaOCflsDFarhiLNjNf2c5gHTL2J
         ZmmtnFQmbNKz0Ae3sc02MSzJy3MvJ3OKPsPJv8K6g1W23vU8GHbkGGKkDSBXBwmGRuyi
         L/ZwSOSwDm5VA7o3M+gAggFI68e8vKXqSqqUA=
DomainKey-Signature: a=rsa-sha1; c=nofws;
        d=googlegroups.com; s=beta;
        h=x-beenthere:received-spf:mime-version:date:in-reply-to:x-ip
         :references:user-agent:x-http-useragent:message-id:subject:from:to
         :x-original-authentication-results:x-original-sender:reply-to
         :precedence:mailing-list:list-id:list-post:list-help:list-archive
         :x-thread-url:x-message-url:sender:list-subscribe:list-unsubscribe
         :content-type:content-transfer-encoding;
        b=WDV7CiHDJGJp8FTk7K6KVKdTPxBmP7Mi7KdooBxUYpLtE9HRKpRoG1/cwMQm3o3J1Q
         R2m6JdBp1fJRb5iOMys+AfSfYgGC7HFA0at//5TFFhg4EZLH6OBQRp+1mgvQPfhhDtu7
         8dm6FVz73uShQmmyTkAZZbT6qyRhWpLKP2s6o=
Received: by 10.151.87.2 with SMTP id p2mr57472ybl.66.1265311422167;
        Thu, 04 Feb 2010 11:23:42 -0800 (PST)
X-BeenThere: ruby-ffi@googlegroups.com
Received: by 10.91.11.6 with SMTP id o6ls14260agi.3.p; Thu, 04 Feb 2010 
	11:23:41 -0800 (PST)
Received: by 10.90.41.23 with SMTP id o23mr1929436ago.7.1265311421309;
        Thu, 04 Feb 2010 11:23:41 -0800 (PST)
Received: by 10.90.41.23 with SMTP id o23mr1929433ago.7.1265311421277;
        Thu, 04 Feb 2010 11:23:41 -0800 (PST)
Return-Path: <sutniuq@gmx.net>
Received: from mail-gx0-f188.google.com (mail-gx0-f188.google.com [209.85.217.188])
        by gmr-mx.google.com with ESMTP id 18si51010gxk.7.2010.02.04.11.23.41;
        Thu, 04 Feb 2010 11:23:41 -0800 (PST)
Received-SPF: fail (google.com: domain of sutniuq@gmx.net does not designate 209.85.217.188 as permitted sender) client-ip=209.85.217.188;
Received: by gxk4 with SMTP id 4so7948110gxk.13
        for <ruby-ffi@googlegroups.com>; Thu, 04 Feb 2010 11:23:41 -0800 (PST)
MIME-Version: 1.0
Received: by 10.101.142.33 with SMTP id u33mr113347ann.13.1265311421170; Thu, 
	04 Feb 2010 11:23:41 -0800 (PST)
Date: Thu, 4 Feb 2010 11:23:41 -0800 (PST)
In-Reply-To: <06ced854-31c3-424a-bcc0-dcb94b7e1f7b@l19g2000yqb.googlegroups.com>
X-IP: 77.178.188.203
References: <06ced854-31c3-424a-bcc0-dcb94b7e1f7b@l19g2000yqb.googlegroups.com>
User-Agent: G2/1.0
X-HTTP-UserAgent: Mozilla/5.0 (Windows; U; Windows NT 6.0; de; rv:1.9.1.7) 
	Gecko/20091221 Firefox/3.5.7 (.NET CLR 3.5.30729),gzip(gfe),gzip(gfe)
Message-ID: <fd509fac-4f23-46b1-8c93-e22349c0cb9b@n33g2000yqb.googlegroups.com>
Subject: [ruby-ffi] Re: Arrays in Structs and Unions
From: Quintus <sutniuq@gmx.net>
To: ruby-ffi <ruby-ffi@googlegroups.com>
X-Original-Authentication-Results: gmr-mx.google.com; spf=hardfail 
	(google.com: domain of sutniuq@gmx.net does not designate 209.85.217.188 as 
	permitted sender) smtp.mail=sutniuq@gmx.net
X-Original-Sender: sutniuq@gmx.net
Reply-To: ruby-ffi@googlegroups.com
Precedence: list
Mailing-list: list ruby-ffi@googlegroups.com; contact ruby-ffi+owners@googlegroups.com
List-ID: <ruby-ffi.googlegroups.com>
List-Post: <http://groups.google.com/group/ruby-ffi/post?hl=en_US>, 
	<mailto:ruby-ffi@googlegroups.com>
List-Help: <http://groups.google.com/support/?hl=en_US>, <mailto:ruby-ffi+help@googlegroups.com>
List-Archive: <http://groups.google.com/group/ruby-ffi?hl=en_US>
X-Thread-Url: http://groups.google.com/group/ruby-ffi/t/25c90d5db2e9be13
X-Message-Url: http://groups.google.com/group/ruby-ffi/msg/bbbccf46c3548eef
Sender: ruby-ffi@googlegroups.com
List-Subscribe: <http://groups.google.com/group/ruby-ffi/subscribe?hl=en_US>, 
	<mailto:ruby-ffi+subscribe@googlegroups.com>
List-Unsubscribe: <http://groups.google.com/group/ruby-ffi/subscribe?hl=en_US>, 
	<mailto:ruby-ffi+unsubscribe@googlegroups.com>
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: quoted-printable

I'm sorry, here's the attaching of the function:

attach_function :get_version_ex, :GetVersionExW,
[:buffer_inout], :bool

Marvin

On 4 Feb., 20:21, Quintus <sutn...@gmx.net> wrote:
> Hi,
>
> I've two questions. This is the more important one: How to use arrays
> in Structs via FFI? I have this nice struct declaration:
> ----------------------------------------------------
> typedef struct _OSVERSIONINFO {
> =A0 DWORD dwOSVersionInfoSize;
> =A0 DWORD dwMajorVersion;
> =A0 DWORD dwMinorVersion;
> =A0 DWORD dwBuildNumber;
> =A0 DWORD dwPlatformId;
> =A0 TCHAR szCSDVersion[128];} OSVERSIONINFO;
>
> ----------------------------------------------------
> ( Fromhttp://msdn.microsoft.com/en-us/library/ms724834%28VS.85%29.aspx
> , to be used with the GetVersionInfoEx() function:http://msdn.microsoft.c=
om/en-us/library/ms724451%28VS.85%29.aspx)
> and I'm not sure how to access the szCSDVVersion[128] member. I
> thought, I had to work with Memory pointers for arrays, but the
> following code doesn't work for me:
> -----------------------------------------------------
> class OSVersionInfo < FFI::Struct
>
> =A0 layout =A0:os_version_info_size, :int,
> =A0 =A0 =A0 =A0 =A0 =A0 :major_version, :int,
> =A0 =A0 =A0 =A0 =A0 =A0 :minor_version, :int,
> =A0 =A0 =A0 =A0 =A0 =A0 :build_number, :int,
> =A0 =A0 =A0 =A0 =A0 =A0 :platform_id, :int,
> =A0 =A0 =A0 =A0 =A0 =A0 :csdv_version, :buffer_out
>
> end
>
> ptr =3D FFI::MemoryPointer.new(:pointer, 128)
> osversioninfo =3D OSVersionInfo.new
> osversioninfo[:csdv_version] =3D ptr # line 106
> osversioninfo[:os_version_info_size] =3D OSVersionInfo.size
> get_version_ex(osversioninfo)
> p osversioninfo[:major_version]
> ---------------------------------------------------------
> I get this error:
> ---------------------------------------------------------
> system_info.rb:106:in `put': put not supported for
> FFI::StructLayout::Field (ArgumentError)
> =A0 =A0 =A0 =A0 from system_info.rb:106:in `[]=3D'
> =A0 =A0 =A0 =A0 from system_info.rb:106:in `test_version'
> =A0 =A0 =A0 =A0 from system_info.rb:117:in `<main>'
> ---------------------------------------------------------
> I tried it without the MemoryPointer:
> ---------------------------------------------------------
> osversioninfo =3D OSVersionInfo.new
> osversioninfo[:os_version_info_size] =3D OSVersionInfo.size
> get_version_ex(osversioninfo)
> p osversioninfo[:major_version] #=3D> 0
> ---------------------------------------------------------
> That code doesn't thorw an error, but the function call fails - the
> line starting with "p" should print out 6 on my Vista machine.
> How can this be done?
>
> The second question is a simple one: Where do I find a quick example
> of how to use the FFI::Union class? The wiki just states this:> The actua=
l Windows INPUT struct contains an anonymous union member with MOUSEINPUT, =
KEYBDINPUT,
> > and HARDWAREINPUT members. As the MOUSEINPUT struct is the largest of t=
hese members, we can get
> > away with the hacky InputEvent FFI union definition for example purpose=
s.
>
> So, what to do if I haven't an "example purpose"?
>
> ruby -v: ruby 1.9.1p243 (2009-07-16 revision 24175) [i386-mingw32]
> OS: Windows Vista SP2
>
> Marvin
