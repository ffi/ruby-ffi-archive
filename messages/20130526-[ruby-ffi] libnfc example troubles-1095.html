<html>
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>[ruby-ffi] libnfc example troubles</title>
<link rel="important stylesheet" href="">
<style>div.headerdisplayname {font-weight:bold;}</style></head>
<body>
<table border=0 cellspacing=0 cellpadding=0 width="100%" class="header-part1"><tr><td><div class="headerdisplayname" style="display:inline;">Subject: </div>[ruby-ffi] libnfc example troubles</td></tr><tr><td><div class="headerdisplayname" style="display:inline;">From: </div>Anders Konring Olesen <anders.konring@gmail.com></td></tr><tr><td><div class="headerdisplayname" style="display:inline;">Date: </div>5/26/13 3:09 PM</td></tr></table><table border=0 cellspacing=0 cellpadding=0 width="100%" class="header-part2"><tr><td><div class="headerdisplayname" style="display:inline;">To: </div>ruby-ffi@googlegroups.com</td></tr></table><br>
<div class="moz-text-html"  lang="x-western">Hi everyone.&nbsp;<br><br>i need some backup to get going with my project trying to make ruby-wrapper for libnfc:<br><div><br></div><div>Test program(trying to simulate<a href="http://nfc-tools.org/index.php?title=Libnfc:quick_start_example">&nbsp;this</a>&nbsp;c example:):</div><div>&nbsp;</div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>require 'ffi'</div><div>load '~/Documents/nfc/nfc_library.rb'</div><div><br></div><div>device_ptr = FFI::MemoryPointer.new :pointer</div><div>context_ptr = FFI::MemoryPointer.new :pointer</div><div>target = NfcLibrary::NfcTarget.new</div><div><br></div><div>NfcLibrary::nfc_init(context_ptr)</div><div>device_ptr = NfcLibrary::nfc_open(context_ptr.read_pointer, nil)</div><div><br></div><div><br></div><div>NfcLibrary::nfc_initiator_init(device_ptr)</div><div>&nbsp; &nbsp;&nbsp;</div><div>nmMifare = NfcLibrary::NfcModulation.new</div><div>nmMifare[:nmt] = :NMT_ISO14443A</div><div>nmMifare[:nbr] = :NBR_106</div><div><br></div><div>device_name = NfcLibrary::nfc_device_get_name(device_ptr)</div><div><br></div><div>puts device_name</div><div><br></div><div>NfcLibrary::nfc_initiator_select_passive_target(device_ptr, nmMifare, nil, 0, target.pointer)</div></blockquote><div><br></div><div>Output of testprogram(connecting to nfc interface but will call the last method with succes) :</div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div><div>ACS / ACR122U PICC Interface</div></div><div><div>-2</div></div></blockquote><div><br></div><div>My FFI library:</div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div><div>module NfcLibrary</div></div><div><div>&nbsp; extend FFI::Library</div></div><div><div>&nbsp; ffi_lib '/usr/local/Cellar/libnfc/1.7.0-rc1/lib/libnfc.4.dylib'</div></div><div><div><br></div></div><div><div>&nbsp; typedef :pointer, :nfc_device</div></div><div><div>&nbsp; typedef :pointer, :nfc_context</div></div><div><div>&nbsp; enum :NfcModulationType,</div></div><div><div>&nbsp; [:NMT_ISO14443A, 1,</div></div><div><div>&nbsp; &nbsp;:NMT_JEWEL,</div></div><div><div>&nbsp; :NMT_ISO14443B,</div></div><div><div>&nbsp; :NMT_ISO14443BI,&nbsp;</div></div><div><div>&nbsp; :NMT_ISO14443B2SR,&nbsp;</div></div><div><div>&nbsp; :NMT_ISO14443B2CT,&nbsp;</div></div><div><div>&nbsp; :NMT_FELICA,</div></div><div><div>&nbsp; :NMT_DEP]</div></div><div><div><br></div></div><div><div>&nbsp; enum :NfcBaudRate,</div></div><div><div>&nbsp; [:NBR_UNDEFINED, 0,</div></div><div><div>&nbsp; :NBR_106,</div></div><div><div>&nbsp; :NBR_212,</div></div><div><div>&nbsp; :NBR_424,</div></div><div><div>&nbsp; :NBR_847]</div></div><div><div><br></div></div><div><div>&nbsp; class NfcIso14443aInfo &lt; FFI::Struct</div></div><div><div>&nbsp; &nbsp; layout :abtAtqa, :uint8, 2,</div></div><div><div>&nbsp; &nbsp; :btSak, :uint8,&nbsp;</div></div><div><div>&nbsp; &nbsp; :szUidLen, :size_t,</div></div><div><div>&nbsp; &nbsp; :abtUid, :uint8, 10,</div></div><div><div>&nbsp; &nbsp; :szAtsLen, :size_t,</div></div><div><div>&nbsp; &nbsp; :abtAts, :uint8, 254</div></div><div><div>&nbsp; end</div></div><div><div><br></div></div><div><div><br></div></div><div><div><br></div></div><div><div>&nbsp; class NfcTargetInfo &lt; FFI::Union</div></div><div><div>&nbsp; &nbsp; layout :nai, NfcLibrary::NfcIso14443aInfo</div></div><div><div>&nbsp; &nbsp; # :nfi, :nfc_felica_info,</div></div><div><div>&nbsp; &nbsp; # :nbi, :nfc_iso14443b_info,</div></div><div><div>&nbsp; &nbsp; # :nii, :nfc_iso14443bi_info,</div></div><div><div>&nbsp; &nbsp; # :nsi, :nfc_iso14443b2sr_info,</div></div><div><div>&nbsp; &nbsp; # :nci, :nfc_iso14443b2ct_info,</div></div><div><div>&nbsp; &nbsp; # :nji, :nfc_jewel_info,</div></div><div><div>&nbsp; &nbsp; #:ndi, :nfc_dep_info</div></div><div><div><br></div></div><div><div>&nbsp; end</div></div><div><div><br></div></div><div><div>&nbsp; class NfcModulation &lt; FFI::Struct</div></div><div><div>&nbsp; &nbsp; layout :nmt, :NfcModulationType,</div></div><div><div>&nbsp; &nbsp; :nbr, :NfcBaudRate</div></div><div><div>&nbsp; end</div></div><div><div><br></div></div><div><div>&nbsp; class NfcTarget &lt; FFI::Struct</div></div><div><div>&nbsp; &nbsp; layout :nfc_target_info, NfcLibrary::NfcTargetInfo,</div></div><div><div>&nbsp; &nbsp; :nfc_modulation, NfcLibrary::NfcModulation</div></div><div><div>&nbsp; end</div></div><div><div>&nbsp;&nbsp;</div></div><div><div>&nbsp; attach_function :nfc_init, [:pointer], :void</div></div><div><div>&nbsp; attach_function :nfc_target_init, [:pointer, :pointer, :pointer, :size_t, :int], :int</div></div><div><div>&nbsp; attach_function :nfc_open, [:pointer, :string], :pointer</div></div><div><div>&nbsp; attach_function :nfc_close, [:pointer], :void</div></div><div><div>&nbsp; attach_function :nfc_list_devices, [:pointer, :string, :int], :int</div></div><div><div>&nbsp; attach_function :nfc_initiator_init, [:pointer], :int</div></div><div><div>&nbsp; attach_function :nfc_device_get_name, [:pointer], :string</div></div><div><div>&nbsp; attach_function :nfc_initiator_select_passive_target, [:pointer, NfcLibrary::NfcModulation, :pointer, :size_t, :pointer], :int</div></div><div><div>end</div></div></blockquote><div><br></div><div>Header function that i am trying to implement:</div><div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div>&nbsp; NFC_EXPORT int nfc_initiator_select_passive_target(nfc_device *pnd, const nfc_modulation nm, const uint8_t *pbtInitData, const size_t szInitData, nfc_target *pnt);&nbsp;</div></blockquote></div><div><br></div><div>The c example program are running flawlessly and i am connecting to the nfc interface, but somehow the last method is attached wrong but how?</div><div><br></div><div>I have been stucked here for some days now trying to figure out why my rb test program will not call the method properbly, when the c version works great.<br><br>Any help will be much appreciated.</div>

<p></p>

-- <br />
&nbsp;<br />
--- <br />
You received this message because you are subscribed to the Google Groups &quot;ruby-ffi&quot; group.<br />
To unsubscribe from this group and stop receiving emails from it, send an email to ruby-ffi+unsubscribe@googlegroups.com.<br />
For more options, visit <a href="https://groups.google.com/groups/opt_out">https://groups.google.com/groups/opt_out</a>.<br />
&nbsp;<br />
&nbsp;<br />

</div></body>
</html>
</table></div>