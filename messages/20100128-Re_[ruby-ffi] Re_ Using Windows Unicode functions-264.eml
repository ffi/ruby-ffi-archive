Delivered-To: headius@headius.com
Received: by 10.100.5.7 with SMTP id 7cs54420ane;
        Thu, 28 Jan 2010 17:57:10 -0800 (PST)
Received: by 10.142.2.20 with SMTP id 20mr102797wfb.233.1264730229325;
        Thu, 28 Jan 2010 17:57:09 -0800 (PST)
Return-Path: <3ckBiSwkJCGAUKCGQQLCPEK8GJ.AMKPS9W-DDGEMMEJCEPMSNQ.AMK@groups.bounces.google.com>
Received: from mail-pw0-f68.google.com (mail-pw0-f68.google.com [209.85.160.68])
        by mx.google.com with ESMTP id 27si4266353pxi.34.2010.01.28.17.57.07;
        Thu, 28 Jan 2010 17:57:08 -0800 (PST)
Received-SPF: pass (google.com: domain of 3ckBiSwkJCGAUKCGQQLCPEK8GJ.AMKPS9W-DDGEMMEJCEPMSNQ.AMK@groups.bounces.google.com designates 209.85.160.68 as permitted sender) client-ip=209.85.160.68;
Authentication-Results: mx.google.com; spf=pass (google.com: domain of 3ckBiSwkJCGAUKCGQQLCPEK8GJ.AMKPS9W-DDGEMMEJCEPMSNQ.AMK@groups.bounces.google.com designates 209.85.160.68 as permitted sender) smtp.mail=3ckBiSwkJCGAUKCGQQLCPEK8GJ.AMKPS9W-DDGEMMEJCEPMSNQ.AMK@groups.bounces.google.com; dkim=pass (test mode) header.i=@googlegroups.com
Received: by pwj20 with SMTP id 20sf368235pwj.27
        for <headius@headius.com>; Thu, 28 Jan 2010 17:57:07 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=googlegroups.com; s=beta;
        h=domainkey-signature:received:x-beenthere:received:received:received
         :received:received-spf:received:mime-version:received:in-reply-to
         :references:date:message-id:subject:from:to
         :x-original-authentication-results:x-original-sender:reply-to
         :precedence:mailing-list:list-id:list-post:list-help:list-archive
         :x-thread-url:x-message-url:sender:list-subscribe:list-unsubscribe
         :content-type:content-transfer-encoding;
        bh=5u3vs8M7dKx2hkBnNoQpEdI6McC3KEVRQhuxBqcd/Ic=;
        b=sanI17Z3qOt4fna7Cq94b0EtH2XYwNtLC4UxxBo+h5avoJA6o6TXLan58piwhYkXab
         eSBnUtlXJsGSR2fuLb+JvoXEf/+tda+U7Clb+1PIvbwzgmEX9DB+O5v/lA3xBBEiootj
         wB9t/xWa3NmX7ufbXoy96zdTArJ/glnO0Viz0=
DomainKey-Signature: a=rsa-sha1; c=nofws;
        d=googlegroups.com; s=beta;
        h=x-beenthere:received-spf:mime-version:in-reply-to:references:date
         :message-id:subject:from:to:x-original-authentication-results
         :x-original-sender:reply-to:precedence:mailing-list:list-id
         :list-post:list-help:list-archive:x-thread-url:x-message-url:sender
         :list-subscribe:list-unsubscribe:content-type
         :content-transfer-encoding;
        b=Mo+PIp17Z/5NRKoLmyLk7SBZbJgZW/qhI9bYK8azxWnWWifim6lYna3y4BT77m/53k
         hrsvtq79yOJGbRYRM11X/D5+HUX7htdjWkgLl4UPYhm5XU06OXXVPME2grWSyFo07uJJ
         HtU+R6QsASWsqGZguNncbFJP++ivOEu64KY14=
Received: by 10.115.101.23 with SMTP id d23mr8277wam.0.1264730226681;
        Thu, 28 Jan 2010 17:57:06 -0800 (PST)
X-BeenThere: ruby-ffi@googlegroups.com
Received: by 10.114.33.26 with SMTP id g26ls557607wag.3.p; Thu, 28 Jan 2010 
	17:57:05 -0800 (PST)
Received: by 10.114.189.12 with SMTP id m12mr21341waf.26.1264730225659;
        Thu, 28 Jan 2010 17:57:05 -0800 (PST)
Received: by 10.114.189.12 with SMTP id m12mr21340waf.26.1264730225629;
        Thu, 28 Jan 2010 17:57:05 -0800 (PST)
Return-Path: <wmeissner@gmail.com>
Received: from mail-px0-f183.google.com (mail-px0-f183.google.com [209.85.216.183])
        by gmr-mx.google.com with ESMTP id 18si436962pzk.9.2010.01.28.17.57.04;
        Thu, 28 Jan 2010 17:57:04 -0800 (PST)
Received-SPF: pass (google.com: domain of wmeissner@gmail.com designates 209.85.216.183 as permitted sender) client-ip=209.85.216.183;
Received: by pxi13 with SMTP id 13so1010285pxi.3
        for <ruby-ffi@googlegroups.com>; Thu, 28 Jan 2010 17:57:04 -0800 (PST)
MIME-Version: 1.0
Received: by 10.141.2.14 with SMTP id e14mr121028rvi.56.1264730224000; Thu, 28 
	Jan 2010 17:57:04 -0800 (PST)
In-Reply-To: <20100128145855.1f23ec7e.jon.forums@gmail.com>
References: <9ef47d23-21f0-4657-ac94-3cf8d7725016@a32g2000yqm.googlegroups.com>
	 <4ccee321001241612k70d81dbdgbf8b097b550c040f@mail.gmail.com>
	 <571aaacb-83dc-46af-a837-ea698dc31657@b2g2000yqi.googlegroups.com>
	 <20100128145855.1f23ec7e.jon.forums@gmail.com>
Date: Fri, 29 Jan 2010 11:57:03 +1000
Message-ID: <4ccee321001281757k48c1318fy54664506073f9be6@mail.gmail.com>
Subject: Re: [ruby-ffi] Re: Using Windows Unicode functions
From: Wayne Meissner <wmeissner@gmail.com>
To: ruby-ffi@googlegroups.com
X-Original-Authentication-Results: gmr-mx.google.com; spf=pass (google.com: 
	domain of wmeissner@gmail.com designates 209.85.216.183 as permitted sender) 
	smtp.mail=wmeissner@gmail.com; dkim=pass (test mode) header.i=@gmail.com
X-Original-Sender: wmeissner@gmail.com
Reply-To: ruby-ffi@googlegroups.com
Precedence: list
Mailing-list: list ruby-ffi@googlegroups.com; contact ruby-ffi+owners@googlegroups.com
List-ID: <ruby-ffi.googlegroups.com>
List-Post: <http://groups.google.com/group/ruby-ffi/post?hl=en_US>, 
	<mailto:ruby-ffi@googlegroups.com>
List-Help: <http://groups.google.com/support/?hl=en_US>, <mailto:ruby-ffi+help@googlegroups.com>
List-Archive: <http://groups.google.com/group/ruby-ffi?hl=en_US>
X-Thread-Url: http://groups.google.com/group/ruby-ffi/t/ada0ea99600b7fa1
X-Message-Url: http://groups.google.com/group/ruby-ffi/msg/efd0cae7929fc970
Sender: ruby-ffi@googlegroups.com
List-Subscribe: <http://groups.google.com/group/ruby-ffi/subscribe?hl=en_US>, 
	<mailto:ruby-ffi+subscribe@googlegroups.com>
List-Unsubscribe: <http://groups.google.com/group/ruby-ffi/subscribe?hl=en_US>, 
	<mailto:ruby-ffi+unsubscribe@googlegroups.com>
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: quoted-printable

On 29 January 2010 05:58, Jon <jon.forums@gmail.com> wrote:
>
> A new type binary blob type similar to :buffer_in but skips over the null=
-byte checking and encodes to UTF-16LE behind the scenes? =A0Something like=
 :unicode_string or :win_wide_string? =A0Could the new type also be made ap=
plicable to both Windows UTF-16 and *nix UTF-8/locale environments?

If anyone wants to experiment with this, I strongly encourage them to
spin up a new ffi-related gem, along the lines of NiceFFI and play
with the win32/unicode stuff there.  This way it will work on both
CRuby and JRuby, and you won't be waiting months for it to be merged
in to the various FFI implementations.

FFI's attach_function is all ruby code, its just setting up and wiring
together primitives provided by the C ext or JRuby code.  You can
replace it with your own version that when it detects say a :wstring
parameter/return type, wraps the function call in a small ruby stub
that does the conversion to/from native code.

you could use it like something like this:

module Foo
  extend Win32FFI::Library

  @encoding =3D "UTF-16LE"
  attach_function :BarW, [ :wstring, :int ], :wstring
end

Foo.BarW "Test", 2

APIs you'll want to learn about are
http://ffi.github.com/api/FFI/Function.html
http://ffi.github.com/api/FFI/DynamicLibrary.html and possibly
http://ffi.github.com/api/FFI/Type.html
