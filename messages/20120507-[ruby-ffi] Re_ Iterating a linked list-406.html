<html>
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>[ruby-ffi] Re: Iterating a linked list</title>
<link rel="important stylesheet" href="">
<style>div.headerdisplayname {font-weight:bold;}</style></head>
<body>
<table border=0 cellspacing=0 cellpadding=0 width="100%" class="header-part1"><tr><td><div class="headerdisplayname" style="display:inline;">Subject: </div>[ruby-ffi] Re: Iterating a linked list</td></tr><tr><td><div class="headerdisplayname" style="display:inline;">From: </div>Wayne Meissner <wmeissner@gmail.com></td></tr><tr><td><div class="headerdisplayname" style="display:inline;">Date: </div>5/7/12 5:26 PM</td></tr></table><table border=0 cellspacing=0 cellpadding=0 width="100%" class="header-part2"><tr><td><div class="headerdisplayname" style="display:inline;">To: </div>ruby-ffi@googlegroups.com</td></tr></table><br>
<div class="moz-text-html"  lang="x-unicode">You've got it almost right - the problem is your mapping of the struct token string fields.<div><br></div><div>e.g.</div><div>&nbsp; char tag[TOKEN_TAG_MAX];<br></div><div><br></div><div>instead of</div><div>&nbsp; :tag, :string</div><div><br></div><div>it should be:</div><div><br></div><div>&nbsp; :tag, [ :char, TOKEN_TAG_MAX ]</div><div><br></div><div>Similar for pattern, value1, value2. &nbsp;Of course, you'll also need to define TOKEN_TAG_MAX and SYMBOL_MAX.<br><br>On Tuesday, May 8, 2012 3:55:35 AM UTC+10, Navaneeth KN wrote:<blockquote class="gmail_quote" style="margin: 0;margin-left: 0.8ex;border-left: 1px #ccc solid;padding-left: 1ex;">Hello,<br><br>I recently started using FFI and I have to say it is one of the best libraries I have ever used. Very neat syntax and performance. Thanks for such a great library. <br><br>Everything was working fine for me untill I got to iterate over a linked list. I am getting a segmentation fault when used from FFI. My C code works well and all tests are passing. My C function is like,<br><br>extern int<br>get_all_tokens(<br>&nbsp;&nbsp;&nbsp; object *handle,<br>&nbsp;&nbsp;&nbsp; int token_type,<br>&nbsp;&nbsp;&nbsp; struct token **tokens<br>);<br><br>This function points the head of the linked list to "tokens" variable. Here is my FFI code.<br><br>&nbsp; token_ptr = FFI::MemoryPointer.new :pointer<br>&nbsp; done = Library.get_all_tokens($<wbr>handle.get_pointer(0), 1, token_ptr);<br>&nbsp; if done != 0<br>&nbsp;&nbsp;&nbsp; error_message = Library.get_last_error($<wbr>handle.get_pointer(0))<br>&nbsp;&nbsp;&nbsp; error error_message<br>&nbsp;&nbsp;&nbsp; return<br>&nbsp; end<br><br>&nbsp; ptr = token_ptr.read_pointer<br>&nbsp; <br>&nbsp; until ptr.null?<br>&nbsp;&nbsp;&nbsp; item = Library::Token.new(ptr)<br>&nbsp;&nbsp;&nbsp; puts item[:pattern] ----&gt; Fails here<br>&nbsp;&nbsp;&nbsp; ptr = item[:next]<br>&nbsp; end<br><br>My C structure looks like,<br><br>struct token {<br>&nbsp;&nbsp;&nbsp; int type, match_type;<br>&nbsp;&nbsp;&nbsp; char tag[TOKEN_TAG_MAX];<br>&nbsp;&nbsp;&nbsp; char pattern[SYMBOL_MAX];<br>&nbsp;&nbsp;&nbsp; char value1[SYMBOL_MAX];<br>&nbsp;&nbsp;&nbsp; char value2[SYMBOL_MAX];<br>&nbsp;&nbsp;&nbsp; int children;<br>&nbsp;&nbsp;&nbsp; struct token* next;<br>};<br><br>And here is the FFI equivalent one,<br><br>&nbsp; class Token &lt; FFI::Struct<br>&nbsp;&nbsp;&nbsp; layout :type, :int,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; :match_type, :int,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; :tag, :string,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; :pattern, :string,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; :value1, :string,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; :value2, :string,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; :children, :int,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; :next,&nbsp; :pointer<br>&nbsp; end<br><br>When running this program, I am getting <br><br>[BUG] Segmentation fault<br>ruby 1.9.3p194 (2012-04-20 revision 35410) [x86_64-linux]<br><br>Any clue to resolve this issue would be helpful. <br><br>Thanks<br>Navaneeth<br><br></blockquote></div>
</div></body>
</html>
</table></div>