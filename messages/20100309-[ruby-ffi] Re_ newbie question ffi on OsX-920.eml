Delivered-To: headius@headius.com
Received: by 10.224.80.134 with SMTP id t6cs429386qak;
        Tue, 9 Mar 2010 06:56:56 -0800 (PST)
Received: by 10.101.186.30 with SMTP id n30mr1238057anp.180.1268146616171;
        Tue, 09 Mar 2010 06:56:56 -0800 (PST)
Return-Path: <3tWGWSxAJCPgozxyns.rfhhfwym3lrfnq.htrwzg3-kknlttlqjlwtzux.htr@groups.bounces.google.com>
Received: from mail-yx0-f160.google.com (mail-yx0-f160.google.com [209.85.210.160])
        by mx.google.com with ESMTP id 13si4114870yxe.79.2010.03.09.06.56.54;
        Tue, 09 Mar 2010 06:56:54 -0800 (PST)
Received-SPF: pass (google.com: domain of 3tWGWSxAJCPgozxyns.rfhhfwym3lrfnq.htrwzg3-kknlttlqjlwtzux.htr@groups.bounces.google.com designates 209.85.210.160 as permitted sender) client-ip=209.85.210.160;
Authentication-Results: mx.google.com; spf=pass (google.com: domain of 3tWGWSxAJCPgozxyns.rfhhfwym3lrfnq.htrwzg3-kknlttlqjlwtzux.htr@groups.bounces.google.com designates 209.85.210.160 as permitted sender) smtp.mail=3tWGWSxAJCPgozxyns.rfhhfwym3lrfnq.htrwzg3-kknlttlqjlwtzux.htr@groups.bounces.google.com; dkim=pass (test mode) header.i=@googlegroups.com
Received: by yxe32 with SMTP id 32sf3789555yxe.22
        for <headius@headius.com>; Tue, 09 Mar 2010 06:56:54 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=googlegroups.com; s=beta;
        h=domainkey-signature:received:x-beenthere:received:received:received
         :received:received-spf:received:mime-version:received:date
         :in-reply-to:x-ip:references:user-agent:x-http-useragent:message-id
         :subject:from:to:x-original-authentication-results:x-original-sender
         :reply-to:precedence:mailing-list:list-id:list-post:list-help
         :list-archive:x-thread-url:x-message-url:sender:list-subscribe
         :list-unsubscribe:content-type:content-transfer-encoding;
        bh=1GRIxugYZ3YvrBP9NGCw6WISTDKOBiNdGih784IWk4Y=;
        b=M84iY3shONmNbDWt6FZK3Thoe/Odfr38XRO8xFuRX2hBolPt35XX+GRyCCXNf7qzaJ
         P3BPw2qFpJwp/ZSaglwFKZwF8bk4H8M1XldM6zThbeqYE55diYYSAXqKhLfxdNrKBLLv
         GrWCnZrAwg9rWrwkOS6+/ioEDXk2yZRnFiNwI=
DomainKey-Signature: a=rsa-sha1; c=nofws;
        d=googlegroups.com; s=beta;
        h=x-beenthere:received-spf:mime-version:date:in-reply-to:x-ip
         :references:user-agent:x-http-useragent:message-id:subject:from:to
         :x-original-authentication-results:x-original-sender:reply-to
         :precedence:mailing-list:list-id:list-post:list-help:list-archive
         :x-thread-url:x-message-url:sender:list-subscribe:list-unsubscribe
         :content-type:content-transfer-encoding;
        b=v2NLjFsLwe0y6gIL8wX5WkLYShzDM7hbhUXOdaUQeHJ+V16x6oyUqLAGhRLI6O00hU
         1lsGu21DRaMZu8FsMiyxG9UmazR0qXXUrclYxuP2bVnsZXDaATew6FeEhvga/8b87y/m
         AMsOd18l+XJq50rzV8ykp5KvMoEsUFp8EJCBo=
Received: by 10.101.141.11 with SMTP id t11mr198707ann.25.1268146613427;
        Tue, 09 Mar 2010 06:56:53 -0800 (PST)
X-BeenThere: ruby-ffi@googlegroups.com
Received: by 10.101.212.29 with SMTP id o29ls153021anq.5.p; Tue, 09 Mar 2010 
	06:56:52 -0800 (PST)
Received: by 10.100.234.24 with SMTP id g24mr6263452anh.17.1268146612657;
        Tue, 09 Mar 2010 06:56:52 -0800 (PST)
Received: by 10.100.234.24 with SMTP id g24mr6263446anh.17.1268146612488;
        Tue, 09 Mar 2010 06:56:52 -0800 (PST)
Return-Path: <justin.maccarthy@gmail.com>
Received: from mail-gy0-f192.google.com (mail-gy0-f192.google.com [209.85.160.192])
        by gmr-mx.google.com with ESMTP id 11si699178gxk.9.2010.03.09.06.56.52;
        Tue, 09 Mar 2010 06:56:52 -0800 (PST)
Received-SPF: pass (google.com: domain of justin.maccarthy@gmail.com designates 209.85.160.192 as permitted sender) client-ip=209.85.160.192;
Received: by gyd12 with SMTP id 12so6555757gyd.29
        for <ruby-ffi@googlegroups.com>; Tue, 09 Mar 2010 06:56:52 -0800 (PST)
MIME-Version: 1.0
Received: by 10.151.87.2 with SMTP id p2mr9513ybl.21.1268146612228; Tue, 09 
	Mar 2010 06:56:52 -0800 (PST)
Date: Tue, 9 Mar 2010 06:56:52 -0800 (PST)
In-Reply-To: <59718a03-d170-44e8-9d45-44c00ce112a2@m35g2000prh.googlegroups.com>
X-IP: 125.26.217.144
References: <59718a03-d170-44e8-9d45-44c00ce112a2@m35g2000prh.googlegroups.com>
User-Agent: G2/1.0
X-HTTP-UserAgent: Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.6; en-US; 
	rv:1.9.2) Gecko/20100115 Firefox/3.6,gzip(gfe),gzip(gfe)
Message-ID: <7eee96c4-b2a0-458c-92e8-665972cc3d43@a10g2000pri.googlegroups.com>
Subject: [ruby-ffi] Re: newbie question ffi on OsX
From: macarthy <justin.maccarthy@gmail.com>
To: ruby-ffi <ruby-ffi@googlegroups.com>
X-Original-Authentication-Results: gmr-mx.google.com; spf=pass (google.com: 
	domain of justin.maccarthy@gmail.com designates 209.85.160.192 as permitted 
	sender) smtp.mail=justin.maccarthy@gmail.com
X-Original-Sender: justin.maccarthy@gmail.com
Reply-To: ruby-ffi@googlegroups.com
Precedence: list
Mailing-list: list ruby-ffi@googlegroups.com; contact ruby-ffi+owners@googlegroups.com
List-ID: <ruby-ffi.googlegroups.com>
List-Post: <http://groups.google.com/group/ruby-ffi/post?hl=en_US>, 
	<mailto:ruby-ffi@googlegroups.com>
List-Help: <http://groups.google.com/support/?hl=en_US>, <mailto:ruby-ffi+help@googlegroups.com>
List-Archive: <http://groups.google.com/group/ruby-ffi?hl=en_US>
X-Thread-Url: http://groups.google.com/group/ruby-ffi/t/f48bd31c2e7cbe
X-Message-Url: http://groups.google.com/group/ruby-ffi/msg/3329ebab79fe6359
Sender: ruby-ffi@googlegroups.com
List-Subscribe: <http://groups.google.com/group/ruby-ffi/subscribe?hl=en_US>, 
	<mailto:ruby-ffi+subscribe@googlegroups.com>
List-Unsubscribe: <http://groups.google.com/group/ruby-ffi/subscribe?hl=en_US>, 
	<mailto:ruby-ffi+unsubscribe@googlegroups.com>
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: quoted-printable

Answering my own question, since I can't recompile the lib as 64bit I
was able to run ruby as 32 bit and ffi works fine, Commands and output
below.

$ lipo -info /usr/local/lib/libmylib.dylib
Non-fat file: /usr/local/lib/libmylib.dylib is architecture: i386

$ lipo -detailed_info /usr/bin/ruby
Fat header in: /usr/bin/ruby
fat_magic 0xcafebabe
nfat_arch 3
architecture x86_64
    cputype CPU_TYPE_X86_64
    cpusubtype CPU_SUBTYPE_X86_64_ALL
    offset 4096
    size 14176
    align 2^12 (4096)
architecture i386
    cputype CPU_TYPE_I386
    cpusubtype CPU_SUBTYPE_I386_ALL
    offset 20480
    size 14112
    align 2^12 (4096)
architecture ppc7400
    cputype CPU_TYPE_POWERPC
    cpusubtype CPU_SUBTYPE_POWERPC_7400
    offset 36864
    size 13904
    align 2^12 (4096)


$ arch -arch i386 /usr/bin/ruby libmylib.rb


> Hi all,
>
> Can someone explain this error ? Obviously an architecture mismatch of
> some sort, how does one got about fixing this? Or compile libmylib as
> a different arch (or as several ? )
>
> /Library/Ruby/Gems/1.8/gems/ffi-0.6.2/lib/ffi/library.rb:61:in
> `ffi_lib': Could not open library 'libmylib.dylib':
> dlopen(libmylib.dylib, 9): no suitable image found. =A0Did find:
> (LoadError)
>
> /usr/local/lib/libmylib.dylib: mach-o, but wrong architecture. Could
> not open library 'libmylib': dlopen(libmylib, 9): image not found
> =A0 =A0 =A0 =A0 from /Library/Ruby/Gems/1.8/gems/ffi-0.6.2/lib/ffi/librar=
y.rb:
> 43:in `map'
> =A0 =A0 =A0 =A0 from /Library/Ruby/Gems/1.8/gems/ffi-0.6.2/lib/ffi/librar=
y.rb:
> 43:in `ffi_lib'
> =A0 =A0 =A0 =A0 from xxx.rb:14
>
> otool gives me this ...
>
> =A0otool -h /usr/local/lib/libmylib.dylib
>
> /usr/local/lib/libmylib.dylib:
> Mach header
> =A0 =A0 =A0 magic cputype cpusubtype =A0caps =A0 =A0filetype ncmds sizeof=
cmds
> flags
> =A00xfeedface =A0 =A0 =A0 7 =A0 =A0 =A0 =A0 =A03 =A00x00 =A0 =A0 =A0 =A0 =
=A06 =A0 =A020 =A0 =A0 =A0 2404
> 0x00118085
>
> Thanks
