<html>
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>[ruby-ffi] Re: mapping of unsigned char encoded_data[178][143] in a struct</title>
<link rel="important stylesheet" href="">
<style>div.headerdisplayname {font-weight:bold;}</style></head>
<body>
<table border=0 cellspacing=0 cellpadding=0 width="100%" class="header-part1"><tr><td><div class="headerdisplayname" style="display:inline;">Subject: </div>[ruby-ffi] Re: mapping of unsigned char encoded_data[178][143] in a struct</td></tr><tr><td><div class="headerdisplayname" style="display:inline;">From: </div>Wayne Meissner <wmeissner@gmail.com></td></tr><tr><td><div class="headerdisplayname" style="display:inline;">Date: </div>8/1/11 10:18 PM</td></tr></table><table border=0 cellspacing=0 cellpadding=0 width="100%" class="header-part2"><tr><td><div class="headerdisplayname" style="display:inline;">To: </div>ruby-ffi@googlegroups.com</td></tr></table><br>
<div class="moz-text-html"  lang="x-unicode">2D arrays in structs are not supported by FFI - there's an issue for it (issue #18), but its not exactly a high priority, since only 2 people have asked for it in the last 2 years.<div><br></div><div>You can work around it by declaring a struct type for the array width, then declaring an array of that struct type.</div><div>e.g.</div><div><br></div><div><div>#require 'rubygems'</div><div>require 'ffi'</div><div><br></div><div>class DataArray &lt; FFI::Struct</div><div>&nbsp; layout :array, [ :uchar, 178 ]</div><div><br></div><div>&nbsp; def [](idx)</div><div>&nbsp; &nbsp; if idx.is_a?(Integer)</div><div>&nbsp; &nbsp; &nbsp; self[:array][idx]</div><div>&nbsp; &nbsp; else</div><div>&nbsp; &nbsp; &nbsp; super(idx)</div><div>&nbsp; &nbsp; end</div><div>&nbsp; end</div><div><br></div><div>&nbsp; def []=(idx, val)</div><div>&nbsp; &nbsp; if idx.is_a?(Integer)</div><div>&nbsp; &nbsp; &nbsp; self[:array][idx] = val</div><div>&nbsp; &nbsp; else</div><div>&nbsp; &nbsp; &nbsp; super(idx, val)</div><div>&nbsp; &nbsp; end</div><div>&nbsp; end</div><div>end</div><div><br></div><div>class Array2D &lt; FFI::Struct</div><div>&nbsp; layout :encoded_data, [ DataArray, 143 ]</div><div>end</div><div><br></div><div>ary = Array2D.new</div><div>ary[:encoded_data][0][0] = 0x1</div><div>ary[:encoded_data][0][1] = 0x2</div><div>ary[:encoded_data][0][2] = 0x3</div><div>ary[:encoded_data][1][0] = 0x4</div><div>ary[:encoded_data][2][0] = 0x5</div><div>ary[:encoded_data][3][0] = 0x6</div><div><br></div><div><br></div><div>puts "ary[:encoded_data][0][0]=#{ary[:encoded_data][0][0]}"</div><div>puts "ary[:encoded_data][0][1]=#{ary[:encoded_data][0][1]}"&nbsp;</div><div>puts "ary[:encoded_data][1][0]=#{ary[:encoded_data][1][0]}"</div><div># idx=178 should correspond to ary[:encoded_data][1][0]</div><div>puts "ary.pointer.get_char(178)=#{ary.pointer.get_char(178)}"</div><div># idx=356 should correspond to ary[:encoded_data][2][0]</div><div>puts "ary.pointer.get_char(356)=#{ary.pointer.get_char(356)}"</div><div><br></div><div><br></div></div>
</div></body>
</html>
</table></div>