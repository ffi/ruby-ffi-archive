Delivered-To: headius@headius.com
Received: by 10.142.52.18 with SMTP id z18cs339584wfz;
        Tue, 1 Dec 2009 07:53:44 -0800 (PST)
Received: by 10.114.237.24 with SMTP id k24mr11308558wah.5.1259682824172;
        Tue, 01 Dec 2009 07:53:44 -0800 (PST)
Return-Path: <3BTwVSwoJCKEKPO.GPSVNTHNBJM.DPNSVCZ-GGJHPPHMFHSPVQT.DPN@listserv.bounces.google.com>
Received: from mail-pw0-f68.google.com (mail-pw0-f68.google.com [209.85.160.68])
        by mx.google.com with ESMTP id 24si290735pxi.31.2009.12.01.07.53.42;
        Tue, 01 Dec 2009 07:53:43 -0800 (PST)
Received-SPF: pass (google.com: domain of 3BTwVSwoJCKEKPO.GPSVNTHNBJM.DPNSVCZ-GGJHPPHMFHSPVQT.DPN@listserv.bounces.google.com designates 209.85.160.68 as permitted sender) client-ip=209.85.160.68;
Authentication-Results: mx.google.com; spf=pass (google.com: domain of 3BTwVSwoJCKEKPO.GPSVNTHNBJM.DPNSVCZ-GGJHPPHMFHSPVQT.DPN@listserv.bounces.google.com designates 209.85.160.68 as permitted sender) smtp.mail=3BTwVSwoJCKEKPO.GPSVNTHNBJM.DPNSVCZ-GGJHPPHMFHSPVQT.DPN@listserv.bounces.google.com; dkim=pass (test mode) header.i=@gmail.com
Received: by pwi8 with SMTP id 8sf154449pwi.27
        for <headius@headius.com>; Tue, 01 Dec 2009 07:53:42 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=gamma;
        h=domainkey-signature:received:x-beenthere:received:received:received
         :received:received-spf:received:received:received:date:from:to
         :subject:message-id:x-mailer:mime-version
         :x-original-authentication-results:reply-to:precedence:mailing-list
         :list-id:list-post:list-help:list-archive:x-thread-url:x-message-url
         :list-unsubscribe:list-subscribe:content-type
         :content-transfer-encoding;
        bh=SDhfQrt76ZiLDvRpbchdR+rxMgReD8WbGIyYx/fs2dg=;
        b=Pjk2JxDo6staR6Qc81Pd1+D+szlozpek8PwH4IrHx6YUPaM7myJvOyF76cXuNmR26M
         Q2QLwOv/aN2pT8q//dIpWrrSinwXQ3vyhOAvvfyvoT8zdsOQ9LI13/dsEeiwk27RvUDQ
         o+KOcL++X/q/3vlcMw9w3HBGV2IOsCtwJGLtc=
DomainKey-Signature: a=rsa-sha1; c=nofws;
        d=gmail.com; s=gamma;
        h=x-beenthere:received-spf:date:from:to:subject:message-id:x-mailer
         :mime-version:x-original-authentication-results:reply-to:precedence
         :mailing-list:list-id:list-post:list-help:list-archive:x-thread-url
         :x-message-url:list-unsubscribe:list-subscribe:content-type
         :content-transfer-encoding;
        b=SERJhf9v14jhriKJRhuH1jiOOQXmuK+S6TP++v85Hes4b7yDgEjqEa4s7Ee6lzcngC
         FaynSIoMsPRD/ne/Y32DpJpxJgiqdbFKv8ukN+mzo6M6Db4F1b2N+cy4tHunvNDItsoA
         UGZPT/HKTd1YgbGKj1e+UA08SDekO2TTUMy8M=
Received: by 10.115.100.26 with SMTP id c26mr349123wam.7.1259682821931;
        Tue, 01 Dec 2009 07:53:41 -0800 (PST)
X-BeenThere: ruby-ffi@googlegroups.com
Received: by 10.114.188.15 with SMTP id l15ls3445443waf.3.p; Tue, 01 Dec 2009 
	07:53:39 -0800 (PST)
Received: by 10.115.84.28 with SMTP id m28mr1230904wal.29.1259682819077;
        Tue, 01 Dec 2009 07:53:39 -0800 (PST)
Received: by 10.115.84.28 with SMTP id m28mr1230903wal.29.1259682819048;
        Tue, 01 Dec 2009 07:53:39 -0800 (PST)
Return-Path: <jon.forums@gmail.com>
Received: from mail-pw0-f45.google.com (mail-pw0-f45.google.com [209.85.160.45])
        by gmr-mx.google.com with ESMTP id 24si25371pzk.14.2009.12.01.07.53.38;
        Tue, 01 Dec 2009 07:53:38 -0800 (PST)
Received-SPF: pass (google.com: domain of jon.forums@gmail.com designates 209.85.160.45 as permitted sender) client-ip=209.85.160.45;
Received: by pwi15 with SMTP id 15so2700882pwi.4
        for <ruby-ffi@googlegroups.com>; Tue, 01 Dec 2009 07:53:38 -0800 (PST)
Received: by 10.114.214.28 with SMTP id m28mr11237540wag.44.1259682817830;
        Tue, 01 Dec 2009 07:53:37 -0800 (PST)
Return-Path: <jon.forums@gmail.com>
Received: from Red (rrcs-24-172-153-250.central.biz.rr.com [24.172.153.250])
        by mx.google.com with ESMTPS id 22sm339330pxi.2.2009.12.01.07.53.35
        (version=TLSv1/SSLv3 cipher=RC4-MD5);
        Tue, 01 Dec 2009 07:53:36 -0800 (PST)
Date: Tue, 1 Dec 2009 10:53:28 -0500
From: Jon <jon.forums@gmail.com>
To: ruby-ffi@googlegroups.com
Subject: [ruby-ffi] FFI wiki code review request
Message-Id: <20091201105328.224331a3.jon.forums@gmail.com>
X-Mailer: Sylpheed 2.7.1 (GTK+ 2.10.14; i686-pc-mingw32)
Mime-Version: 1.0
X-Original-Authentication-Results: gmr-mx.google.com; spf=pass (google.com: 
	domain of jon.forums@gmail.com designates 209.85.160.45 as permitted sender) 
	smtp.mail=jon.forums@gmail.com; dkim=pass (test mode) header.i=@gmail.com
Reply-To: ruby-ffi@googlegroups.com
Precedence: list
Mailing-list: list ruby-ffi@googlegroups.com; contact ruby-ffi+owners@googlegroups.com
List-ID: <ruby-ffi.googlegroups.com>
List-Post: <http://groups.google.com/group/ruby-ffi/post?hl=>, 
	<mailto:ruby-ffi@googlegroups.com>
List-Help: <http://groups.google.com/support/?hl=>, <mailto:ruby-ffi+help@googlegroups.com>
List-Archive: <http://groups.google.com/group/ruby-ffi?hl=>
X-Thread-Url: http://groups.google.com/group/ruby-ffi/t/306601e23e9744bd
X-Message-Url: http://groups.google.com/group/ruby-ffi/msg/c394f6d91557230d
List-Unsubscribe: <http://groups.google.com/group/ruby-ffi/subscribe?hl=>, 
	<mailto:ruby-ffi+unsubscribe@googlegroups.com>
List-Subscribe: <http://groups.google.com/group/ruby-ffi/subscribe?hl=>, 
	<mailto:ruby-ffi+subscribe@googlegroups.com>
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit

I've updated http://wiki.github.com/ffi/ffi/windows-examples and would like for you to review the Ruby/FFI part of the code examples for "idiomatic FFI correctness" whatever that phrase means.

Seriously, as these examples are meant to help jumpstart Windows users into becoming more comfortable and productive with FFI, I'd like to make sure they're high quality.  My FFI-fu is not yet that highly developed to ensure that the FFI examples are really what we want to show on the FFI project site.  If all appears to be on the right track, I plan to add more advanced examples.

Don't let the fact that the C examples use the Windows API cause you to shy away from reviewing the FFI code.  I've tried to strip all of the distracting parts away (e.g. - generic ANSI/Unicode support, strsafe.h, etc) and focus on core concepts applicable to any native API while showing typical Win API usage.

Thanks in advance for your time and feedback.

Jon


KEY QUESTIONS
=============

1) It appears all FFI objects created in Ruby code live in the heap.  Is this correct?  If yes, I've tried to highlight this in the C code by use of calloc/free.

2) There's no way to create FFI objects on the stack?

3) In the "Enumerate Top Level Windows" example, should I use an FFI::MemoryPointer or an FFI::Buffer with :buffer_out in the :get_window_text signature?  Both work in this specific example.  The underyling question really is, "When should I use an FFI::MemoryPointer and when should I use an FFI::Buffer?"

4) In the "Enumerate Top Level Windows" example, should I zero out the title buffer via "title.clear" similar to the C memset?

5) The FFI syntax for building up a nested struct is opposite from what you'd expect from a C PoV.  I now like the FFI syntax as shown in "Move the Mouse", but I'm wondering how best to explain it.

In the C part of the example, you basically create a Thing and a ThingContainer, configure the Thing, put the Thing in the ThingContainer, and then finally call the function with a pointer to the ThingContainer.

In FFI, it appears that once you create the ThingContainer, everything is already setup and you effectively do multiple levels of dereferencing to populate the Thing.  You don't create the Thing, populate it, and then stuff it in the ThingContainer.

Is this correct, or is it only correct for structs with nested structs/unions but not structs with nested pointers to structs/unions?  How best to explain this?
